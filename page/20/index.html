<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
































<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="撼地神牛">
<meta property="og:url" content="https://handishenniu.com/page/20/index.html">
<meta property="og:site_name" content="撼地神牛">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="撼地神牛">






  <link rel="canonical" href="https://handishenniu.com/page/20/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>撼地神牛</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?304ebec1c594afeac3282f7afb1f3448";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <meta name="baidu-site-verification" content="qInMpCXDbF">
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
    
    
    
    <a href="https://github.com/lystdio" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">撼地神牛</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

    <a href="https://github.com/lystdio" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/03/03/2014-03-03-cb-javascript-array/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/03/03/2014-03-03-cb-javascript-array/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">你所不知道的JavaScript数组</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-03-03 01:56:00" itemprop="dateCreated datePublished" datetime="2014-03-03T01:56:00+08:00">2014-03-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/03/03/javascript-array.html" target="_blank">博客园</a>.</div>

<p>相信每一个 javascript 学习者，都会去了解 JS 的各种基本数据类型，数组就是数据的组合，这是一个很基本也十分简单的概念，他的内容没多少，学好它也不是件难事情。但是本文着重要介绍的并不是我们往常看到的 Array，而是 ArrayBuffer。</p><br><p>我写的很多东西都是因为要完成某些特定的功能而刻意总结的，可以算是备忘，本文也是如此！前段时间一直在研究 Web Audio API 以及语音通信相关的知识，内容侧重于音频流在 AudioContext 各个节点之间的流动情况，而现在要摸清楚音频到流底是个什么样的数据格式，所以对 ArrayBuffer 的研究就显得格外重要了。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/javascript-array.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/javascript-array.html</a>，转载请注明源地址。</p><br><h3>一、Array 在内存中的堆栈模型</h3><br><h4>1. Array 的获取</h4><br><p>Javascript 中如何产生 Array：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[element0, element1, ..., elementN]</span><br><span class="line">new Array(element0, element1, ..., elementN)</span><br><span class="line">new Array(arrayLength)</span><br></pre></td></tr></table></figure>
<p>直接定义，或者通过构造函数创建一个 Array，当然也可以使用其他的手段：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;array&quot;.split(&quot;&quot;);</span><br><span class="line">&quot;array&quot;.match(/a|r/g);</span><br></pre></td></tr></table></figure>
<p>等等，方式有很多。但是 Array 内部是个什么样的结构，恐怕很多人还不是很清楚。</p><br><h4>2. 堆栈模型</h4><br><p>在数组中我们可以放很多不同数据类型的数据，如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var arr = [21, &quot;李靖&quot;, new Date(), function()&#123;&#125;, , null];</span><br></pre></td></tr></table></figure>
<p>上面这个数组中一次放入了 数字、字符串、对象、函数、undefined 和 null，对于上面的数据接口我们可以具象的描述下：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    栈</span><br><span class="line">+---------+                  堆</span><br><span class="line">|   21    |         +-------------------+</span><br><span class="line">+---------+         |                   |</span><br><span class="line">|  &quot;李靖&quot; |         |                   |</span><br><span class="line">+---------+         |  +--------+       |</span><br><span class="line">| [refer] |-----------&gt;| Object |       |</span><br><span class="line">+---------+         |  +--------+       |</span><br><span class="line">| [refer] |-----------------&gt;+--------+ |</span><br><span class="line">+---------+         |        |function| |</span><br><span class="line">|undefined|         |        +--------+ |</span><br><span class="line">+---------+         |                   |</span><br><span class="line">|   null  |         +-------------------+</span><br><span class="line">+---------+         Created By Barret Lee</span><br></pre></td></tr></table></figure>
<p>JavaScript 的数据类型分为两种，一种是值类型，一种是引用类型，常见的引用类型有 Object 和 Array，数组的储存模型中，如果是诸如 Number、String 之类的值类型数据会被直接压入栈中，而引用类型只会压入对该值的一个索引，用 C 语言的概念来解释就是只保存了数据的指针，这些数据是储存在堆中的某块区间中。栈堆并不是独立的，栈也可以在堆中存放。</p><br><p>好了，对 Array 的说明就到这里，下面具体说说 ArrayBuffer 的相关知识。</p><br><h3>二、ArrayBuffer</h3><br><p>web 是个啥玩意儿，web 要讨论的最基本问题是什么？我觉得有两点，一个是数据，一个是数据传输，至于数据的展示，纷繁复杂，这个应该是 web 上层的东西。而本文要讨论的 ArrayBuffer 就是最基础的数据类型，甚至不能称之为数据类型，它是一个数据容器，需要通过其他方式来读写。</p><br><p>官方点的定义：</p><br><blockquote><br><p>The ArrayBuffer is a data type that is used to represent a generic, fixed-length binary data buffer. You can’t directly manipulate the contents of an ArrayBuffer; instead, you create an ArrayBufferView object which represents the buffer in a specific format, and use that to read and write the contents of the buffer.</p><br><p><strong>表示二进制数据的原始缓冲区，该缓冲区用于存储各种类型化数组的数据。 无法直接读取或写入 ArrayBuffer，但可根据需要将其传递到类型化数组或 DataView 对象 来解释原始缓冲区。</strong></p><br></blockquote><br><p>他是一个二进制数据的原始缓冲区，虽然 JavaScript 是弱类型语言，但是他本身是对数据的类型和大小都有限制的，我们需要通过某种数据结构将缓冲区的内容有序的读取出来（写进去）。</p><br><h4>1. 原始缓冲区的创建</h4><br><p>通过 ArrayBuffer 这个构造函数可以创建一个原始缓冲区：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var buffer  = new ArrayBuffer(30);</span><br></pre></td></tr></table></figure>
<p>从 chrome 控制台可以看到：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/03/03/031349161314084.jpg" data-source="http://images.cnitblog.com/i/387325/201403/031349161314084.jpg" alt=""></p><br><p>buffer 实例拥有一个 byteLength 的属性，用于获取 buffer 的 size，一个只有 IE11+ 以及 ios6+ 支持的 slice 方法，用于对 buffer 长度进行截取操作。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ArrayBuffer slice(</span><br><span class="line">    unsigned long begin</span><br><span class="line">    unsigned long end Optional</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>可以测试这个 DEMO：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var buffer = new ArrayBuffer(12);</span><br><span class="line">var x = new Int32Array(buffer);</span><br><span class="line">x[1] = 1234;</span><br><span class="line">var slice = buffer.slice(4);</span><br><span class="line">var y = new Int32Array(slice);</span><br><span class="line">console.log(x[1]);</span><br><span class="line">console.log(y[0]);</span><br><span class="line">x[1] = 6789;</span><br><span class="line">console.log(x[1]);</span><br><span class="line">console.log(y[0]);</span><br></pre></td></tr></table></figure>
<p></p><h4>2. 类型化数组</h4><p></p>
<p>类型化数组类型表示可编制索引和操纵的 ArrayBuffer 对象 的各种视图。 所有数组类型的长度均固定。</p><br><table><br><thead><br><tr><th>名称</th><th>大小（以字节为单位）</th><th>描述</th></tr><br></thead><br><tbody><br><tr><br><td>Int8Array</td><br><td>1</td><br><td>8 位二补码有符号整数</td><br></tr><br><tr><br><td>Uint8Array</td><br><td>1</td><br><td>8 位无符号整数</td><br></tr><br><tr><br><td>Int16Array</td><br><td>2</td><br><td>16 位二补码有符号整数</td><br></tr><br><tr><br><td>Uint16Array</td><br><td>2</td><br><td>16 位无符号整数</td><br></tr><br><tr><br><td>Int32Array</td><br><td>4</td><br><td>32 位二补码有符号整数</td><br></tr><br><tr><br><td>Uint32Array</td><br><td>4</td><br><td>32 位无符号整数</td><br></tr><br><tr><br><td>Float32Array</td><br><td>4</td><br><td>32 位 IEEE 浮点数</td><br></tr><br><tr><br><td>Float64Array</td><br><td>8</td><br><td>64 位 IEEE 浮点数</td><br></tr><br></tbody><br></table><br><p>Int 就是整型，Uint 为无符号整形，Float 为浮点型，这些是 C 语言中的基本概念，我就不具体解释了。由于这些视图化结构都是大同小异，本文只对 Float32Array 类型作说明，读者可以举一反三。</p><br><p>Float32Array 跟 Array 是十分类似的，只不过他每一个元素都是都是一个 32位（4字节） 的浮点型数据。Float32Array 一旦创建其大小不能再修改。</p><br><p>我们可以直接创建一个 Float32Array:</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var x = new Float32Array(2);</span><br><span class="line">x[0] = 17;</span><br><span class="line">console.log(x[0]); // 17</span><br><span class="line">console.log(x[1]); // 0</span><br><span class="line">console.log(x.length); // 2</span><br></pre></td></tr></table></figure>
<p>需要有这么一个概念，他依然是一个数组，只不过该数组中的每个元素都是 Float 32 位的数据类型，再如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var x = new Float32Array([17, -45.3]);</span><br><span class="line">console.log(x[0]);  // 17</span><br><span class="line">console.log(x[1]);  // -45.29999923706055</span><br><span class="line">console.log(x.length); // 2</span><br></pre></td></tr></table></figure>
<p>我们把一个数组的值直接赋给了 x 这个 Float32Array 对象，那么在储存之前会将它转换成一个 32位浮点数。</p><br><p>由于该类数组的每个元素都是同一类型，所以在堆栈模型中，他们全部会被压入到栈之中，因此类型化数组都是值类型，他并不是引用类型！这个要引起注意，从下面的例子中也可以反映出来：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var x = new Float32Array([17, -45.3]);</span><br><span class="line">var y = new Float32Array(x);</span><br><span class="line">console.log(x[0]); // 17</span><br><span class="line">console.log(x[1]); //-45.29999923706055</span><br><span class="line">console.log(x.length); // 2</span><br><span class="line">x[0] = -2;</span><br><span class="line">console.log(y[0]); // 17, y的值没变</span><br></pre></td></tr></table></figure>
<p>将 x 的值复制给 y，修改 x[0], y[0] 并没有变化。</p><br><p>除了上面的方式，我们还可以通过其他方式来创建一个类型化数组：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var buffer = new ArrayBuffer(12);</span><br><span class="line">var x = new Float32Array(buffer, 0, 2);</span><br><span class="line">var y = new Float32Array(buffer, 4, 1);</span><br><span class="line">x[1] = 7;</span><br><span class="line">console.log(y[0]); // 7</span><br></pre></td></tr></table></figure>
<p>解释下这里为什么返回 7.</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       ArrayBuffer（12）</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|0|1|2|3|4|5|6|7|8| | | | |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">\              /</span><br><span class="line">  x (Float32Array)</span><br><span class="line">  offset：0</span><br><span class="line">  byteLength：4</span><br><span class="line">  length:2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">       ArrayBuffer（12）</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|0|1|2|3|4|5|6|7|8| | | | |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        \       /</span><br><span class="line">             y</span><br><span class="line"></span><br><span class="line">      Created By Barret Lee</span><br></pre></td></tr></table></figure>
<p>看了上面的图解还有疑问么？我觉得我不用继续解释了。可以把 ArrayBuffer 的单位看成 1，而 Float32Array 的单位是 4.</p><br><h4>3. DataView对象</h4><br><p>DataView 对象对数据的操作更加细致，不过我觉得没啥意思，上面提到的各种类型化数组已经可以基本满足应用了，所以这里就一笔带过，一个简单的示例：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var buffer = new ArrayBuffer(12);</span><br><span class="line">var x = new DataView(buffer, 0);</span><br><span class="line">x.setInt8(0, 22);</span><br><span class="line">x.setFloat32(1, Math.PI);</span><br><span class="line">console.log(x.getInt8(0)); // 22</span><br><span class="line">console.log(x.getFloat32(1)); // 3.1415927410125732</span><br></pre></td></tr></table></figure>
<p>如果感兴趣，可以移步<a href="http://www.javascripture.com/DataView" target="_blank">http://www.javascripture.com/DataView</a>，作详细了解。</p><br><h3>三、XHR2 中的 ArrayBuffer</h3><br><p>ArrayBuffer 的应用特别广泛，无论是 WebSocket、WebAudio 还是 Ajax等等，前端方面只要是处理大数据或者想提高数据处理性能，那一定是少不了 ArrayBuffer 。</p><br><p>XHR2 并不是什么新东西，可能你用到了相关的特性，却不知这就是 XHR2 的内容。最主要的一个东西就是 <code>xhr.responseType</code>，他的作用是设置响应的数据格式，可选参数有：”text”、”arraybuffer”、”blob”或”document”。请注意，设置（或忽略）xhr.responseType = ‘’ 会默认将响应设为”text”。这里存在一个这样的对应关系：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求            响应</span><br><span class="line">text            DOMString</span><br><span class="line">arraybuffer     ArrayBuffer</span><br><span class="line">blob            Blob</span><br><span class="line">document        Document</span><br></pre></td></tr></table></figure>
<p>举个栗子：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open(&apos;GET&apos;, &apos;/path/to/image.png&apos;, true);</span><br><span class="line">xhr.responseType = &apos;arraybuffer&apos;;</span><br><span class="line"></span><br><span class="line">xhr.onload = function(e) &#123;</span><br><span class="line">    // this.response == uInt8Array.buffer</span><br><span class="line">    var uInt8Array = new Uint8Array(this.response);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>
<p></p><p>我们在 xhr.responseType 中设置了属性为 arraybuffer，那么在拿到的数据中就可以用类型化数组来接受啦！</p><p></p>
<p></p><h3>四、小结</h3><p></p>
<p></p><p>本文主要介绍了 Array 在堆栈模型中的存放方式，也详细描述了 ArrayBuffer 这个原始缓冲区的二进制数据类型，在 web 开发中，数据以及数据的储存是一个重要的部分，希望引起注意！</p><p></p>
<p></p><p>本文叙述上可能存在错误，请多多斧正！</p><p></p>
<p></p><h3>五、参考资料</h3><p></p>
<ul><br><li><a href="http://www.javascripture.com/ArrayBuffer" target="_blank">http://www.javascripture.com/ArrayBuffer</a></li><br><li><a href="//developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">//developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array</a> MDN Array</li><br><li><a href="http://www.html5rocks.com/zh/tutorials/file/xhr2/" target="_blank">http://www.html5rocks.com/zh/tutorials/file/xhr2/</a> html5rocks</li><br><li><a href="http://technet.microsoft.com/zh-cn/ie/br212485" target="_blank">http://technet.microsoft.com/zh-cn/ie/br212485</a> MSDN</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/03/01/2014-03-01-cb-javascript-fullscreen/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/03/01/2014-03-01-cb-javascript-fullscreen/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">让你的页面瞬间全屏</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-03-01 03:11:00" itemprop="dateCreated datePublished" datetime="2014-03-01T03:11:00+08:00">2014-03-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/03/01/javascript-fullscreen.html" target="_blank">博客园</a>.</div>

<p><span>@update 文章下方有更新，提到了更多全屏的知识以及错误的矫正。</span></p><br><p><span>页面全屏是一个体验非常棒的功能，他可以让你的视觉焦点聚集在你想关注的元素块上。很多浏览器都支持全屏，按下 F11，哦了！ 页面全屏了~&nbsp;但是本文要说的并不是这种全屏。当页面中有个小 DEMO 或者小游戏要展示的时候，用户期望，这个 DEMO 或者游戏可以在全屏下展示，本文就教你如何来展示。</span></p><br><p>如果你是非 IE 浏览器进入的该页面，你可能已经看到了页面上发生了一点小变化，多个东西：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/03/01/010309260367360.png" data-source="http://images.cnitblog.com/i/387325/201403/010309260367360.png" alt=""></p><br><p>没错，多了个\进入全屏”的按钮，这就是本文要介绍的内容！</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/javascript-fullscreen.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/javascript-fullscreen.html</a>，转载请注明源地址。</p><br><h3>一、全屏策略</h3><br><h4>1. 原理</h4><br><p>一些浏览器提供了元素全屏的接口，这些接口的调用特别简单：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 进入全屏</span><br><span class="line">element.requestFullScreen();</span><br><span class="line">// 退出全屏</span><br><span class="line">document.exitFullscreen();</span><br></pre></td></tr></table></figure>
<p>这是 w3c 规范统一的接口，但是浏览器总是那么调皮，内部实现的时候会加上自己厂商的前缀，如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 小狐</span><br><span class="line">element.mozRequestFullScreen();</span><br><span class="line">// Chrome</span><br><span class="line">document.webkitCancelFullScreen();</span><br></pre></td></tr></table></figure>
<p>这里有两点需要引起注意，W3C 中的退出全屏是 <code>exitFullscreen</code>，而小狐跟 Chrome 使用的是 <code>cancelFullScreen</code>，这里在作判断的时候不要弄错了；再一点就是当我们退出全屏的时候，并不是使用 element 作为退出的对象了，而是使用 document。</p><br><h4>2. 兼容处理</h4><br><p>原理是很简单，但是针对浏览器的兼容性写起来还是挺麻烦的，幸好 Chrome 换用 blink内核 之后没有继续加上一个 <code>-blink-</code>，否则开发者心里会有无数个草泥马奔腾的！</p><br><p>对于进入全屏：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function launchFullScreen(element) &#123;</span><br><span class="line">   if (element.requestFullscreen) &#123;</span><br><span class="line">      element.requestFullscreen();</span><br><span class="line">    &#125; else if (element.msRequestFullscreen) &#123;</span><br><span class="line">      element.msRequestFullscreen();</span><br><span class="line">    &#125; else if (element.mozRequestFullScreen) &#123;</span><br><span class="line">      element.mozRequestFullScreen();</span><br><span class="line">    &#125; else if (element.webkitRequestFullscreen) &#123;</span><br><span class="line">      element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于退出全屏：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function cancelFullScreen() &#123;</span><br><span class="line">   if (document.exitFullscreen) &#123;</span><br><span class="line">      document.exitFullscreen();</span><br><span class="line">    &#125; else if (document.msExitFullscreen) &#123;</span><br><span class="line">      document.msExitFullscreen();</span><br><span class="line">    &#125; else if (document.mozCancelFullScreen) &#123;</span><br><span class="line">      document.mozCancelFullScreen();</span><br><span class="line">    &#125; else if (document.webkitExitFullscreen) &#123;</span><br><span class="line">      document.webkitExitFullscreen();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></p><h4>3. 浏览器兼容性</h4><p></p>
<p><span>IE 用户就甭看了，刚测试，IE11 不兼容</span>（需要加前缀 ms）。对于浏览器的兼容情况，请戳<a href="//developer.mozilla.org/en/DOM/Using_full-screen_mode#AutoCompatibilityTable" target="_blank">这里</a>。目前 Firefox 兼容，不过有点离谱。他会弹出一个让你全屏的提示，此时确实是全屏的，但当你点击提示中的\允许”时，屏幕又退出了全屏，真是让人匪夷所思。我测试的版本（27.0.1）有这个问题，当然，这是浏览器本身的问题，不用纠结。</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/03/01/010319363967428.png" data-source="http://images.cnitblog.com/i/387325/201403/010319363967428.png" alt="" width="553" height="195"></p><br><p>Chrome 对于新特性的支持永远是站在前排，不得不佩服 google 开发工程师的牛掰！</p><br><h3>二、3 个 bug</h3><br><h4>1. window 失去焦点</h4><br><p>当全屏一个元素块的时候，原始状态该元素块可能没有 padding 或者 margin 值，为了让他显示的稍微养眼一些，我们可能会给他主动加上 padding 值，然后在退出全屏的时候在拿到设置的值。但此时，一个 bug 出现鸟，当我们点击全屏页面中的 a 标签，或者触发了某个 <code>window.open</code> 之后，浏览器会失去焦点，跳到新开的页面中，而全屏的页面会退出全屏，搞笑的是我们开始设置的 padding 值他不给我们去掉，这个是令人十分神伤的，<span>不过没关系，有 bug 咱们就打补丁！</span></p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">window.onblur = function()&#123;</span><br><span class="line">    cancelFullsreen();</span><br><span class="line">    changeThePadding();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>有人会想到，我们在点击 a 链接的时候先 changeThePadding()，再让 a 标签跳走，这种方式是不合理的，因为除了 a 链接会让页面失去焦点之外还有其他的可能（如 window.open）。</p><br><p><span>@update</span> 因为 bug 3 的存在，这里不能这样改，需要利用浏览器的全屏探测：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(document).on(&apos;webkitfullscreenchange mozfullscreenchange msfullscreenchange fullscreenchange&apos;, function()&#123;</span><br><span class="line">    if (!document.fullscreenElement &amp;&amp;    // alternative standard method</span><br><span class="line">    !document.mozFullScreenElement &amp;&amp;</span><br><span class="line">    !document.webkitFullscreenElement &amp;&amp;</span><br><span class="line">    !document.msFullscreenElement ) &#123;</span><br><span class="line">        // 在这里处理 bug        changeThePadding();</span><br><span class="line">&#125; &#125;);</span><br></pre></td></tr></table></figure>
<p></p><h4>2. 一个貌似可以重现的 bug</h4><p></p>
<p>所谓的可以重现就是，把代码逻辑抽离出来，写个 demo 还能看到 bug。反正我试过好几次，这个 bug 都出现了，懒得写一个 DEMO 重现他。他出现的位置是：我的滚动条是自己设置的样式，当全屏之后，滚动条本应该在页面的最右侧，但是我测试的时候他偶尔会离最右侧有十几个像素，我也不知道为什么。但是当我打开 DevTools 的时候，这十几个像素又奇妙的被缝合了~</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/03/01/010322023845093.png" data-source="http://images.cnitblog.com/i/387325/201403/010322023845093.png" alt=""></p><br><p>后来一想，管你呢，这肯定是 google 的工程师没有留意到的位置！既然开打 DevTools 可以修复，那就说明触发 window.resize 也能解决这个问题，好吧，那就这样试试吧：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">newCancelFullscreen = function()&#123;</span><br><span class="line">    cancelFullscreen();</span><br><span class="line">    window.onresize();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>果然有效，bug 搞定！</p><br><h4>3. 全屏之后，部分浏览器会在该页面失去焦点</h4><br><p>这就相当于，全屏之后，触发了 window.blur();</p><br><h3>三、小结</h3><br><p>除了上面提到的两个 bug，还有一个值得注意的是，如果你全屏的那个元素块很高但却没有设置</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">element &#123; overflow:auto; &#125;</span><br></pre></td></tr></table></figure>
<p>之类的东西，你会发现滚烂你的鼠标也滚不出那块区域。</p><br><p>本文介绍了如何使用 javascript 将页面中的某个元素调至全屏，并指出了再使用过程中的两个 bug，希望引起注意！</p><br><h3>四、参考资料</h3><br><ul><br><li><a href="http://baidufe.com/" target="_blank">http://baidufe.com/</a> Alien的笔记</li><br></ul><br><br><br><h4><span>@update 2014/03/01 12:00</span></h4><br><p>1. Trident 内核的 IE 浏览器是支持的，可以用&nbsp;element.msRequestFullscreen()，退出用&nbsp;<span>msExitFullscreen()</span></p><br><p>2. 对于全屏的元素可以使用伪元素给他加样式：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">:-webkit-full-screen #myvideo &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 100%;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3. 浏览器提供的两个方便开发的东西：</p><br><p><a href="//developer.mozilla.org/en-US/docs/Web/API/document.mozFullScreenElement" target="_blank">fullscreenElement</a>：如果这个属性为空，则浏览器处于非全屏状态，否则就是处于全屏。</p><br><p><a href="//developer.mozilla.org/en-US/docs/Web/API/document.mozFullScreenEnabled" target="_blank">fullscreenEnabled</a>：这个属性告诉你浏览器 document 是否可以全屏。</p><br><p>4. 也可以使用 keydown 来控制全屏，如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">document.addEventListener(&quot;keydown&quot;, function(e) &#123;</span><br><span class="line">  if (e.keyCode == 13) &#123;</span><br><span class="line">    toggleFullScreen();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, false);</span><br></pre></td></tr></table></figure>
<p>对于 toggleFullScreen 函数：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function toggleFullScreen() &#123;</span><br><span class="line">  if (!document.fullscreenElement &amp;&amp;    // alternative standard method</span><br><span class="line">      !document.mozFullScreenElement &amp;&amp; !document.webkitFullscreenElement &amp;&amp; !document.msFullscreenElement ) &#123;  // current working methods</span><br><span class="line">    if (document.documentElement.requestFullscreen) &#123;</span><br><span class="line">      document.documentElement.requestFullscreen();</span><br><span class="line">    &#125; else if (document.documentElement.msRequestFullscreen) &#123;</span><br><span class="line">      document.documentElement.msRequestFullscreen();</span><br><span class="line">    &#125; else if (document.documentElement.mozRequestFullScreen) &#123;</span><br><span class="line">      document.documentElement.mozRequestFullScreen();</span><br><span class="line">    &#125; else if (document.documentElement.webkitRequestFullscreen) &#123;</span><br><span class="line">      document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    if (document.exitFullscreen) &#123;</span><br><span class="line">      document.exitFullscreen();</span><br><span class="line">    &#125; else if (document.msExitFullscreen) &#123;</span><br><span class="line">      document.msExitFullscreen();</span><br><span class="line">    &#125; else if (document.mozCancelFullScreen) &#123;</span><br><span class="line">      document.mozCancelFullScreen();</span><br><span class="line">    &#125; else if (document.webkitExitFullscreen) &#123;</span><br><span class="line">      document.webkitExitFullscreen();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Toggle FullScreen</span><br></pre></td></tr></table></figure>
<p>5. 全屏事件</p><br><p>看到这句代码你可能就懂了：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(document).on(&apos;webkitfullscreenchange mozfullscreenchange fullscreenchange&apos;,fn);</span><br></pre></td></tr></table></figure>
<p>当全屏状态改变时会触发上面的 fullscreenchange 事件，所以 <a href="#2885642"><span><span>#15</span> p2227</span></a> 给我提出的问题就可以得到解决了。</p>


<p><span>文章可能还存在错误的地方，还请多多斧正！</span></p>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/02/28/2014-02-28-cb-webAudio-filter/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/02/28/2014-02-28-cb-webAudio-filter/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">声音的滤波</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-28 01:57:00" itemprop="dateCreated datePublished" datetime="2014-02-28T01:57:00+08:00">2014-02-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/28/webAudio-filter.html" target="_blank">博客园</a>.</div>

<p>本系列文章主要是介绍 Web Audio API 的相关知识，以及 web语音通信 中会遇到的一些问题，阐述可能存在错误，还请多多斧正！</p><br><p>通过设备获取音频流会不可避免的渗入一些杂音，这些杂音可能来自你周边的环境，也有可能来自录音设备本身，一些低频的声音还好，人耳难以分辨出来，但是那些高频的白噪声对音质的影响是特别大的，如我们听收音机没有调到正确的频率上，会听到吱吱兹兹的刺耳的杂音。这些杂音不仅增大了音频流信号本身的体积，而且我们的耳朵也不喜欢，所以在传输之前必须对音频做相应的滤波处理。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-filter.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/webAudio-filter.html</a>，转载请注明源地址。</p><br><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><br><h3>一、滤波节点</h3><br><h4>1. 接口介绍</h4><br><p>频率，是单位时间内完成振动的次数，是描述振动物体往复运动频繁程度的量。一段音频流中包含了各种频率，温和的音乐频率在一个范围之内，超过这个范围的声音一般就是噪声，人和人之间的语音交流，声音也是在一定的频段之中。</p><br><p>在 AudioContext 中用于滤波的节点叫做 BiquadFilterNode，Biquad 是双二阶的意思，这里涉及到了很多通信中专业词汇，我们暂时可以不用在意。BiquadFilterType 包含了各种滤波类型：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">enum BiquadFilterType &#123;</span><br><span class="line">    &quot;lowpass&quot;,</span><br><span class="line">    &quot;highpass&quot;,</span><br><span class="line">    &quot;bandpass&quot;,</span><br><span class="line">    &quot;lowshelf&quot;,</span><br><span class="line">    &quot;highshelf&quot;,</span><br><span class="line">    &quot;peaking&quot;,</span><br><span class="line">    &quot;notch&quot;,</span><br><span class="line">    &quot;allpass&quot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>用的比较多的就是 lowpass（低通滤波），highpass（高通滤波），bandpass（带通滤波）。低通滤波就是过滤某个临界点的高频信号，只让低频信号通过，高通滤波反之。带通滤波就是允许某个频段的信号通过。这个节点的参数比较多：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">attribute BiquadFilterType type;</span><br><span class="line">readonly attribute AudioParam frequency; // in Hertz</span><br><span class="line">readonly attribute AudioParam detune; // in Cents</span><br><span class="line">readonly attribute AudioParam Q; // Quality factor</span><br><span class="line">readonly attribute AudioParam gain; // in Decibels</span><br><span class="line"></span><br><span class="line">void getFrequencyResponse(Float32Array frequencyHz,</span><br><span class="line">                          Float32Array magResponse,</span><br><span class="line">                          Float32Array phaseResponse);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中几个参数的取值范围是：</p><br><blockquote><br><p><strong>Q</strong> 默认是 1, 取值从 0.0001 到 1000.</p><br><p><strong>gain</strong> 默认是 0, 取值从 -40 到 40.</p><br></blockquote><br><h4>2. 初始化接口</h4><br><p>我们可以在初始化的时候将 BiquadFilterType 送进去：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 初始化为低通滤波</span><br><span class="line">var filter = context.createBiquadFilter(&quot;lowpass&quot;);</span><br></pre></td></tr></table></figure>
<p>当然，我们也可以通过设置他的 AudioParam 来控制参数：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var filter = context.createBiquadFilter();</span><br><span class="line">// 设置为低通滤波</span><br><span class="line">filter.type = filter.LOWPASS;</span><br><span class="line">// 只允许频率小于 800Hz 的音频信号通过</span><br><span class="line">filter.frequency.value = 800;</span><br></pre></td></tr></table></figure>
<p>两只方式都是一样的，都好控制。</p><br><h4>3. DEMO 测试</h4><br><p>简单点的话，中间只用一个 filter 节点就可以了，使用低通滤波，将频率设置为 800Hz，可以听到声音很闷，声音不是变小了，而是变闷了~节点之间的连接方式是：</p><br><blockquote><br><p>Source -&gt; Filter -&gt; Destination</p><br></blockquote><br><p>代码：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">var context = new AudioContext;</span><br><span class="line">//创建节点</span><br><span class="line">var audio = new Audio(&quot;http://qianduannotes.duapp.com/file/SuperMario.mp3&quot;);</span><br><span class="line">audio.loop = true;</span><br><span class="line">var media = context.createMediaElementSource(audio);</span><br><span class="line">var filter = context.createBiquadFilter();</span><br><span class="line">filter.type=filter.LOWPASS;</span><br><span class="line">filter.frequency.value=800;</span><br><span class="line">//连接：media → filter → destination</span><br><span class="line">media.connect(filter);</span><br><span class="line">filter.connect(context.destination);audio.play();</span><br></pre></td></tr></table></figure>
<p>为了方面查看改变频率之后波形的变化，我做了一些处理：</p><br><blockquote><br><p>Source -&gt; Filter -&gt; Analyser -&gt; Destination</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +—–&gt; 波形绘制到 Canvas</p><br></blockquote><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;canvas id=&quot;canvas&quot; width=&quot;400&quot; height=&quot;300&quot;&gt;&lt;/canvas&gt;&lt;br&gt;</span><br><span class="line">&lt;input type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; id=&quot;volume&quot;&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;audio.play()&quot; value=&quot;播放&quot;&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;audio.pause()&quot; value=&quot;暂停&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">var AudioContext=AudioContext||webkitAudioContext;</span><br><span class="line">var context=new AudioContext;</span><br><span class="line">//创建节点</span><br><span class="line">var audio = new Audio(&quot;http://qianduannotes.duapp.com/file/SuperMario.mp3&quot;);</span><br><span class="line">audio.loop = true;</span><br><span class="line">var media=context.createMediaElementSource(audio);</span><br><span class="line">var filter=context.createBiquadFilter();</span><br><span class="line">var analyser=context.createAnalyser();</span><br><span class="line">//只允许小于800的频率通过</span><br><span class="line">filter.type=filter.LOWPASS;</span><br><span class="line">filter.frequency.value=800;</span><br><span class="line">//Canvas初始化</span><br><span class="line">var width=canvas.width,height=canvas.height;</span><br><span class="line">var g=canvas.getContext(&quot;2d&quot;);</span><br><span class="line">g.translate(0.5,height/2+0.5);</span><br><span class="line">//连接：media → filter → analyser → destination</span><br><span class="line">media.connect(filter);</span><br><span class="line">filter.connect(analyser);</span><br><span class="line">analyser.connect(context.destination);</span><br><span class="line">//以fftSize为长度创建一个字节数组作为数据缓冲区</span><br><span class="line">var output=new Uint8Array(analyser.fftSize);</span><br><span class="line">//播放帧</span><br><span class="line">(function callee(e)&#123;</span><br><span class="line">  analyser.getByteTimeDomainData(output);</span><br><span class="line">  //将缓冲区的数据绘制到Canvas上</span><br><span class="line">  g.clearRect(-0.5,-height/2-0.5,width,height);</span><br><span class="line">  g.beginPath();</span><br><span class="line">  for(var i=0;i&lt;width;i++)</span><br><span class="line">    g.lineTo(i,height*(output[output.length*i/width|0]/256-0.5));</span><br><span class="line">  g.stroke();</span><br><span class="line">  //请求下一帧</span><br><span class="line">  requestAnimationFrame(callee);</span><br><span class="line">&#125;)();</span><br><span class="line">//播放</span><br><span class="line">audio.play();</span><br><span class="line">load = volume.onchange = function()&#123;</span><br><span class="line">    filter.frequency.value = volume.value * volume.value;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">DEMO Code</span><br></pre></td></tr></table></figure><br><br><p>这里频率的变化是：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter.frequency.value = volume.value * volume.value;</span><br></pre></td></tr></table></figure>
<p></p><p>线性变化可能不太明显，所以改成了平方变化。</p><p></p>
<p></p><h3>二、小结</h3><p></p>
<p></p><p>滤波在通信中一个重要的意义是减少数据传输量，节约频带，提高传送效率，在硬件设备还未跟上语音通信的 web环境中，这个操作是十分有意义的！</p><p></p>
<p></p><p>本节重点是介绍 BiquadFilterNode 在 AudioContext 环境中的使用，比较简单。</p><p></p>
<p></p><h3>三、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><br><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/02/27/2014-02-27-cb-webAudio-cross-fading/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/02/27/2014-02-27-cb-webAudio-cross-fading/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">声道的转换</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-27 01:17:00" itemprop="dateCreated datePublished" datetime="2014-02-27T01:17:00+08:00">2014-02-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/27/webAudio-cross-fading.html" target="_blank">博客园</a>.</div>

<p>本系列文章主要是介绍 Web Audio API 的相关知识，以及 web语音通信 中会遇到的一些问题，阐述可能存在错误，还请多多斧正！</p><br><p>很多粤语剧都提供了两个声道，一个左声道为粤语，一个右声道有国语。观看者可以自由切换声道，那么切换声道的原理是什么呢？在播放器中，只需要把不同的声道切换到声轨就行了，因为有左右两个声道，所以播放器至少是包含两个声轨的。如果我们想听粤语，只需要将右声道声轨的声音设置为 0，或者临时删掉右声道声轨。本文主要是利用 GainNode 节点控制音量的属性实现两个音轨之间的相互切换，Cross-fading 的意思可以在后面的 DEMO 中用耳朵体会出来~</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-cross-fading.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/webAudio-cross-fading.html</a>，转载请注明源地址。</p><br><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><br><h3>一、两个声音之间的声轨切换</h3><br><h4>1. 原理介绍</h4><br><p>在一个 AudioContext 中可以输入多个音频流，而这些音频流在 AudioContext 这个环境中辗转反侧，最后的出路也就是 DestinationNode：</p><br><blockquote><br><p>source 1 —+</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |—-&gt; Destination</p><br><p>source 2 —+</p><br></blockquote><br><p>而要实现上面两个声轨的切换，实则是它容易了，我们可以在他们到达 Destination 之前，加一个 GainNode，<a href="http://www.cnblogs.com/hustskyking/admin/webAudio-volume" target="_blank" rel="noopener">上文</a> 已经对 GainNode 做了详细的说明，本文就不继续赘述了。</p><br><h4>2. DEMO 演示</h4><br><p>首先要创建两个音频，平时我们都是使用 audio 节点带上 src 属性，插入到 DOM 中让其自动播放音频，本文将使用其他的方式拿到音频流：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var tank = new Audio(&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;);</span><br></pre></td></tr></table></figure>
<p>我准备了两个音频，一个是 tankWar.mp3 ，经典的坦克大战开场音乐，另一个是 SuperMario.mp3，超级玛丽的背景音乐，前者稍微短一些，所以在播放的时候将其设定为循环播放：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tank.loop = true;</span><br></pre></td></tr></table></figure>
<p>然后利用 createMediaElementSource 这个函数从 Media 中获取到音频流：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var source1 = context.createMediaElementSource(tank);</span><br></pre></td></tr></table></figure>
<p>过程十分简单，整个 AudioContext 的连接模型为：</p><br><blockquote><br><p>source 1 –&gt; GainNode 1 -+</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|—-&gt; Destination</p><br><p>source 2 –&gt; GainNode 2 -+</p><br></blockquote><br><p>然后用同一个控制棒来控制 GainNode 1 和 2。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; id=&quot;volume&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var tank = new Audio(&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;);</span><br><span class="line">    tank.loop = true;</span><br><span class="line">    var mario = new Audio(&quot;http://qianduannotes.duapp.com/file/SuperMario.mp3&quot;);</span><br><span class="line">    mario.loop = true;</span><br><span class="line"></span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source1 = context.createMediaElementSource(tank);</span><br><span class="line">    var source2 = context.createMediaElementSource(mario);</span><br><span class="line">    var gain1 = context.createGain();</span><br><span class="line">    var gain2 = context.createGain();</span><br><span class="line">    //连接：source → gain → destination</span><br><span class="line">    source1.connect(gain1);</span><br><span class="line">    source2.connect(gain2);</span><br><span class="line">    gain1.connect(context.destination);</span><br><span class="line">    gain2.connect(context.destination);</span><br><span class="line">    //音量控制</span><br><span class="line">    var value;</span><br><span class="line">    onload = volume.onchange = function()&#123;</span><br><span class="line">      gain1.gain.value = volume.value / 100;</span><br><span class="line">      gain2.gain.value = 1 - volume.value / 100;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    tank.onload = mario.onlond = function()&#123;</span><br><span class="line">        console.log(&quot;var1, var2&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    tank.play();</span><br><span class="line">    mario.play();</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>代码没有封装，写的稍微有些乱，不过看了之前的说明，应该可以理解这段代码~</p><br><h4>3. 效果增强</h4><br><p>上面的音量控制，我使用的是线性控制：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gain1.gain.value = volume.value / 100;</span><br><span class="line">gain2.gain.value = 1 - volume.value / 100;</span><br></pre></td></tr></table></figure>
<p>效果并不是特别好，他对音量的控制如下图：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/27/271310073679049.png" data-source="http://images.cnitblog.com/blog/387325/201402/271310073679049.png" alt=""></p><br><p>稍微修改下控制函数：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var vol = volume.value / 100;</span><br><span class="line">gain1.gain.value = Math.cos(vol * 0.5 * Math.PI);</span><br><span class="line">gain2.gain.value = Math.cos((1.0 - vol) * 0.5 * Math.PI);</span><br></pre></td></tr></table></figure>
<p></p><p>可以感受到音量的变化是这样的：</p><p></p>
<p></p><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/27/271310163176584.png" data-source="http://images.cnitblog.com/blog/387325/201402/271310163176584.png" alt=""></p><p></p>
<p></p><p>详情可以戳这个demo：<a href="http://qianduannotes.duapp.com/demo/audio/" target="_blank">http://qianduannotes.duapp.com/demo/audio/</a></p><p></p>
<p></p><h3>二、小结</h3><p></p>
<p></p><p>本文的目的是介绍 Web Audio API 的 GainNode 节点的使用，并将此应用到声道的切换之中，上面的例子不能算是严格的声道切换，但如果我们只给 volume 参数设定 0 ,50, 100 这三个值，那效果跟声道的切换就差不多了~</p><p></p>
<p></p><p>由于这几篇文章都是关于 Node 之间的相互连接，技术含量并不多，主要是读懂 API 以及相关使用方法。行文仓促，如有错误地方，还请斧正！</p><p></p>
<p></p><h3>三、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><br><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/02/26/2014-02-26-cb-webAudio-volume/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/02/26/2014-02-26-cb-webAudio-volume/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">音量的控制</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-26 12:56:00" itemprop="dateCreated datePublished" datetime="2014-02-26T12:56:00+08:00">2014-02-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/26/webAudio-volume.html" target="_blank">博客园</a>.</div>

<p>改变音频的音量是音频处理中最基础的部分，我们可以利用 GainNode 来构建 Mixers 的结构块。GainNode 的接口是很简单的：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface GainNode : AudioNode &#123;</span><br><span class="line">    readonly attribute AudioParam gain;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过调节 GainNode.gain.value 就可以实现音频大小的调控了。下文会先介绍使用 Processor 来处理，这是一个最通用的节点，可以处理很多东西。在上文<a href="http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html" target="_blank">看得到的音频流</a>中我们也使用了该节点。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-volume.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/webAudio-volume.html</a>，转载请注明源地址。</p><br><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><br><h3>一、音频流音量大小的控制</h3><br><h4>1. 使用 Processor 处理</h4><br><p>这个过程比较简单：</p><br><blockquote><br><p>source Node -&gt; Processor Node -&gt; Destination Node</p><br></blockquote><br><p>数据送入到 Processor 后，由于输入 channel 和输出的 channel 之间的对应关系需要我们自己去处理，这些对应关系可以在 onaudioprocess 事件中处理，只要上面的连接导通，那这个事件就一直会处于触发状态，无论是否有数据流送入（其实没有数据流送入也就是数据流 bufferArray 为 0 嘛）。</p><br><p>可以看下面这个 DEMO：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;audio&quot; autoplay&gt;&lt;/audio&gt;</span><br><span class="line">&lt;input type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; id=&quot;volume&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source = context.createMediaElementSource(audio);</span><br><span class="line">    // 低通滤波节点（高频信号被过滤，听到的声音会很沉闷）</span><br><span class="line">    var processor = context.createScriptProcessor(1024, 1, 1);</span><br><span class="line">    // sourceNode - &gt; processor -&gt; destinationNode</span><br><span class="line">    source.connect(processor);</span><br><span class="line">    processor.connect(context.destination);</span><br><span class="line">    //处理过程</span><br><span class="line">    processor.onaudioprocess = function(e)&#123;</span><br><span class="line">      //获取输入和输出的数据缓冲区</span><br><span class="line">      var input = e.inputBuffer.getChannelData(0);</span><br><span class="line">      var output = e.outputBuffer.getChannelData(0);</span><br><span class="line">      //将输入数缓冲复制到输出缓冲上，并调整音量</span><br><span class="line">      for(var  i =0; i &lt; input.length; i++)</span><br><span class="line">            output[i] = input[i] * value;</span><br><span class="line">    &#125;;</span><br><span class="line">    //音量控制</span><br><span class="line">    var value;</span><br><span class="line">    onload = volume.onchange = function()&#123;</span><br><span class="line">      value = volume.value / 200;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p><h4>2. 使用 GainNode 控制</h4><p></p>
<p>上面这种方式，我们可以在 onaudioprocess 事件中拿到几乎我们想要的所有数据，并且可以进行各种处理，可以说 processor 这个节点十分通用，但他的性能并不是高，你应该也看到了上面的代码中有：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//将输入数缓冲复制到输出缓冲上，并调整音量  </span><br><span class="line">for(var  i =0; i &lt; input.length; i++)</span><br><span class="line">    output[i] = input[i] * value;</span><br></pre></td></tr></table></figure>
<p>需要将数据一一复制到输出节点，上面 demo 中我们设定的 bufferSize 是 1024 ，如果再大一些，或者文中需要处理的节点数太多，那页面将会很卡。Web Audio API 中提供了提供音量的节点，GainNode，既然提供了，毫无疑问，就用它呗~</p><br><p>节点连接方式也是十分的方便：</p><br><blockquote><br><p>source → gain → destination</p><br></blockquote><br><p>然后通过一个 range 控件来调节 Gain 的 gain 参数。DEMO如下：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;audio&quot; autoplay&gt;&lt;/audio&gt;</span><br><span class="line">&lt;input type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; id=&quot;volume&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source = context.createMediaElementSource(audio);</span><br><span class="line">    var Gain = context.createGain();</span><br><span class="line">    //连接：source → Gain → destination</span><br><span class="line">    source.connect(Gain);</span><br><span class="line">    Gain.connect(context.destination);</span><br><span class="line">    //音量控制</span><br><span class="line">    var value;</span><br><span class="line">    onload = volume.onchange = function()&#123;</span><br><span class="line">      gain.gain.value = volume.value / 200;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p><p>十分轻松简洁的处理一个音量控制。</p><p></p>
<p></p><h3>二、小结</h3><p></p>
<p></p><p>本文主要是介绍 Web Audio API 中的 GainNode 节点，以及相关的应用。文中的两个 DEMO ，前者利用 processor 节点来处理，关于这个几点的说明，可以参考上两篇文章的接受；后者是使用 GainNode ，通过控制 Gain.gain.value 的值来调节音量的大小，过程十分简单，所以本文的思路也是比较的清晰。</p><p></p>
<p></p><p>如果本文中有叙述不正确的地方，还请斧正！</p><p></p>
<p></p><h3>三、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><br><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/02/22/2014-02-22-cb-webAudio-show-audio/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/02/22/2014-02-22-cb-webAudio-show-audio/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">看得到的音频流</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-22 08:45:00" itemprop="dateCreated datePublished" datetime="2014-02-22T08:45:00+08:00">2014-02-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/22/webAudio-show-audio.html" target="_blank">博客园</a>.</div>

<p><a href="http://www.cnblogs.com/hustskyking/p/webAudio-listen.html" target="_blank">上文</a>介绍了 Web Audio API 的相关知识，以及如何在你的 web 程序中引入 音频流，内容都是介绍性的，所以没有写太多 DEMO。本文重点讲解如何利用 Web Audio API 中的中间节点拿到音频信号的信息，并将信息转化成信号图绘制到 canvas 中。</p><br><p>从上文中我们了解到，AudioContext 是音频播放和处理的一个环境，大概的流程是这个样子：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  +---------------+------------------------------------+</span><br><span class="line">  | AudioContext  |                                    |</span><br><span class="line">  +---------------+                                    |</span><br><span class="line">  |        +-------+    +-------+    +-------+         |</span><br><span class="line">  |        |       |    |       |    |       |         |</span><br><span class="line">==========&gt;| Source|===&gt;|Lots of|===&gt;|  Dest | Output  |</span><br><span class="line">Multi Input|       |    |       |    |       |===========&gt;</span><br><span class="line">==========&gt;|  Node |===&gt;| Nodes |===&gt;|  Node |         |</span><br><span class="line">  |        |       |    |       |    |       |         |</span><br><span class="line">  |        +-------+    +-------+    +-------+         |</span><br><span class="line">  |                         |                          |</span><br><span class="line">  |                         |    Created By Barret Lee |</span><br><span class="line">  +-------------------------|--------------------------+</span><br><span class="line">                            |         +-------------+</span><br><span class="line">                            +========&gt;| Other Tools |</span><br><span class="line">                              signal  +-------------+</span><br></pre></td></tr></table></figure>
<p>在 AudioContext 中，通过一个结点（AudioNode）来接受输入源，中间的一些结点可以过滤、放大、去杂等处理 Source Node 的信号，处理之后可以送到 AudioContext 的输出结点，然后启用 <code>source.start()</code> 播放音频信息；也可以将处理的信息送到外部交给其他对象来处理，比如本文要谈到的，将信号交给 Canvas 来处理，这样就能看到音频信号的波形图了。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html" target="_blank">http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html</a>，转载请注明源地址。</p><br><p><strong>注：较新版 Google Chrome 和 Firefox 才能运行本文中的 DEMO。</strong></p><br><h3>一、节点的连接</h3><br><p>先说一说，各个节点在 AudioContext 中的连接是如何用代码实现的:</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 创建一个 AudioContext 环境</span><br><span class="line">var context = new AudioContext();</span><br><span class="line"></span><br><span class="line">function playSound() &#123;</span><br><span class="line">    // 创建一个 Source 节点</span><br><span class="line">    var source = context.createBufferSource();</span><br><span class="line">    // 拿到输入源（狗吠）</span><br><span class="line">    source.buffer = dogBarkingBuffer;</span><br><span class="line">    // 将 source 节点链接到 destination 节点（输出节点）</span><br><span class="line">    source.connect(context.destination);</span><br><span class="line">    // currentTime 设定为 0，开始播放</span><br><span class="line">    source.start(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的连接十分简单，直接将 source 节点连接到 destination 节点，相当于没有经过人任何处理，直接输出了，而下面的方式是创建一个中间节点，对信号做一些处理，不过在拿到 Source 的方式上跟上面有些不一样：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var audio = document.getElementsByTagName(&quot;audio&quot;)[0];</span><br><span class="line">// context 为一个 AudioContext 环境</span><br><span class="line">// 从 audio 元素中拿到输入源，也就是上图所看到的 Mutil Input</span><br><span class="line">var source = context.createMediaElementSource(audio);</span><br><span class="line">// 建立一个处理延时节点</span><br><span class="line">var delayNode = context.createDelay();</span><br><span class="line">// sourceNode -&gt; delayNode -&gt; destinationNode</span><br><span class="line">source.connect(delayNode);</span><br><span class="line">delayNode.connect(context.destination);</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是，destination 是 AudioContext 实例的固有属性，他就是信号的最终汇聚的位置，也是信号的输出位置。下面是一个简单的 DEMO 代码：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;origin&quot;&gt;&lt;/audio&gt;</span><br><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;audio&quot;&gt;&lt;/audio&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;origin.play()&quot; value=&quot;原始音质 播放&quot;&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;origin.pause()&quot; value=&quot;原始音源 暂停&quot;&gt;&lt;br&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;audio.play()&quot; value=&quot;滤波音质 播放&quot;&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;audio.pause()&quot; value=&quot;滤波音源 暂停&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source = context.createMediaElementSource(audio);</span><br><span class="line">    // 低通滤波节点（高频信号被过滤，听到的声音会很沉闷）</span><br><span class="line">    var FilterNode = context.createBiquadFilter(&quot;lowpass&quot;);</span><br><span class="line">    // sourceNode -&gt; FilterNode -&gt; destinationNode</span><br><span class="line">    source.connect(FilterNode);</span><br><span class="line">    FilterNode.connect(context.destination);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>上面的代码，AudioContext 获取 audio 源的原理是这样的：</p><br><ol><br><li>audio有一个内置的输出通道</li><br><li>AudioContext 通过 createMediaElementSource 将 audio 的输出直接拉去到新的环境中，之前 audio 环境被破坏</li><br><li>拉去的 source 没有 start 函数，他会一直监听 audio 的操控，当 play 函数被触发的时候，开始播放音频。也可以认为，play 函数触发了 start （老版浏览器中是 noteOn）</li><br></ol><br><p>下面是一个演示图：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+----------+------------------------------+</span><br><span class="line">| audio    |                              |</span><br><span class="line">+----------+                              |</span><br><span class="line">|     +--------+      //  +-------------+ |</span><br><span class="line">|     | Source |=====//==&gt;| Destination | |</span><br><span class="line">|     +--------+  | //    +-------------+ |</span><br><span class="line">|                 |                       |</span><br><span class="line">+-----------------|-----------------------+</span><br><span class="line">                  |   Created By Barret Lee</span><br><span class="line">         +--------|-----+--------------------------+</span><br><span class="line">         |        ↓                                |</span><br><span class="line">         |     +--------+    +-------+    +------+ |</span><br><span class="line">         |     | Source |===&gt;| Nodes |===&gt;| Dest | |</span><br><span class="line">         |     +--------+    +-------+    +------+ |</span><br><span class="line">         |                          +--------------+</span><br><span class="line">         |                          | AudioContext |</span><br><span class="line">         +--------------------------+--------------+</span><br></pre></td></tr></table></figure>
<p></p><h3>二、两个中间节点的介绍</h3><p></p>
<p></p><h4>1. ScriptProcessorNode</h4><p></p>
<p>我们可以直接使用 JavaScript 操控这个节点，他的作用是产生、传递、分析一段音频。他有一个 bufferSize 属性和一个 onaudioprocess 事件。初始化一个 ScriptProcessorNode：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var processor=context.createScriptProcessor(4096, 1, 1);</span><br></pre></td></tr></table></figure>
<p>他接收三个参数，第一个是 bufferSize 的大小，取值范围是 <code>Math.pow(2, N) ( 8&le;N&le;14 )</code>，第二个参数是送入的 channel 数，第三个参数是输出的 channel 数。信息不会自动通过这个节点需要我们自己将输入的信号复制到输出位置去：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">processor.onaudioprocess = function(e)&#123;</span><br><span class="line">    //获取输入和输出的数据缓冲区</span><br><span class="line">    var input = e.inputBuffer.getChannelData(0);</span><br><span class="line">    var output = e.outputBuffer.getChannelData(0);</span><br><span class="line"></span><br><span class="line">    //将输入数缓冲复制到输出缓冲上</span><br><span class="line">    for(var i = 0, len = input.length; i &lt; len; i++)&#123;</span><br><span class="line">        output[i] = input[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样处理的原因是因为多个输入要对应对个输出，也有可能是多对一或者一对多，所以这些信息的设定必须要人为去控制。</p><br><p>关于 ScriptProcessorNode 的介绍，具体请移步<a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode-section" target="_blank">http://www.w3.org/TR/webaudio/#ScriptProcessorNode-section</a></p><br><h4>2. AnalyserNode</h4><br><p>通过这个节点我们可以对信号进行频域和时域上的分析，学过 通信原理 的同学对这些属于应该是十分熟悉的。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">interface AnalyserNode : AudioNode &#123;</span><br><span class="line"></span><br><span class="line">    // Real-time frequency-domain data </span><br><span class="line">    void getFloatFrequencyData(Float32Array array);</span><br><span class="line">    void getByteFrequencyData(Uint8Array array);</span><br><span class="line"></span><br><span class="line">    // Real-time waveform data </span><br><span class="line">    void getByteTimeDomainData(Uint8Array array);</span><br><span class="line"></span><br><span class="line">    attribute unsigned long fftSize;</span><br><span class="line">    readonly attribute unsigned long frequencyBinCount;</span><br><span class="line"></span><br><span class="line">    attribute double minDecibels;</span><br><span class="line">    attribute double maxDecibels;</span><br><span class="line"></span><br><span class="line">    attribute double smoothingTimeConstant;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面是这个节点的接口信息，不要感到奇怪，对接口的描述，都是使用这种方式，从上面我们可以看到，他有三个方法，四个属性。fftSize 是指频率分析下的快速傅里叶变换大小，他的值被限定在 32-2048 的 2 的整数次方。</p><br><p>关于 AnalyserNode 的介绍，具体请移步<a href="http://www.w3.org/TR/webaudio/#AnalyserNode-section" target="_blank">http://www.w3.org/TR/webaudio/#AnalyserNode-section</a></p><br><h3>三、音频信息的提取</h3><br><p>利用上面介绍的两个节点可以十分轻松的提取到音频信息，如使用 ScriptProcessorNode，在他的 onaudioprocess 触发的时候，可以拿到 input 信息，此时也就是音频信息流。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">processor.onaudioprocess = function(e)&#123;</span><br><span class="line">    //获取输入和输出的数据缓冲区</span><br><span class="line">    var input = e.inputBuffer.getChannelData(0);</span><br><span class="line"></span><br><span class="line">    doSomething(input);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面这种方式拿到数据的效率是比较低的，一般可以直接使用 AnalyserNode 节点。这个节点中一个获取缓冲数据区的方法叫做 getByteTimeDomainData，这个方法的设计是十分偏底层的，或者对 JSer 来说，这个借口的设计并不合理，可以看看：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//以fftSize为长度创建一个字节数组作为数据缓冲区</span><br><span class="line">var output = new Uint8Array(analyser.fftSize);</span><br><span class="line">// 将获取得到的数据赋值给 output</span><br><span class="line">analyser.getByteTimeDomainData(output);</span><br></pre></td></tr></table></figure>
<p>这里是把 output 作为引用传进 getByteTimeDomainData 函数中，相信大家应该没有在 JS 中遇到过这样的写法吧~ （我觉得在该 web 标准定稿的时候，这里一定会做修改！）</p><br><h3>四、信号图的绘制</h3><br><p>上面我们已经拿到了信号数据了，绘制工作其实就是 canvas 的事情啦~</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var width = canvas.width,</span><br><span class="line">    height = canvas.height,</span><br><span class="line">    g = canvas.getContext(&quot;2d&quot;);</span><br><span class="line"></span><br><span class="line">// 将坐标原点移动到(0.5, height / 2 + 0.5)的位置</span><br><span class="line">g.translate(0.5, height / 2 + 0.5);</span><br></pre></td></tr></table></figure>
<p>然后绘制图形：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">processor.onaudioprocess=function(e)&#123;</span><br><span class="line">    //获取输入和输出的数据缓冲区</span><br><span class="line">    var input = e.inputBuffer.getChannelData(0);</span><br><span class="line">    var output = e.outputBuffer.getChannelData(0);</span><br><span class="line">    //将输入数缓冲复制到输出缓冲上</span><br><span class="line">    for(var i=0; i</span><br><span class="line">&lt;p&gt;下面是整个 DEMO 的代码，效果预览：&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;img src=&quot;//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png&quot; data-original=&quot;/blogimgs/2014/02/22/222051302848233.jpg&quot; data-source=&quot;http://images.cnitblog.com/blog/387325/201402/222051302848233.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;代码：&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<p><canvas id="canvas" width="400" height="100"></canvas></p>
<p><audio id="audio" autoplay src="http://qianduannotes.duapp.com/file/tankWar.mp3"></audio><br><br></p>
<p><input type="button" onclick="audio.play()" value="播放"></p>
<p><input type="button" onclick="audio.pause()" value="暂停"></p>
<script>
var AudioContext=AudioContext||webkitAudioContext;
var context=new AudioContext;
//从元素创建媒体节点
var media=context.createMediaElementSource(audio);
//创建脚本处理节点
var processor=context.createScriptProcessor(4096,1,1);
//Canvas初始化
var width=canvas.width,height=canvas.height;
var g=canvas.getContext("2d");
g.translate(0.5,height/2+0.5);
//连接：媒体节点→控制节点→输出源
media.connect(processor);
processor.connect(context.destination);
//控制节点的过程处理
processor.onaudioprocess=function(e){
  //获取输入和输出的数据缓冲区
  var input=e.inputBuffer.getChannelData(0);
  var output=e.outputBuffer.getChannelData(0);
  //将输入数缓冲复制到输出缓冲上
  for(var i=0;i<input.length;i++)output[i]=input[i];
  //将缓冲区的数据绘制到Canvas上
  g.clearRect(-0.5,-height/2-0.5,width,height);
  g.beginPath();
  for(var i=0;i<width;i++)
    g.lineTo(i,height/2*output[output.length*i/width|0]);
  g.stroke();
};
</script>

<p>DEMO<br><code>`</code></p>
<p></p><p>该段代码引自次碳酸钴的<a href="http://www.web-tinker.com/article/20498.html" target="_blank">博客</a>。</p><p></p>
<p></p><h3>五、小结</h3><p></p>
<p></p><p>本文着重讲述了 AudioContext 内部节点之间的交互原理，以及如何使用节点获取数据，关于图形的绘制是 canvas 的操作，不是本系列文章的重点，所以一笔带过。</p><p></p>
<p></p><p>如果文中有叙述不正确的地方，还请斧正！</p><p></p>
<p></p><h3>六、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><br><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/02/20/2014-02-20-cb-webAudio-listen/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/02/20/2014-02-20-cb-webAudio-listen/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">让音乐响起来</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-20 12:47:00" itemprop="dateCreated datePublished" datetime="2014-02-20T12:47:00+08:00">2014-02-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/20/webAudio-listen.html" target="_blank">博客园</a>.</div>

<p>本系列文章主要是介绍 Web Audio API 的相关知识，由于该技术还处在 web 草案阶段（很多标准被提出来，至于取舍需要等待稳定版文档来确定，草案阶段的文档很多都会被再次编辑甚至重写、全部删除等，不适合作为正式参考），很多 API 都是未确定的，目前支持 Web Audio API 的浏览器是较新版的 Google Chrome 和 FireFox，其他浏览器暂时还没有兼容。</p><br><p>现在的网络硬件环境还没有达到普遍语音通信的条件，但是 web语音通信 一定会成为后期 web 研究的一个重要话题，凭着一点个人兴趣，拿出来研究研究~</p><br><p>本文主要介绍 Web Audio API 的相关特性，以及音频源的获取方式。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-listen.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/webAudio-listen.html</a>，转载请注明源地址。</p><br><h3>一、Web Audio</h3><br><p>在 <code>&lt;audio&gt;</code> 标签的到来之前，Flash 以及其他的插件相继打破 web 的宁静，而如今 audio 被送到了 web 开发之中，我们再也不需要引用各种插件来播放声音了。</p><br><h4>1. Web Audio API 的特性</h4><br><p>Web Audio API 是 JavaScript 中主要用于在网页应用中处理音频请求的一个高级应用接口，这个 API 目的是用于让最新技术与传统的游戏音频引擎的综合处理相兼容，也即尽力提供一些桌面音频处理程序的要求。</p><br><ul><br><li>查看音频播放期间调度事件发生的确切时间；</li><br><li>支持各种类型的音频过滤波器以实现各种效果，包括回声、消除噪音等；</li><br><li>支持利用合成声音（Sound synthesis）创建电子音乐；</li><br><li>支持3D位置音频模拟效果，比如某种声音随着游戏场景而移动；</li><br><li>支持外部输入的声音与 WebRTC 进行集成（调用 WebRTC ，在你的设备中增添吉他声），或者在 WebRTC 中调用其他地方传输过来的声音；</li><br><li>利用音频数据分析创造良好的可视化声音等。</li><br></ul><br><h4>2. AudioContent 简介</h4><br><p>Web Audio API 可以用来操作或者播放网页以及应用中的 audio 资源，在一个 Audio上下文环境（AudioContext）中，有各种 Audio节点（AudioNode），如：</p><br><table><br><thead><br><tr><th>Interface</th><th>description</th></tr><br></thead><br><tbody><br><tr><br><td>AudioContext</td><br><td>包含表示连接中间件 AudioNodes 的音频信号曲线图</td><br></tr><br><tr><br><td>AudioNode</td><br><td>表示 audio源，audio输出以及 中间处理模块，他处在 AudioContext 的上下文中</td><br></tr><br><tr><br><td>AudioDestinationNode</td><br><td>他是 AudioNode 的一个子类，表示所有被渲染音频流到达的最终地点</td><br></tr><br><tr><br><td>AudioBuffer</td><br><td>表示 audio资源 的一个临时缓存，可表示一个音频剪辑</td><br></tr><br><tr><br><td>AudioBufferSourceNode</td><br><td>从 AudioBuffer 中生成 audio 的 AudioNode 节点</td><br></tr><br><tr><br><td>ScriptProcessorNode</td><br><td>一个可以直接被 JS 操作的 AudioNode 节点</td><br></tr><br><tr><br><td>GainNode</td><br><td>音频增益节点</td><br></tr><br><tr><br><td>OscillatorNode</td><br><td>一个可产生固定频率的 audio 源</td><br></tr><br></tbody><br></table><br><p>还有其他的 API 可以查看<a href="http://www.w3.org/TR/webaudio/#APIOverview" target="_blank">http://www.w3.org/TR/webaudio/#APIOverview</a>.</p><br><p>使用 AudioContext 实例，我们可以将生成的一个或者多个音频流连接到声音的输出位置，这个连接并不一定是直接送到输出端，期间可以使用 AudioNodes 作为中继器和处理器，让这些声音信号有一个更好的效果。</p><br><p>单个 AudioContext 实例可以支持多音频的输入，所以对于一个 audio 应用我们只需要创建一个实例就行了。很多诸如创建一个 AudioNode 节点、解码音频文件等方法都是 AudioContext 的内置方法。创建一个 AudioContext 上下文也十分简单：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var context;</span><br><span class="line">try&#123;</span><br><span class="line">    window.AudioContext = window.AudioContext || window.webkitAudioContext;</span><br><span class="line">    context = new AudioContext();</span><br><span class="line">&#125;</span><br><span class="line">catch(e) &#123;</span><br><span class="line">    alert(&apos;请更新至最新版的 Chrome 或者 Firefox&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></p><h3>二、音频流的获取</h3><p></p>
<p></p><h4>1. 标签引入</h4><p></p>
<p>标签引入是最直接的方式，</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio autoplay src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;&gt;</span><br><span class="line">    浏览器不支持 audio 标签。</span><br><span class="line">&lt;/audio&gt;</span><br></pre></td></tr></table></figure>
<p>如果浏览器不支持 audio 标签，便会将其当做一个普通元素来解析，中间一行字也就会被显示出来。而支持 audio 标签的浏览器会忽略标签内任何文本。我们还可以为他加上 autoplay 、loop 等属性，使音频在进入页面之后立即循环播放。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio autoplay=&quot;autoplay&quot; controls=&quot;controls&quot; src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;&gt;</span><br><span class="line">    浏览器不支持 audio 标签。</span><br><span class="line">&lt;/audio&gt;</span><br></pre></td></tr></table></figure>
<p>controls 属性是用来控制显示音频文件的控制部分的。默认未设置 controls 属性。</p><br><h4>2. <span>webRTC mediaStream</span>&nbsp;Media Capture <span>(多谢<a href="http://www.cnblogs.com/hehe123/" target="_blank">@Hehe123</a>提醒,RTC属于通信了，此处只是获取 media 流)</span></h4><br><p>利用 getUserMedia 拿到本地的音频流。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 前缀处理</span><br><span class="line">window.AudioContext = window.AudioContext ||</span><br><span class="line">                  window.webkitAudioContext;</span><br><span class="line">navigator.getUserMedia =  navigator.getUserMedia ||</span><br><span class="line">                      navigator.webkitGetUserMedia ||</span><br><span class="line">                      navigator.mozGetUserMedia ||</span><br><span class="line">                      navigator.msGetUserMedia;</span><br><span class="line"></span><br><span class="line">var context = new AudioContext();</span><br><span class="line"></span><br><span class="line">navigator.getUserMedia(&#123;audio: true&#125;, function(stream) &#123;</span><br><span class="line">  // 获取本地流送入 AudioContext</span><br><span class="line">  var microphone = context.createMediaStreamSource(stream);</span><br><span class="line"></span><br><span class="line">  // filter为一个中间处理器，用来过滤音频</span><br><span class="line">  var filter = context.createBiquadFilter();</span><br><span class="line"></span><br><span class="line">  // microphone -&gt; filter -&gt; destination.</span><br><span class="line">  microphone.connect(filter);</span><br><span class="line">  filter.connect(context.destination);</span><br><span class="line">&#125;, function()&#123;</span><br><span class="line">    console.log(&quot;出了点问题~ 是否在服务器环境下运行？&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是，使用 webRTC 需要在服务器环境下，你可以搭建一个本地服务器，也可以把代码上传到远程服务器上测试。</p><br><h4>3. FileSystem</h4><br><p>选择本地文件，读取音频流，拿到 Blob 流地址，送入 audio 中</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;file&quot; onchange=&quot;return run(this.files);&quot;&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">&lt;audio controls id=&quot;audio&quot;&gt;&lt;/audio&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    function run(files)&#123;</span><br><span class="line">        var blob = window.webkitURL.createObjectURL(files[0]);</span><br><span class="line">        audio.src = blob;</span><br><span class="line">        audio.autoplay = &quot;autoplay&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p><h4>4. 移动设备，还可以使用如下方式</h4><p></p>
<p>1）HTML Media Capture</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;file&quot; accept=&quot;audio/*;capture=microphone&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>2）device 元素</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;device type=&quot;media&quot; onchange=&quot;update(this.data)&quot;&gt;&lt;/device&gt;</span><br><span class="line">&lt;audio autoplay&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  function update(stream) &#123;</span><br><span class="line">    document.querySelector(&apos;audio&apos;).src = stream.url;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p>
<p></p><h4>5. 从键盘获取</h4><p></p>
<p>本质并不是从键盘获取，而是通过键盘获取到我们设定的频率值，然后通过程序创建一段音频。如下面的程序：</p><br><p><span>下面例子中可以按键盘上中间的一排按键（A到K）来发出不同的声音。</span></p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var AudioContext=AudioContext||webkitAudioContext;</span><br><span class="line">var context=new AudioContext;</span><br><span class="line">//为每个键盘位对应一个频率</span><br><span class="line">var s=&#123;65:256,83:288,68:320,70:341,71:384,72:426,74:480,75:512&#125;;</span><br><span class="line">//为每个频率创建一个Oscillator</span><br><span class="line">for(var i in s)</span><br><span class="line">  value=s[i],</span><br><span class="line">  s[i]=context.createOscillator(),</span><br><span class="line">  s[i].frequency.value=value,</span><br><span class="line">  s[i].start();</span><br><span class="line">//键盘按下时将相应频率的Oscillator连接到输出源上</span><br><span class="line">addEventListener(&quot;keydown&quot;,function(e)&#123;</span><br><span class="line">  if(e=s[e.keyCode])e.connect(context.destination);</span><br><span class="line">&#125;);</span><br><span class="line">//键盘松开时将相应频率的Oscillator的连接取消</span><br><span class="line">addEventListener(&quot;keyup&quot;,function(e)&#123;</span><br><span class="line">  if(e=s[e.keyCode])e.disconnect();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p></p><p>这段代码引自次碳酸钴的<a href="http://www.web-tinker.com/article/20497.html" target="_blank">博客</a>.</p><p></p>
<p></p><h3>三、小结</h3><p></p>
<p></p><p>本文是个介绍性的文章，提到了 Web Audio API 的相关知识，以及如何在你的 web 程序中引入 音频流。没有写相关 demo，感兴趣的童鞋可以复制代码自己去测试，在后续文章中会给出测试 DEMO。</p><p></p>
<p></p><h3>四、参考文章</h3><p></p>
<ul><br><li><a href="http://www.csdn.net/article/2013-07-10/2816178-Web-Audio-API-Firefox" target="_blank">http://www.csdn.net/article/2013-07-10/2816178-Web-Audio-API-Firefox</a> CSND</li><br><li><a href="//hacks.mozilla.org/2013/07/web-audio-api-comes-to-firefox/">//hacks.mozilla.org/2013/07/web-audio-api-comes-to-firefox/</a> Mozilla</li><br><li><a href="http://www.html5rocks.com/en/tutorials/webaudio/intro/#toc-context" target="_blank">http://www.html5rocks.com/en/tutorials/webaudio/intro/#toc-context</a> html5rocks</li><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3 Group</li><br><li><a href="http://www.web-tinker.com/article/20497.html" target="_blank">http://www.web-tinker.com/article/20497.html</a>&nbsp;次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/02/17/2014-02-17-cb-problem-javascript-event/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/02/17/2014-02-17-cb-problem-javascript-event/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">JavaScript事件机制</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-17 09:18:00" itemprop="dateCreated datePublished" datetime="2014-02-17T09:18:00+08:00">2014-02-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/17/problem-javascript-event.html" target="_blank">博客园</a>.</div>

<p>群里童鞋问到关于事件传播的一个问题：\事件捕获的时候，阻止冒泡，事件到达目标之后，还会冒泡吗？”。</p><br><p>初学 JS 的童鞋经常会有诸多疑问，我在很多 QQ 群也混了好几年了，耳濡目染也也收获了不少，以后会总结下问题的结论，顺便说说相关知识的扩展~</p><br><p>如果贸然回答还会冒泡，这不太好的，稍微严谨点考虑 0级 DOM 事件模型的话，这个答案是否定的。但是在 2级 DOM 事件模型中，答案是肯定的，这个问题值得探讨记录下。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html</a>&nbsp;</p><br><h3>一、问题结论</h3><br><p>netscape 和 微软 曾经的战争还是比较火热的，当时， netscape 主张捕获方式，微软主张冒泡方式。后来 w3c 采用折中的方式，平息了战火，制定了统一的标准&mdash;&mdash;先捕获再冒泡。</p><br><div><strong>&nbsp;事件的触发有三个阶段</strong><ol><br><li>document&nbsp;往事件触发地点，捕获前进，遇到相同注册事件立即触发执行</li><br><li>到达事件位置，触发事件（多谢&nbsp;<span>@糖果果&nbsp;<span>指出&nbsp;<a href="#2878498">问题</a>&nbsp;，</span></span><span>@update 14/2/19</span> 如果该处既注册了冒泡事件，也注册了捕获事件，按照注册顺序执行）</li><br><li>事件触发地点往 document 方向，冒泡前进，遇到相同注册事件立即触发</li><br></ol><br><p>这么说很多人比较迷糊，我们在注册事件的时候，通常使用的是 捕获 或者 冒泡 的 一种：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj.addEventListener(&quot;click&quot;, func, true); // 捕获方式</span><br><span class="line">obj.addEventListener(&quot;click&quot;, func, false); // 冒泡方式</span><br></pre></td></tr></table></figure>
<p>事件只会因为捕获或者冒泡触发一次。举个栗子：</p><br><p><strong><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172047332617225.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172047332617225.jpg" alt=""></strong></p><br><p>点击 s2，结果是：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172049374659103.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172049374659103.jpg" alt=""></p><br><p>因为这里采用的是捕获模式，从 document 往 s2 走，依次发现 s1 和 s2 都有注册捕获事件，于是便触发了，然后冒泡，没找到冒泡事件，不执行任何操作。如果将 true 改成 false，可以看到结果相反。为了更好的让你理解整个事件机制，我给他们的捕获和冒泡模式下都注册事件：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172057001398575.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172057001398575.jpg" alt=""></p><br><p>结果真是太清晰了：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172057281606167.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172057281606167.jpg" alt=""></p>


<p></p><h3>二、误区</h3><p></p>
<p>指出两个误区。</p><br><p><strong>1. 在同一个对象上注册事件，并不一定按照注册顺序执行</strong></p><br><p>这一点，从上面的例子可以看出，你随便打乱四个事件绑定的顺序，结果一般不变！出现这样结果的原因是存在捕获模式和冒泡模式。但是值得注意的是，下面 #5楼 @糖果果 提出的问题，之所以如此是因为事件目的地节点既绑定了冒泡事件也绑定了捕获事件，此时的执行顺序按照绑定的先后顺序执行（情况比较少见）。</p><br><p><strong>2.event.stopPropagation();就是阻止事件的冒泡</strong></p><br><p>这个表述不能说他错误，但是是不完整的，他除了阻止事件的冒泡，还阻止事件的继续捕获，简而言之就是阻止事件的进一步传播。下面的例子可以看到：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172104390057858.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172104390057858.jpg" alt=""></p><br><p>结果是输出了 s1.</p>


<p></p><h3>三、拓展</h3><p></p>
<p><strong>1.&nbsp;stopImmediatePropagation 的使用</strong></p><br><p>这玩意儿是 w3c 的东西，使用的也不是特别多，我们知道 stopPropagation 可以阻止事件的进一步传播，但是他阻止不了该元素上绑定的其他函数的执行，比如我们在 obj 上绑定了 func1 和 func2，如果我们在 func1 中使用了&nbsp;stopPropagation ，那 func2 依然还是会执行出来。倘若这里使用&nbsp;stopImmediatePropagation，结果就不一样了，他不仅阻止事件的传播，还阻止 func2 的执行。如：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172112453398807.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172112453398807.jpg" alt=""></p><br><p>结果是：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172113011073790.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172113011073790.jpg" alt=""></p><br><p>而改成evt.stopImmediatePropagation();之后，阻止了第二个监听事件的触发：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172113246634621.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172113246634621.jpg" alt=""></p><br><p>结果是：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172113354087200.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172113354087200.jpg" alt=""></p><br><p><strong>2. setCapture 和 releaseCapture</strong></p><br><p>这两个是 IE 下的事件绑定函数，只要我们在某个元素上 setCapture 了，那么你在任何地方的鼠标操作（mouseXXX之类的动作）都会在这个元素上触发（前提是你在这个元素上绑定了事件），releaseCapture 或者本窗口失去聚焦才会释放这个绑定~</p>


<p></p><h3>四、小结</h3><p></p>
<p>对于此类知识的学习，应该查阅官方点的文档，或者看看《JavaScript权威指南》的解说，后期会经常整理诸如此类的问题。若有疑问，可以在下方评论中提出。</p>


<p></p></div><p></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/02/12/2014-02-12-cb-multiple-download-with-javascript/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/02/12/2014-02-12-cb-multiple-download-with-javascript/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">JavaScript多文件下载</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-12 09:50:00" itemprop="dateCreated datePublished" datetime="2014-02-12T09:50:00+08:00">2014-02-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/12/multiple-download-with-javascript.html" target="_blank">博客园</a>.</div>

<p>对于文件的下载，可以说是一个十分常见的话题，前端的很多项目中都会有这样的需求，比如 highChart 统计图的导出，在线图片编辑中的图片保存，在线代码编辑的代码导出等等。而很多时候，我们只给了一个链接，用户需要右键点击链接，然后选择\另存为”，这个过程虽说不麻烦，但还是需要两步操作，倘若用户想保存页面中的多个链接文件，就得重复操作很多次，最常见的就是英语听力网站上的音频下载，手都要点麻！</p><br><p>本文的目的是介绍如何利用 javascript 进行多文件的下载，也就是当用户点击某个链接或者按钮的时候，同时下载多个文件。这里的\同时”用的不是很准确，在现代浏览器中可以实现多文件的并行下载，而在一些老版本浏览器，如IE8-，此类的浏览器就只能进行单个文件的下载，但是我们可以让多个文件依次保存下来，算是串行下载吧~</p><br><p>若要要无视实现细节，可以直接跳到第三部分，或者戳：</p><br><p>代码封装：<a href="//github.com/barretlee/javascript-multiple-download/blob/master/lib.js" target="_blank">lib.js</a></p><br><p>DEMO：<a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTPS，第三个有bug，具体原因下面有说明)</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://qianduannotes.duapp.com/demo/javascript-multiple-download/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTP，测试正常)</p>


<p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/multiple-download-with-javascript.html" target="_parent">http://www.cnblogs.com/hustskyking/p/multiple-download-with-javascript.html</a>，转载请保留原文地址。</p><br><h3>一、文件类型介绍及其特点</h3><br><h4>1. 一般类型</h4><br><p>平时比较常见的有 txt、png、jpg、zip、tar 等各种文件格式，这些文件格式中，一部分浏览器是会直接打开链接显示内容的，而另外一部分，浏览器不识别响应头，或者不能解析对应的格式，于是当做文件直接下载下来了。如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;http://barretlee.com/test.rar&quot;&gt;file&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>这句代码，若直接点开链接，浏览器将会直接下载该文件。</p><br><h4>2. dataURL类型</h4><br><p>dataURL 也是十分常见的类型，他可以作为 src 或者 url() 的参数送进去。比较常见的有如下几种：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">文本： data:text/plain;这里是正文内容。</span><br><span class="line">图片： data:image/jpg;base64,/9j/4AAQSkZJRgABAQEA....</span><br><span class="line">       data:image/png;base64,/9j/4AAQSkZJRgABAQEA....</span><br></pre></td></tr></table></figure>
<p>base64 是用的比较广泛的一种数据格式。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Base64格式</span><br><span class="line">data:[][;charset=][;base64],</span><br><span class="line">Base64 在CSS中的使用：</span><br><span class="line">.demoImg&#123; background-image: url(&quot;data:image/jpg;base64,/9j/4QMZRXhpZgAASUkqAAgAAAAL....&quot;); &#125;</span><br><span class="line">Base64 在HTML中的使用：</span><br><span class="line">&lt;img width=&quot;40&quot; height=&quot;30&quot; src=&quot;data:image/jpg;base64,/9j/4QMZRXhpZgAASUkqAAgAAAAL....&quot;&gt;</span><br></pre></td></tr></table></figure>
<p></p><h4>3. Blob 流</h4><p></p>
<p>Blob 对象表示不可变的、包含原始数据的类文件对象。具体的内容可以参阅<a href="//developer.mozilla.org/en-US/docs/Web/API/Blob" target="_blank">MDN文档</a>。</p><br><p>他的使用也是特别的方便，如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var aFileParts = [&apos;&lt;a id=&quot;a&quot;&gt;&lt;b id=&quot;b&quot;&gt;hey!&lt;/b&gt;&lt;/a&gt;&apos;];</span><br><span class="line">var oMyBlob = new Blob(aFileParts, &#123;type : &apos;text/html&apos;&#125;); // the blob</span><br></pre></td></tr></table></figure>
<p>Blob 接收两个参数，一个是数组类型的数据对象，他可以是 ArrayBuffer、ArrayBufferView、Blob、String 等诸多类型；第二个参数是 MINE 类型设置。而本文我们要用到的是 <code>URLcreateObjectURL()</code> 这个函数，他的作用是将一个 URL 所代表的内容转化成一个 <a href="//developer.mozilla.org/en-US/docs/Web/API/DOMString" target="_blank">DOMString</a>，产生的结果是一个 文件对象 或者 Blob 对象。</p><br><h4>4. 二进制流</h4><br><p>我们利用 File API 读取文件的时候，拿到的是数据的二进制流格式，这些类型可以直接被 ArrayBuffer 等接收，本文中没有用到，就不细说了。</p><br><h3>二、JavaScript 多文件下载</h3><br><p>HTML5 中 a 标签多了一个属性&mdash;&mdash;download，用户点击链接浏览器会打开并显示该链接的内容，若在链接中加了 download 属性，点击该链接不会打开这个文件，而是直接下载。虽说是比较好用，但低版本浏览器不兼容，这个在本节的 2 和 3 中将会讲到解决方案。</p><br><p>在这里，我们可以利用&nbsp;<span>属性检测</span>&nbsp;UA 来判断浏览器类型：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">h5Down = document.createElement(&quot;a&quot;).hasOwnProperty(&quot;download&quot;);</span><br><span class="line">var h5Down = !/Trident|MSIE/.test(navigator.userAgent); // Trident 标识 IE11</span><br></pre></td></tr></table></figure>
<p></p><h4>1. a 标签 download 属性的使用</h4><p></p>
<p><strong>注：FF5.0 / Safari5.0 / Opera11.1 / IE9.0 不支持 download 属性</strong></p><br><p>利用 download 属性可以直接下载单个文件，若想点击一次下载多个文件，就得稍加处理下了：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function downloadFile(fileName, content)&#123;</span><br><span class="line">    var aLink = document.createElement(&quot;a&quot;),</span><br><span class="line">        evt = document.createEvent(&quot;HTMLEvents&quot;);</span><br><span class="line"></span><br><span class="line">    evt.initEvent(&quot;click&quot;);</span><br><span class="line">    aLink.download = fileName;</span><br><span class="line">    aLink.href = content;</span><br><span class="line"></span><br><span class="line">    aLink.dispatchEvent(evt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>download 属性的作用除了让浏览器忽略文件的 MIME 类型之外，还会把该属性的值作为文件名。你可以在 chrome 控制台运行这句程序：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">downloadFile(&quot;barretlee.html&quot;, &quot;./&quot;);</span><br></pre></td></tr></table></figure>
<p>浏览器会提示是否保留（下载）该 html 文件。之前我们提到文件类型还可能是 dataURL 或者是 Blob 流，为了让程序也支持这些数据类型，稍微修改下上面的函数：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function downloadFile(fileName, content)&#123;</span><br><span class="line">    var aLink = document.createElement(&apos;a&apos;);</span><br><span class="line">      , blob = new Blob([content])</span><br><span class="line">      , evt = document.createEvent(&quot;HTMLEvents&quot;);</span><br><span class="line"></span><br><span class="line">    evt.initEvent(&quot;click&quot;);</span><br><span class="line"></span><br><span class="line">    aLink.download = fileName;</span><br><span class="line">    aLink.href = URL.createObjectURL(blob);</span><br><span class="line">    aLink.dispatchEvent(evt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>new Blob([content])</code>，现将文件转换成一个 Blog 流，然后，使用 <code>URL.createObjectURL()</code> 将其转换成一个 DOMString。这样我们就支持 data64 和其他数据类型的 content 了~</p><br><h4>2. window.open 之后 execCommand(“SaveAs”)</h4><br><p>上面也提到了，尽管 download 属性是十分便利的 H5 利器，但低版本 IE 根本不赏脸，要说方法，IE 还是有很多方式去转换的，比如 ADOBE.STREAM 的 activeX 对象可以把文件转换成文件流，然后写入到一个要保存的文件中。这里要谈到的是略微方便一点的方式：先把内容写到一个新开的 window 对象中，然后利用 execCommand 执行保存命令，就相当于我们在页面上按下 Ctrl+S，这样页面内的信息都会 down 下来。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 将文件在一个 window 窗口中打开，并隐藏这个窗口。</span><br><span class="line">var win = window.open(&quot;path/to/file.ext&quot;, &quot;new Window&quot;, &quot;width=0,height=0&quot;);</span><br><span class="line">// 在 win 窗口中按下 ctrl+s 保存窗口内容</span><br><span class="line">win.document.execCommand(&quot;SaveAs&quot;, true, &quot;filename.ext&quot;);</span><br><span class="line">// 使用完了，关闭窗口</span><br><span class="line">win.close();</span><br></pre></td></tr></table></figure>
<p>这个过程十分明了，不过这里会存在一个问题，并不是程序的问题，而是浏览器的问题，如果我们用 搜狗浏览器 或者 360浏览器 打开新窗口的话，他会新开一个标签页，而不是新开一个窗口，更可恶的是部分浏览器拦截 window.open 的窗口（这个可以设置）。所以只好另觅他法了。</p><br><h4>3. iframe 中操作</h4><br><p>既然新开一个窗口那么麻烦，我就在本窗口下完成工作~</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function IEdownloadFile(fileName, contentOrPath)&#123;</span><br><span class="line">    var ifr = document.createElement(&apos;iframe&apos;);</span><br><span class="line"></span><br><span class="line">    ifr.style.display = &apos;none&apos;;</span><br><span class="line">    ifr.src = contentOrPath;</span><br><span class="line"></span><br><span class="line">    document.body.appendChild(ifr);</span><br><span class="line"></span><br><span class="line">    // 保存页面 -&gt; 保存文件</span><br><span class="line">    ifr.contentWindow.document.execCommand(&apos;SaveAs&apos;, false, fileName);</span><br><span class="line">    document.body.removeChild(ifr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般的链接我们可以直接给 iframe 添加 src 属性，然后执行 saveAs 命令，倘若我们使用的是 data64 编码的文件，这个怎么办？</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var isImg = contentOrPath.slice(0, 10) === &quot;data:image&quot;；</span><br><span class="line"></span><br><span class="line">// dataURL 的情况</span><br><span class="line">isImg &amp;&amp; ifr.contentWindow.document.write(&quot;&lt;img src=&quot;&quot; +</span><br><span class="line">        contentOrPath + &quot;&quot;&gt;&quot;);</span><br></pre></td></tr></table></figure>
<p>这个也比较好处理，直接把文件写入到 iframe 中，然后在执行保存。</p><br><h3>三、代码的封装与接口介绍</h3><br><h4>1. 代码的封装以及相关 DEMO</h4><br><p>封装：<a href="//github.com/barretlee/javascript-multiple-download/blob/master/lib.js" target="_blank">lib.js</a></p><br><p>DEMO：<a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTPS，第三个有bug)</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://qianduannotes.duapp.com/demo/javascript-multiple-download/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTP，测试正常)</p><br><p>Bug 说明，经过一番细节处理之后，基本兼容各个浏览器，我把代码放在 //raw.github.com 上托管，可能因为是 https 传输，第三个测试中报错了，报错的具体内容是：<span>HTTPS 安全受到 <a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/file/test.jpg" target="_blank" rel="noopener">http://rawgithub.com/barretlee/javascript-multiple-download/master/file/test.jpg</a> 的威胁</span>，而 test.txt 文件没有报错。放到 http 协议下测试运行结果是可观的。（<span>这点我没有去深究，肯定是有深层安全方面原因的，难道就因为他是 jpg图片格式？ </span>&nbsp; 谢&nbsp;<a href="//www.imququ.com/" target="_blank">@屈屈</a><span>&nbsp;</span>提醒，跨协议传输存在安全问题）后面的 demo 我放在 BAE 上，没有问题，不过没测试 safari 和 opera。</p><br><h4>2. 接口的调用</h4><br><p>提供了三个接口，支持单文件下载，多文件下载，多文件下载自定义命名。</p><br><p>1）单文件下载</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Downer(&quot;./file/test.txt&quot;);</span><br></pre></td></tr></table></figure>
<p>2）多文件下载</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Downer([&quot;./file/test.txt&quot;,&quot;./file/test.txt&quot;]);</span><br></pre></td></tr></table></figure>
<p>3）多文件下载自定义命名</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Downer(&#123;</span><br><span class="line">    &quot;1.txt&quot;:&quot;./file/test.txt&quot;,</span><br><span class="line">    &quot;2.jpg&quot;:&quot;./file/test.jpg&quot;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>文件的 URL 如 <code>./file/test.jpg</code> 都可以改成 base64 或者其他格式,如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Downer(&#123;     //这是一个很长的 dataURI，我用负的text-indent隐藏了，可直接复制    &quot;data64.jpg&quot; : &quot;data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wAARCAAYADsDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9NgKKK8w8beO/EMVzGdJ08W2jW2t2WnXGpLdx+e7PPEkii3eJgYj5mwsJFkzkquAC3VFc0lFf10/UOlz1CivO9H+LEmreP7jw8mlBrLfPDa6nC1y0cksX30Z2t1hGCHBEcsjAqQVHOJPCfjnxFc+HNU1rxPpmh6Vp9mt232i01WWXmGV0IdXt0CrhD8+45xnaM4A00uZ9rgtZcq3vb5noFLXCfDz4j3vjbT9XM+hSabqdhtItWFxGswZCybTc28DjJDAkx7fRjzi/qmv6zH8LdR1m6sP+Ef12PSprprPzkufssyxMwXeBtfBA5xg0OLi2n/Vwh+8aUep1gFLXGeKhqmj+FtGmt9fvvtVvfWMc9w0VsWvUkuI43WUeVtAIcnMYQggYI6Hs6lqwk7pPuNrkPEHwn8N+KNRkvdQh1BpZJY7ho7fVru3haWPbslMUcqpvXYhD7d2VU54FFFNNxd1uPyJIfhb4dt/EkOuxwXy6hBNJPD/xNLryImkz5myHzPLUNkllC4J5IyAaWP4W+GY7+/uzp7yy3sc8UiTXc0kUazHdMIo2cpDvPLeWFyeTRRRd9wH6B8NNB8NyapJZx38kmpxrFePe6pdXbTKAQMmaRjkAkZHOMDOAKmbwLp9n8Pp/CGkr/Zmm/wBnyadbjLS+QjIUB+ZstjPdsn1oopOTfUa91prdf1+hFrfhnWNb0HSLCTVrGOaC6tbi+mXT323CwyrJtiXzv3RZkXljJgZ4PWuooopNtkpWVkf/2Q==&quot; &#125;);</span><br></pre></td></tr></table></figure>
<p>&nbsp;这里只做到了 chrome 兼容，IE 下懒得去看了，这个需求很少见！</p><br><h3>四、服务器支持与后端实现</h3><br><h4>1. 后端实现</h4><br><p>不使用前端，直接后端实现的原理，就是在响应头中加入一些特殊的标记，如前端发送这样的请求：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function download(path) &#123;</span><br><span class="line">    var ifrm = document.getElementById(frame);</span><br><span class="line">    ifrm.src = &quot;download.php?path=&quot;+path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后端的响应为</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   header(&quot;Content-Type: application/octet-stream&quot;);</span><br><span class="line">   header(&quot;Content-Disposition: attachment; filename=&quot;.$_GET[&apos;path&apos;]);</span><br><span class="line">   readfile($_GET[&apos;path&apos;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>告诉浏览器这是一个流文件，作为附件方式发送给你，请忽略 MINE type，直接保存。</p><br><h4>2. 服务器配置</h4><br><p>若后台是 apche 作为服务器，可以配置 htaccess 文件：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;filesmatch &quot;\.(zip|rar)$&quot;=&quot;&quot;&gt;</span><br><span class="line">Header set Content-Disposition attachment</span><br><span class="line">&lt;/filesmatch&gt;</span><br></pre></td></tr></table></figure>
<p></p><p>意思是只要请求的是 zip 或者 rar 类型的文件，那么就添加一个 <code>Content-Disposition:attachment</code> 的响应头。这样就可以在 php 代码中省略麻烦的操作。</p><p></p>
<p></p><h3>五、小结</h3><p></p>
<p></p><p>由于行文仓促，文中会有不少错误，对多文件下载有更好的提议，希望提出来共同分享！</p><p></p>
<p></p><p>实现多文件下载的方式肯定不止上面提到的几种，而且我这里封装的代码并没有在FF safari opera 中实现，因为他们还没兼容 download 属性，具体情况可以查看 <a href="http://caniuse.com/#feat=download" target="_blank">caniuse</a>&nbsp;。建议在项目中把这样的事情交给后端，几句代码可以搞定。</p><p></p>
<p></p><h3>六、参考资料</h3><p></p>
<ul><br><li><a href="http://www.alloyteam.com/2014/01/use-js-file-download/" target="_blank">在浏览器端用JS创建和下载文件</a> AlloyTeam</li><br><li><a href="http://thezedienblog.blogspot.com/2013/05/starting-file-download-with-javascript.html" target="_blank">Starting file download with Javascript</a> Ahzaz’s Blog</li><br><li><a href="//developer.mozilla.org/en-US/docs/Web/API/Blob" target="_blank">Blob 流</a> MDN</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.com/2014/01/27/2014-01-27-cb-manufacture-font-face-in-web/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/01/27/2014-01-27-cb-manufacture-font-face-in-web/" class="post-title-link" itemprop="https://handishenniu.com/page/20/index.html">再探@font-face及webIcon制作</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-01-27 01:50:00" itemprop="dateCreated datePublished" datetime="2014-01-27T01:50:00+08:00">2014-01-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/01/27/manufacture-font-face-in-web.html" target="_blank">博客园</a>.</div>

<p></p><p>@font-face 不能说他是什么新东西了，在 CSS2.0 规范中就有了这玩意儿，IE4.0 开始就已经出现，只是当时用的不是特别广泛，后来在 CSS2.1 草案中又被删掉。随着 web 的急速发展，@font-face 价值越来越凸显，然后再次被纳入 CSS3 草案中。@font-face 是个什么东西，本文不做过多说明，不太清楚的童鞋可以看这里 <a href="http://www.w3schools.com/css/css3_fonts.asp" target="_blank">http://www.w3schools.com/css/css3_fonts.asp</a>。需要强调的是他的书写格式：</p><p></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &lt;yourwebfontname&gt;;</span><br><span class="line">    src: &lt;source&gt; [&lt;format&gt;][,&lt;source&gt; [&lt;format&gt;]]*;</span><br><span class="line">    [font-weight: &lt;weight&gt;];</span><br><span class="line">    [font-style: &lt;style&gt;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></p>
<p>举个例子：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: Gentium;</span><br><span class="line">    src: url(http://example.com/fonts/Gentium.woff) format(&quot;woff&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p &#123; font-family: Gentium, serif; &#125;</span><br></pre></td></tr></table></figure>
<p>format 是一个可选参数，他的作用是提示该资源 URI 所引用的字体格式，关于字体格式，可以看下面列表：</p><br><table><br><thead><br><tr><th>format 格式</th><th>Font 格式</th><th>后缀名</th></tr><br></thead><br><tbody><br><tr><br><td>truetype</td><br><td>TrueType</td><br><td>.ttf</td><br></tr><br><tr><br><td>opentype</td><br><td>OpenType</td><br><td>.ttf, .oft</td><br></tr><br><tr><br><td>truetype-aat</td><br><td>TrueType with Apple Advanced Typography extensions</td><br><td>.ttf</td><br></tr><br><tr><br><td>embedded-opentype</td><br><td>Embedded OpenType</td><br><td>.eot</td><br></tr><br><tr><br><td>svg</td><br><td>SVG Font</td><br><td>.svg, .svgz</td><br></tr><br></tbody><br></table><br><p>这堆麻烦的字体格式的出现，是因为各种浏览器对他们的支持程度不一样：</p><br><table><br><thead><br><tr><th>浏览器</th><th>支持类型</th></tr><br></thead><br><tbody><br><tr><br><td>IE6,7,8</td><br><td>仅支持 Embedded OpenType(.eot) 格式。</td><br></tr><br><tr><br><td>Firefox 3.5</td><br><td>支持 TrueType、OpenType(.ttf, .otf) 格式。</td><br></tr><br><tr><br><td>Firefox 3.6</td><br><td>支持 TrueType、OpenType(.ttf, .otf) 及 WOFF 格式。</td><br></tr><br><tr><br><td>Chrome,Safari,Opera</td><br><td>支持 TrueType、OpenType(.ttf, .otf) 及 SVG Font(.svg) 格式。</td><br></tr><br></tbody><br></table><br><p>各浏览器具体的支持情况，可以戳<a href="http://caniuse.com/#feat=fontface" target="_blank">这里</a>。除了可以利用 font-face 引入各种炫酷的字体，还一个比较大的用途是使用它们替换网页图标。下面就说一说 @font-face 在 web 开发中比较有用的 webIcon。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html" target="_blank">http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html</a></p><br><h3>一、fontCreator 制作 webIcon</h3><br><p>这部分说的比较啰嗦，算是一个webicon制作教程吧~ 制作的图片取自张鑫旭大哥的<a href="http://www.zhangxinxu.com/wordpress/2013/12/%E9%91%AB%E8%A1%A8%E6%83%85%E5%8C%85/" target="_blank">鑫表情包</a>~</p><br><p>首先说一说什么是 web icon，可以看看这个页面，<a href="http://fortawesome.github.io/Font-Awesome/" target="_blank">http://fortawesome.github.io/Font-Awesome/</a>，随便瞄准网页上的一个图标，（chrome浏览器）点击右键审查元素，可以看到页面上的图标都没有使用图片，而是用的特殊的字体：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//html</span><br><span class="line">&lt;i class=&quot;fa fa-flag&quot;&gt;&lt;/i&gt;</span><br><span class="line"></span><br><span class="line">//css</span><br><span class="line">.fa-flag:before &#123;</span><br><span class="line">    content: &quot;\f024&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从网页资源列表中可以查看到该网页使用了多种字体：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144014223595.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144014223595.jpg" alt=""></p><br><p>也可以去看看我写的一个 <a href="http://qianduannotes.duapp.com/demo/testFont/index.html" target="_blank">DEMO</a></p><br><h4>1. 编码与webIcon</h4><br><p>编码和字体没有关系，但编码和字符是一一对应的，比如 “\u674e” 对应的是 \李”，”\u9756” 对应的是\靖”。而字体在这里有个什么对应关系呢？不同的字体中显示同一个 unicode 编码，看到的效果是不一样的，我们可以让正楷的 “李” 对应 “\u674e”，也可以用行楷对应，当然我们也可以用一张图片来对应。Web Icon 也就是用图片来对应一些 unicode 码。</p><br><p>但是这里存在一个问题，我们用一张图片来对应 \李” 字，倘若想输入一个正常的\李”字，该怎么去对应呢？ Unicode 包含 0-0x10FFFF 共 1114112 个码位，而汉字占用的码位并不多，只有几千个，在制作 webIcon 时可以选择避开常用的字符集。当然， Unicode 编码也给我们提供了码位的专用区（Pricate Use Area），区间是 E000-F8FF，所以我们可以在这个字符集中放肆 DIY 属于我们自己的字体。</p><br><h4>2. fontCreator 介绍与字体制作</h4><br><p>Web Icon 的制作，网上有很多在线工具，不过这些在线工具都是从已有的图片中选择对应关系，约束性比较大，fontCreator 是一款比较优秀的字体制作工具，它能够很智能的将我们导入的图片转换成黑白色的位图，我们可以编辑和修改各个位图区域，按照自己的意愿 DIY。</p><br><p>打开 fontCreator，新建一个字体：&nbsp;<img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144130009357.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144130009357.jpg" alt="" width="924" height="548"></p><br><p>为了方便演示，我只保留了 A-Z 的字符，其他的全部删除了。</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144347032127.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144347032127.jpg" alt="" width="222" height="435"></p><br><p>选中 A ，右击选择导入图片：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144495005073.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144495005073.jpg" alt="" width="479" height="403"></p><br><p>选择 generate，生成字符内容，然后双击 A，进行细节的编辑（放大，平移）：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145012668077.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145012668077.jpg" alt="" width="495" height="384"></p><br><p>依次处理其他几个字母。Ctrl+S 保存为 barret.ttf。P.S：由于导入表情调整大小位置过于繁琐，我只做了 A-I 这几个码位对应的符号，测试的时候使用字母 A-I 测试即可~</p><br><h4>3. 本地测试</h4><br><p>为了方便本地测试，我们先安装这个字体：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145140786598.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145140786598.jpg" alt=""></p><br><p>打开记事本，选择字体为 barret，字号调大一点，输入 BCDEF 等字符，看看效果：&nbsp;<img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145230473292.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145230473292.jpg" alt=""></p><br><p>是不是惊呆了，呵呵~</p><br><p>字体文件下载：<a href="http://files.cnblogs.com/hustskyking/barret.rar" target="_blank">barret.ttf</a></p><br><h4>4. 网页测试</h4><br><p>网页测试之前，需要先转化下格式，至于原因在前言部分我已经说了。我们拿到的是 ttf 的字体格式，为了兼容所有的浏览器，必须修改进行格式转换。</p><br><p>进入<a href="http://www.fontsquirrel.com/tools/webfont-generator" target="_blank">http://www.fontsquirrel.com/tools/webfont-generator</a>，选择字体，点击 Agreement，然后点击下载字体：&nbsp;<img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145334695039.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145334695039.jpg" alt="" width="619" height="251"></p><br><p>转换的拿到的是下面四个文件：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145469692715.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145469692715.jpg" alt=""></p><br><p>用下面一段代码测试下结果：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;barretregular&apos;;</span><br><span class="line">    src: url(&apos;./font/barret-webfont.eot&apos;);</span><br><span class="line">    src: url(&apos;./font/barret-webfont.eot?#iefix&apos;) format(&apos;embedded-opentype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.woff&apos;) format(&apos;woff&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.ttf&apos;) format(&apos;truetype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.svg#barretregular&apos;) format(&apos;svg&apos;);</span><br><span class="line">    font-weight: normal;</span><br><span class="line">    font-style: normal;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">div &#123;</span><br><span class="line">    font-family: &quot;barretregular&quot;;</span><br><span class="line">    font-size:50px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    B​C​D​E​F​G​H​I</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>也可以直接戳这个 <a href="http://qianduannotes.duapp.com/demo/testFont/index.html" target="_blank">DEMO</a></p><br><p>字体文件下载：<a href="http://files.cnblogs.com/hustskyking/font.rar" target="_blank">barret.ttf and others</a></p><br><h3>二、@font-face细节</h3><br><p>根据 CSS3 草案中的描述，‘@font-face’ 规则允许使用链接到需要时自动激活的字体。这使得用户可以使用在线的字体，而不仅仅拘泥于使用用户端系统内的字体。font-face，拆开来理解，字体的面孔。不管是什么样的面孔，对应的还是同一个码位，而网页设计者需要使用不同的字体来匹配当前的设计。</p><br><h4>1. local()</h4><br><p>上面的教程中我给出了两个测试，一个是本地测试，一个是网页测试，本地测试之前需要先安装字体，如果本地已经有 barret 这个字体了，那我们的程序便没有必要在重新去网络上下载这个字体了。这是 CSS 程序应该这样写：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;barretregular&apos;;</span><br><span class="line">    src: local(&quot;barret&quot;),</span><br><span class="line">         url(&apos;./font/barret.ttf&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在解析的时候，会先从本地查找是否有 barret 字体，如果没有就忽略 local 语句，如果有的话就直接应用，忽略后面的 url 参数。除了获取本地字体的作用之外，他还有另外一个 hack 用途，看下面这段程序：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;barretregular&apos;;</span><br><span class="line">    src: url(&apos;./font/barret-webfont.eot&apos;);</span><br><span class="line">    src: local(&quot;☺&quot;),</span><br><span class="line">         url(&apos;./font/barret-webfont.eot?#iefix&apos;) format(&apos;embedded-opentype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.woff&apos;) format(&apos;woff&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.ttf&apos;) format(&apos;truetype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.svg#barretregular&apos;) format(&apos;svg&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中包含 local(“☺”)，local 中是一个笑脸，很显然，这绝对不是一个字体名字，那他的作用是什么呢？前面我们说了，低版本IE 只支持 eot 文件格式的字体，上面的代码中用到了两个 src，低版本IE会应用第一个 src 的结果，但是，他的解析不会在第一个 src 位置停止，而是继续往后读，看到后面的 src 会发送一个无效的 http 请求。若在 url 前加一个 local 可以阻断这个 http 请求的发送。</p><br><h4>2. unicode-range</h4><br><p>他的作用是定义字体支持的 Unicode 字符范围，以 “U+” 或者 “u+” 开头，默认是 “U+0-10FFFF”。</p><br><p>unicode-range 有三种形式：</p><br><ol><br><li>点，e.g. U+416</li><br><li>分段，e.g. U+400-U+4ff</li><br><li>通配符，e.g. U+4??(U+400-U+4FF)</li><br></ol><br><p>举几个例子：</p><br><ol><br><li>大小写字符以及标点符号<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unicode-range: U+0021-U+007B;</span><br></pre></td></tr></table></figure><br><br></li><br><li>大小写字符和数字<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unicode-range:</span><br><span class="line">    U+0030-U+0039, / 0-9 *</span><br><span class="line">    U+0041-U+005A, / Uppercase A-Z /</span><br><span class="line">    U+0061-U+007A; / Lowercase a-z /</span><br></pre></td></tr></table></figure><br><br></li><br><li>小写字母，大写字母 T，和 “.” 号<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unicode-range:</span><br><span class="line">    U+0054-U+0054, / T /</span><br><span class="line">    U+0061-U+007A, / a-z /</span><br><span class="line">    U+002E-U+002E; / . (period) */</span><br></pre></td></tr></table></figure><br><br></li><br></ol><br><br><br><p>这玩意儿有啥用途呢？</p><br><blockquote><br><p><code>@font-face</code> 有相关属性 <code>unicode-range</code>，可用类似这样的一段 CSS 来指定以中文字体显示弯引号（这是 CSS3 特性，支持还不广泛，但对于这种非关键样式来说够用了）：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &quot;Chinese Quotes&quot;;</span><br><span class="line">    src: local(&quot;Some Chinese Font&quot;);</span><br><span class="line">    unicode-range: U+2018-2019, U+201C-201D;</span><br><span class="line">&#125;</span><br><span class="line">body &#123;</span><br><span class="line">    font-family: &quot;Chinese Quotes&quot;, &quot;Some Latin Font&quot;,</span><br><span class="line">                 &quot;Some Chinese Font&quot;, generic-family;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></p><p>同理，这一招也可以用于破折号、间隔号等和西文标点共享码位的中文标点。</p><br></blockquote><p></p>
<p></p><p>可以戳知乎上的<a href="http://www.zhihu.com/question/20597706" target="_blank">这一贴</a>。</p><p></p>
<p></p><h3>三、优缺点</h3><p></p>
<p></p><p>优点有一大堆，图标的颜色可以随意修改，大小也是可以随便控制的，不需要折腾图片与文字的对齐问题，因为他本身就是文字，还可以使用阴影、文字渐变等 CSS3 的效果，总之就像操作一般字体一样处理他们，该有的特点都有。</p><p></p>
<p></p><p>缺点也是十分明显的，慢速网络以及翻墙代理下情况特别糟糕。外国很多网站的页面都使用了网络字体，而网络字体下载是需要时间的，有些字体可能还比较大，在下载完毕之前，页面有文字的地方都没有渲染出来，体验不好的情况需要等待三五秒中。不过这种情况还是可以优化的，先用一般字体顶替样式，等下载完毕了再利用 JS 来重新渲染，不过这个代码比较高，而且也不好判断何时下载完成了。</p><p></p>
<p></p><h3>四、小结</h3><p></p>
<p></p><p>本文的目的是展示 web icon 的从无到有的一个过程，一些网站提供了很多不错的 webIcon 字库，如果有需求可以直接去网站上下载，自己制作的话成本太高。</p><p></p>
<p></p><h3>五、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/css3-fonts/#the-font-face-rule" target="_blank">http://www.w3.org/TR/css3-fonts/#the-font-face-rule</a> W3.ORG</li><br><li><a href="http://www.w3help.org/zh-cn/causes/RF1001" target="_blank">http://www.w3help.org/zh-cn/causes/RF1001</a> W3Help</li><br><li><a href="http://www.php100.com/manual/css3_0/@font-face.shtml" target="_blank">http://www.php100.com/manual/css3_0/@font-face.shtml</a> Font-Face</li><br><li><a href="http://www.fontsquirrel.com/fontface/generator" target="_blank">http://www.fontsquirrel.com/fontface/generator</a> Tool</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Lion</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">273</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">84</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">215</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lion</span>

  

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  

  

  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  

  

  

  

  

  

  

  <script src="/js/src/music/aplayer.js?v=6.6.0"></script>
  <script src="/js/src/music/init.js?v=6.6.0"></script>
</body>
</html>
