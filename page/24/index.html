<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
































<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=6.6.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="撼地神牛">
<meta property="og:url" content="https://handishenniu.coding.me/blog/page/24/index.html">
<meta property="og:site_name" content="撼地神牛">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="撼地神牛">






  <link rel="canonical" href="https://handishenniu.coding.me/blog/page/24/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>撼地神牛</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?304ebec1c594afeac3282f7afb1f3448";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <meta name="baidu-site-verification" content="mI6O7pmEdr">
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
    
    
    
    <a href="https://github.com/lystdio" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">撼地神牛</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/blog/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/blog/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/blog/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/blog/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/blog/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/blog/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

    <a href="https://github.com/lystdio" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/02/27/2014-02-27-cb-webAudio-cross-fading/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/02/27/2014-02-27-cb-webAudio-cross-fading/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">声道的转换</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-27 01:17:00" itemprop="dateCreated datePublished" datetime="2014-02-27T01:17:00+08:00">2014-02-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/27/webAudio-cross-fading.html" target="_blank">博客园</a>.</div>

<p>本系列文章主要是介绍 Web Audio API 的相关知识，以及 web语音通信 中会遇到的一些问题，阐述可能存在错误，还请多多斧正！</p><br><p>很多粤语剧都提供了两个声道，一个左声道为粤语，一个右声道有国语。观看者可以自由切换声道，那么切换声道的原理是什么呢？在播放器中，只需要把不同的声道切换到声轨就行了，因为有左右两个声道，所以播放器至少是包含两个声轨的。如果我们想听粤语，只需要将右声道声轨的声音设置为 0，或者临时删掉右声道声轨。本文主要是利用 GainNode 节点控制音量的属性实现两个音轨之间的相互切换，Cross-fading 的意思可以在后面的 DEMO 中用耳朵体会出来~</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-cross-fading.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/webAudio-cross-fading.html</a>，转载请注明源地址。</p><br><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><br><h3>一、两个声音之间的声轨切换</h3><br><h4>1. 原理介绍</h4><br><p>在一个 AudioContext 中可以输入多个音频流，而这些音频流在 AudioContext 这个环境中辗转反侧，最后的出路也就是 DestinationNode：</p><br><blockquote><br><p>source 1 —+</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |—-&gt; Destination</p><br><p>source 2 —+</p><br></blockquote><br><p>而要实现上面两个声轨的切换，实则是它容易了，我们可以在他们到达 Destination 之前，加一个 GainNode，<a href="http://www.cnblogs.com/hustskyking/admin/webAudio-volume" target="_blank" rel="noopener">上文</a> 已经对 GainNode 做了详细的说明，本文就不继续赘述了。</p><br><h4>2. DEMO 演示</h4><br><p>首先要创建两个音频，平时我们都是使用 audio 节点带上 src 属性，插入到 DOM 中让其自动播放音频，本文将使用其他的方式拿到音频流：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var tank = new Audio(&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;);</span><br></pre></td></tr></table></figure>
<p>我准备了两个音频，一个是 tankWar.mp3 ，经典的坦克大战开场音乐，另一个是 SuperMario.mp3，超级玛丽的背景音乐，前者稍微短一些，所以在播放的时候将其设定为循环播放：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tank.loop = true;</span><br></pre></td></tr></table></figure>
<p>然后利用 createMediaElementSource 这个函数从 Media 中获取到音频流：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var source1 = context.createMediaElementSource(tank);</span><br></pre></td></tr></table></figure>
<p>过程十分简单，整个 AudioContext 的连接模型为：</p><br><blockquote><br><p>source 1 –&gt; GainNode 1 -+</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|—-&gt; Destination</p><br><p>source 2 –&gt; GainNode 2 -+</p><br></blockquote><br><p>然后用同一个控制棒来控制 GainNode 1 和 2。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; id=&quot;volume&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var tank = new Audio(&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;);</span><br><span class="line">    tank.loop = true;</span><br><span class="line">    var mario = new Audio(&quot;http://qianduannotes.duapp.com/file/SuperMario.mp3&quot;);</span><br><span class="line">    mario.loop = true;</span><br><span class="line"></span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source1 = context.createMediaElementSource(tank);</span><br><span class="line">    var source2 = context.createMediaElementSource(mario);</span><br><span class="line">    var gain1 = context.createGain();</span><br><span class="line">    var gain2 = context.createGain();</span><br><span class="line">    //连接：source → gain → destination</span><br><span class="line">    source1.connect(gain1);</span><br><span class="line">    source2.connect(gain2);</span><br><span class="line">    gain1.connect(context.destination);</span><br><span class="line">    gain2.connect(context.destination);</span><br><span class="line">    //音量控制</span><br><span class="line">    var value;</span><br><span class="line">    onload = volume.onchange = function()&#123;</span><br><span class="line">      gain1.gain.value = volume.value / 100;</span><br><span class="line">      gain2.gain.value = 1 - volume.value / 100;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    tank.onload = mario.onlond = function()&#123;</span><br><span class="line">        console.log(&quot;var1, var2&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    tank.play();</span><br><span class="line">    mario.play();</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>代码没有封装，写的稍微有些乱，不过看了之前的说明，应该可以理解这段代码~</p><br><h4>3. 效果增强</h4><br><p>上面的音量控制，我使用的是线性控制：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gain1.gain.value = volume.value / 100;</span><br><span class="line">gain2.gain.value = 1 - volume.value / 100;</span><br></pre></td></tr></table></figure>
<p>效果并不是特别好，他对音量的控制如下图：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/27/271310073679049.png" data-source="http://images.cnitblog.com/blog/387325/201402/271310073679049.png" alt=""></p><br><p>稍微修改下控制函数：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var vol = volume.value / 100;</span><br><span class="line">gain1.gain.value = Math.cos(vol * 0.5 * Math.PI);</span><br><span class="line">gain2.gain.value = Math.cos((1.0 - vol) * 0.5 * Math.PI);</span><br></pre></td></tr></table></figure>
<p></p><p>可以感受到音量的变化是这样的：</p><p></p>
<p></p><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/27/271310163176584.png" data-source="http://images.cnitblog.com/blog/387325/201402/271310163176584.png" alt=""></p><p></p>
<p></p><p>详情可以戳这个demo：<a href="http://qianduannotes.duapp.com/demo/audio/" target="_blank">http://qianduannotes.duapp.com/demo/audio/</a></p><p></p>
<p></p><h3>二、小结</h3><p></p>
<p></p><p>本文的目的是介绍 Web Audio API 的 GainNode 节点的使用，并将此应用到声道的切换之中，上面的例子不能算是严格的声道切换，但如果我们只给 volume 参数设定 0 ,50, 100 这三个值，那效果跟声道的切换就差不多了~</p><p></p>
<p></p><p>由于这几篇文章都是关于 Node 之间的相互连接，技术含量并不多，主要是读懂 API 以及相关使用方法。行文仓促，如有错误地方，还请斧正！</p><p></p>
<p></p><h3>三、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><br><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/02/26/2014-02-26-cb-webAudio-volume/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/02/26/2014-02-26-cb-webAudio-volume/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">音量的控制</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-26 12:56:00" itemprop="dateCreated datePublished" datetime="2014-02-26T12:56:00+08:00">2014-02-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/26/webAudio-volume.html" target="_blank">博客园</a>.</div>

<p>改变音频的音量是音频处理中最基础的部分，我们可以利用 GainNode 来构建 Mixers 的结构块。GainNode 的接口是很简单的：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface GainNode : AudioNode &#123;</span><br><span class="line">    readonly attribute AudioParam gain;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过调节 GainNode.gain.value 就可以实现音频大小的调控了。下文会先介绍使用 Processor 来处理，这是一个最通用的节点，可以处理很多东西。在上文<a href="http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html" target="_blank">看得到的音频流</a>中我们也使用了该节点。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-volume.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/webAudio-volume.html</a>，转载请注明源地址。</p><br><p><strong>P.S：请在较新版的 chrome 火狐 Firefox 中测试。</strong></p><br><h3>一、音频流音量大小的控制</h3><br><h4>1. 使用 Processor 处理</h4><br><p>这个过程比较简单：</p><br><blockquote><br><p>source Node -&gt; Processor Node -&gt; Destination Node</p><br></blockquote><br><p>数据送入到 Processor 后，由于输入 channel 和输出的 channel 之间的对应关系需要我们自己去处理，这些对应关系可以在 onaudioprocess 事件中处理，只要上面的连接导通，那这个事件就一直会处于触发状态，无论是否有数据流送入（其实没有数据流送入也就是数据流 bufferArray 为 0 嘛）。</p><br><p>可以看下面这个 DEMO：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;audio&quot; autoplay&gt;&lt;/audio&gt;</span><br><span class="line">&lt;input type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; id=&quot;volume&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source = context.createMediaElementSource(audio);</span><br><span class="line">    // 低通滤波节点（高频信号被过滤，听到的声音会很沉闷）</span><br><span class="line">    var processor = context.createScriptProcessor(1024, 1, 1);</span><br><span class="line">    // sourceNode - &gt; processor -&gt; destinationNode</span><br><span class="line">    source.connect(processor);</span><br><span class="line">    processor.connect(context.destination);</span><br><span class="line">    //处理过程</span><br><span class="line">    processor.onaudioprocess = function(e)&#123;</span><br><span class="line">      //获取输入和输出的数据缓冲区</span><br><span class="line">      var input = e.inputBuffer.getChannelData(0);</span><br><span class="line">      var output = e.outputBuffer.getChannelData(0);</span><br><span class="line">      //将输入数缓冲复制到输出缓冲上，并调整音量</span><br><span class="line">      for(var  i =0; i &lt; input.length; i++)</span><br><span class="line">            output[i] = input[i] * value;</span><br><span class="line">    &#125;;</span><br><span class="line">    //音量控制</span><br><span class="line">    var value;</span><br><span class="line">    onload = volume.onchange = function()&#123;</span><br><span class="line">      value = volume.value / 200;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p><h4>2. 使用 GainNode 控制</h4><p></p>
<p>上面这种方式，我们可以在 onaudioprocess 事件中拿到几乎我们想要的所有数据，并且可以进行各种处理，可以说 processor 这个节点十分通用，但他的性能并不是高，你应该也看到了上面的代码中有：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//将输入数缓冲复制到输出缓冲上，并调整音量  </span><br><span class="line">for(var  i =0; i &lt; input.length; i++)</span><br><span class="line">    output[i] = input[i] * value;</span><br></pre></td></tr></table></figure>
<p>需要将数据一一复制到输出节点，上面 demo 中我们设定的 bufferSize 是 1024 ，如果再大一些，或者文中需要处理的节点数太多，那页面将会很卡。Web Audio API 中提供了提供音量的节点，GainNode，既然提供了，毫无疑问，就用它呗~</p><br><p>节点连接方式也是十分的方便：</p><br><blockquote><br><p>source → gain → destination</p><br></blockquote><br><p>然后通过一个 range 控件来调节 Gain 的 gain 参数。DEMO如下：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;audio&quot; autoplay&gt;&lt;/audio&gt;</span><br><span class="line">&lt;input type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; id=&quot;volume&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source = context.createMediaElementSource(audio);</span><br><span class="line">    var Gain = context.createGain();</span><br><span class="line">    //连接：source → Gain → destination</span><br><span class="line">    source.connect(Gain);</span><br><span class="line">    Gain.connect(context.destination);</span><br><span class="line">    //音量控制</span><br><span class="line">    var value;</span><br><span class="line">    onload = volume.onchange = function()&#123;</span><br><span class="line">      gain.gain.value = volume.value / 200;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p><p>十分轻松简洁的处理一个音量控制。</p><p></p>
<p></p><h3>二、小结</h3><p></p>
<p></p><p>本文主要是介绍 Web Audio API 中的 GainNode 节点，以及相关的应用。文中的两个 DEMO ，前者利用 processor 节点来处理，关于这个几点的说明，可以参考上两篇文章的接受；后者是使用 GainNode ，通过控制 Gain.gain.value 的值来调节音量的大小，过程十分简单，所以本文的思路也是比较的清晰。</p><p></p>
<p></p><p>如果本文中有叙述不正确的地方，还请斧正！</p><p></p>
<p></p><h3>三、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><br><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/02/22/2014-02-22-cb-webAudio-show-audio/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/02/22/2014-02-22-cb-webAudio-show-audio/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">看得到的音频流</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-22 08:45:00" itemprop="dateCreated datePublished" datetime="2014-02-22T08:45:00+08:00">2014-02-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/22/webAudio-show-audio.html" target="_blank">博客园</a>.</div>

<p><a href="http://www.cnblogs.com/hustskyking/p/webAudio-listen.html" target="_blank">上文</a>介绍了 Web Audio API 的相关知识，以及如何在你的 web 程序中引入 音频流，内容都是介绍性的，所以没有写太多 DEMO。本文重点讲解如何利用 Web Audio API 中的中间节点拿到音频信号的信息，并将信息转化成信号图绘制到 canvas 中。</p><br><p>从上文中我们了解到，AudioContext 是音频播放和处理的一个环境，大概的流程是这个样子：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  +---------------+------------------------------------+</span><br><span class="line">  | AudioContext  |                                    |</span><br><span class="line">  +---------------+                                    |</span><br><span class="line">  |        +-------+    +-------+    +-------+         |</span><br><span class="line">  |        |       |    |       |    |       |         |</span><br><span class="line">==========&gt;| Source|===&gt;|Lots of|===&gt;|  Dest | Output  |</span><br><span class="line">Multi Input|       |    |       |    |       |===========&gt;</span><br><span class="line">==========&gt;|  Node |===&gt;| Nodes |===&gt;|  Node |         |</span><br><span class="line">  |        |       |    |       |    |       |         |</span><br><span class="line">  |        +-------+    +-------+    +-------+         |</span><br><span class="line">  |                         |                          |</span><br><span class="line">  |                         |    Created By Barret Lee |</span><br><span class="line">  +-------------------------|--------------------------+</span><br><span class="line">                            |         +-------------+</span><br><span class="line">                            +========&gt;| Other Tools |</span><br><span class="line">                              signal  +-------------+</span><br></pre></td></tr></table></figure>
<p>在 AudioContext 中，通过一个结点（AudioNode）来接受输入源，中间的一些结点可以过滤、放大、去杂等处理 Source Node 的信号，处理之后可以送到 AudioContext 的输出结点，然后启用 <code>source.start()</code> 播放音频信息；也可以将处理的信息送到外部交给其他对象来处理，比如本文要谈到的，将信号交给 Canvas 来处理，这样就能看到音频信号的波形图了。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html" target="_blank">http://www.cnblogs.com/hustskyking/p/webAudio-show-audio.html</a>，转载请注明源地址。</p><br><p><strong>注：较新版 Google Chrome 和 Firefox 才能运行本文中的 DEMO。</strong></p><br><h3>一、节点的连接</h3><br><p>先说一说，各个节点在 AudioContext 中的连接是如何用代码实现的:</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 创建一个 AudioContext 环境</span><br><span class="line">var context = new AudioContext();</span><br><span class="line"></span><br><span class="line">function playSound() &#123;</span><br><span class="line">    // 创建一个 Source 节点</span><br><span class="line">    var source = context.createBufferSource();</span><br><span class="line">    // 拿到输入源（狗吠）</span><br><span class="line">    source.buffer = dogBarkingBuffer;</span><br><span class="line">    // 将 source 节点链接到 destination 节点（输出节点）</span><br><span class="line">    source.connect(context.destination);</span><br><span class="line">    // currentTime 设定为 0，开始播放</span><br><span class="line">    source.start(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的连接十分简单，直接将 source 节点连接到 destination 节点，相当于没有经过人任何处理，直接输出了，而下面的方式是创建一个中间节点，对信号做一些处理，不过在拿到 Source 的方式上跟上面有些不一样：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var audio = document.getElementsByTagName(&quot;audio&quot;)[0];</span><br><span class="line">// context 为一个 AudioContext 环境</span><br><span class="line">// 从 audio 元素中拿到输入源，也就是上图所看到的 Mutil Input</span><br><span class="line">var source = context.createMediaElementSource(audio);</span><br><span class="line">// 建立一个处理延时节点</span><br><span class="line">var delayNode = context.createDelay();</span><br><span class="line">// sourceNode -&gt; delayNode -&gt; destinationNode</span><br><span class="line">source.connect(delayNode);</span><br><span class="line">delayNode.connect(context.destination);</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是，destination 是 AudioContext 实例的固有属性，他就是信号的最终汇聚的位置，也是信号的输出位置。下面是一个简单的 DEMO 代码：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;origin&quot;&gt;&lt;/audio&gt;</span><br><span class="line">&lt;audio src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot; id=&quot;audio&quot;&gt;&lt;/audio&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;origin.play()&quot; value=&quot;原始音质 播放&quot;&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;origin.pause()&quot; value=&quot;原始音源 暂停&quot;&gt;&lt;br&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;audio.play()&quot; value=&quot;滤波音质 播放&quot;&gt;</span><br><span class="line">&lt;input type=&quot;button&quot; onclick=&quot;audio.pause()&quot; value=&quot;滤波音源 暂停&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var AudioContext = AudioContext || webkitAudioContext;</span><br><span class="line">    var context = new AudioContext();</span><br><span class="line">    var source = context.createMediaElementSource(audio);</span><br><span class="line">    // 低通滤波节点（高频信号被过滤，听到的声音会很沉闷）</span><br><span class="line">    var FilterNode = context.createBiquadFilter(&quot;lowpass&quot;);</span><br><span class="line">    // sourceNode -&gt; FilterNode -&gt; destinationNode</span><br><span class="line">    source.connect(FilterNode);</span><br><span class="line">    FilterNode.connect(context.destination);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>上面的代码，AudioContext 获取 audio 源的原理是这样的：</p><br><ol><br><li>audio有一个内置的输出通道</li><br><li>AudioContext 通过 createMediaElementSource 将 audio 的输出直接拉去到新的环境中，之前 audio 环境被破坏</li><br><li>拉去的 source 没有 start 函数，他会一直监听 audio 的操控，当 play 函数被触发的时候，开始播放音频。也可以认为，play 函数触发了 start （老版浏览器中是 noteOn）</li><br></ol><br><p>下面是一个演示图：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+----------+------------------------------+</span><br><span class="line">| audio    |                              |</span><br><span class="line">+----------+                              |</span><br><span class="line">|     +--------+      //  +-------------+ |</span><br><span class="line">|     | Source |=====//==&gt;| Destination | |</span><br><span class="line">|     +--------+  | //    +-------------+ |</span><br><span class="line">|                 |                       |</span><br><span class="line">+-----------------|-----------------------+</span><br><span class="line">                  |   Created By Barret Lee</span><br><span class="line">         +--------|-----+--------------------------+</span><br><span class="line">         |        ↓                                |</span><br><span class="line">         |     +--------+    +-------+    +------+ |</span><br><span class="line">         |     | Source |===&gt;| Nodes |===&gt;| Dest | |</span><br><span class="line">         |     +--------+    +-------+    +------+ |</span><br><span class="line">         |                          +--------------+</span><br><span class="line">         |                          | AudioContext |</span><br><span class="line">         +--------------------------+--------------+</span><br></pre></td></tr></table></figure>
<p></p><h3>二、两个中间节点的介绍</h3><p></p>
<p></p><h4>1. ScriptProcessorNode</h4><p></p>
<p>我们可以直接使用 JavaScript 操控这个节点，他的作用是产生、传递、分析一段音频。他有一个 bufferSize 属性和一个 onaudioprocess 事件。初始化一个 ScriptProcessorNode：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var processor=context.createScriptProcessor(4096, 1, 1);</span><br></pre></td></tr></table></figure>
<p>他接收三个参数，第一个是 bufferSize 的大小，取值范围是 <code>Math.pow(2, N) ( 8&le;N&le;14 )</code>，第二个参数是送入的 channel 数，第三个参数是输出的 channel 数。信息不会自动通过这个节点需要我们自己将输入的信号复制到输出位置去：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">processor.onaudioprocess = function(e)&#123;</span><br><span class="line">    //获取输入和输出的数据缓冲区</span><br><span class="line">    var input = e.inputBuffer.getChannelData(0);</span><br><span class="line">    var output = e.outputBuffer.getChannelData(0);</span><br><span class="line"></span><br><span class="line">    //将输入数缓冲复制到输出缓冲上</span><br><span class="line">    for(var i = 0, len = input.length; i &lt; len; i++)&#123;</span><br><span class="line">        output[i] = input[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样处理的原因是因为多个输入要对应对个输出，也有可能是多对一或者一对多，所以这些信息的设定必须要人为去控制。</p><br><p>关于 ScriptProcessorNode 的介绍，具体请移步<a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode-section" target="_blank">http://www.w3.org/TR/webaudio/#ScriptProcessorNode-section</a></p><br><h4>2. AnalyserNode</h4><br><p>通过这个节点我们可以对信号进行频域和时域上的分析，学过 通信原理 的同学对这些属于应该是十分熟悉的。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">interface AnalyserNode : AudioNode &#123;</span><br><span class="line"></span><br><span class="line">    // Real-time frequency-domain data </span><br><span class="line">    void getFloatFrequencyData(Float32Array array);</span><br><span class="line">    void getByteFrequencyData(Uint8Array array);</span><br><span class="line"></span><br><span class="line">    // Real-time waveform data </span><br><span class="line">    void getByteTimeDomainData(Uint8Array array);</span><br><span class="line"></span><br><span class="line">    attribute unsigned long fftSize;</span><br><span class="line">    readonly attribute unsigned long frequencyBinCount;</span><br><span class="line"></span><br><span class="line">    attribute double minDecibels;</span><br><span class="line">    attribute double maxDecibels;</span><br><span class="line"></span><br><span class="line">    attribute double smoothingTimeConstant;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面是这个节点的接口信息，不要感到奇怪，对接口的描述，都是使用这种方式，从上面我们可以看到，他有三个方法，四个属性。fftSize 是指频率分析下的快速傅里叶变换大小，他的值被限定在 32-2048 的 2 的整数次方。</p><br><p>关于 AnalyserNode 的介绍，具体请移步<a href="http://www.w3.org/TR/webaudio/#AnalyserNode-section" target="_blank">http://www.w3.org/TR/webaudio/#AnalyserNode-section</a></p><br><h3>三、音频信息的提取</h3><br><p>利用上面介绍的两个节点可以十分轻松的提取到音频信息，如使用 ScriptProcessorNode，在他的 onaudioprocess 触发的时候，可以拿到 input 信息，此时也就是音频信息流。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">processor.onaudioprocess = function(e)&#123;</span><br><span class="line">    //获取输入和输出的数据缓冲区</span><br><span class="line">    var input = e.inputBuffer.getChannelData(0);</span><br><span class="line"></span><br><span class="line">    doSomething(input);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面这种方式拿到数据的效率是比较低的，一般可以直接使用 AnalyserNode 节点。这个节点中一个获取缓冲数据区的方法叫做 getByteTimeDomainData，这个方法的设计是十分偏底层的，或者对 JSer 来说，这个借口的设计并不合理，可以看看：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//以fftSize为长度创建一个字节数组作为数据缓冲区</span><br><span class="line">var output = new Uint8Array(analyser.fftSize);</span><br><span class="line">// 将获取得到的数据赋值给 output</span><br><span class="line">analyser.getByteTimeDomainData(output);</span><br></pre></td></tr></table></figure>
<p>这里是把 output 作为引用传进 getByteTimeDomainData 函数中，相信大家应该没有在 JS 中遇到过这样的写法吧~ （我觉得在该 web 标准定稿的时候，这里一定会做修改！）</p><br><h3>四、信号图的绘制</h3><br><p>上面我们已经拿到了信号数据了，绘制工作其实就是 canvas 的事情啦~</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var width = canvas.width,</span><br><span class="line">    height = canvas.height,</span><br><span class="line">    g = canvas.getContext(&quot;2d&quot;);</span><br><span class="line"></span><br><span class="line">// 将坐标原点移动到(0.5, height / 2 + 0.5)的位置</span><br><span class="line">g.translate(0.5, height / 2 + 0.5);</span><br></pre></td></tr></table></figure>
<p>然后绘制图形：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">processor.onaudioprocess=function(e)&#123;</span><br><span class="line">    //获取输入和输出的数据缓冲区</span><br><span class="line">    var input = e.inputBuffer.getChannelData(0);</span><br><span class="line">    var output = e.outputBuffer.getChannelData(0);</span><br><span class="line">    //将输入数缓冲复制到输出缓冲上</span><br><span class="line">    for(var i=0; i</span><br><span class="line">&lt;p&gt;下面是整个 DEMO 的代码，效果预览：&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;img src=&quot;//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png&quot; data-original=&quot;/blogimgs/2014/02/22/222051302848233.jpg&quot; data-source=&quot;http://images.cnitblog.com/blog/387325/201402/222051302848233.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;代码：&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<p><canvas id="canvas" width="400" height="100"></canvas></p>
<p><audio id="audio" autoplay src="http://qianduannotes.duapp.com/file/tankWar.mp3"></audio><br><br></p>
<p><input type="button" onclick="audio.play()" value="播放"></p>
<p><input type="button" onclick="audio.pause()" value="暂停"></p>
<script>
var AudioContext=AudioContext||webkitAudioContext;
var context=new AudioContext;
//从元素创建媒体节点
var media=context.createMediaElementSource(audio);
//创建脚本处理节点
var processor=context.createScriptProcessor(4096,1,1);
//Canvas初始化
var width=canvas.width,height=canvas.height;
var g=canvas.getContext("2d");
g.translate(0.5,height/2+0.5);
//连接：媒体节点→控制节点→输出源
media.connect(processor);
processor.connect(context.destination);
//控制节点的过程处理
processor.onaudioprocess=function(e){
  //获取输入和输出的数据缓冲区
  var input=e.inputBuffer.getChannelData(0);
  var output=e.outputBuffer.getChannelData(0);
  //将输入数缓冲复制到输出缓冲上
  for(var i=0;i<input.length;i++)output[i]=input[i];
  //将缓冲区的数据绘制到Canvas上
  g.clearRect(-0.5,-height/2-0.5,width,height);
  g.beginPath();
  for(var i=0;i<width;i++)
    g.lineTo(i,height/2*output[output.length*i/width|0]);
  g.stroke();
};
</script>

<p>DEMO<br><code>`</code></p>
<p></p><p>该段代码引自次碳酸钴的<a href="http://www.web-tinker.com/article/20498.html" target="_blank">博客</a>。</p><p></p>
<p></p><h3>五、小结</h3><p></p>
<p></p><p>本文着重讲述了 AudioContext 内部节点之间的交互原理，以及如何使用节点获取数据，关于图形的绘制是 canvas 的操作，不是本系列文章的重点，所以一笔带过。</p><p></p>
<p></p><p>如果文中有叙述不正确的地方，还请斧正！</p><p></p>
<p></p><h3>六、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3C Group</li><br><li><a href="http://www.web-tinker.com/" target="_blank">http://www.web-tinker.com/</a> 次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/02/20/2014-02-20-cb-webAudio-listen/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/02/20/2014-02-20-cb-webAudio-listen/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">让音乐响起来</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-20 12:47:00" itemprop="dateCreated datePublished" datetime="2014-02-20T12:47:00+08:00">2014-02-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/20/webAudio-listen.html" target="_blank">博客园</a>.</div>

<p>本系列文章主要是介绍 Web Audio API 的相关知识，由于该技术还处在 web 草案阶段（很多标准被提出来，至于取舍需要等待稳定版文档来确定，草案阶段的文档很多都会被再次编辑甚至重写、全部删除等，不适合作为正式参考），很多 API 都是未确定的，目前支持 Web Audio API 的浏览器是较新版的 Google Chrome 和 FireFox，其他浏览器暂时还没有兼容。</p><br><p>现在的网络硬件环境还没有达到普遍语音通信的条件，但是 web语音通信 一定会成为后期 web 研究的一个重要话题，凭着一点个人兴趣，拿出来研究研究~</p><br><p>本文主要介绍 Web Audio API 的相关特性，以及音频源的获取方式。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/webAudio-listen.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/webAudio-listen.html</a>，转载请注明源地址。</p><br><h3>一、Web Audio</h3><br><p>在 <code>&lt;audio&gt;</code> 标签的到来之前，Flash 以及其他的插件相继打破 web 的宁静，而如今 audio 被送到了 web 开发之中，我们再也不需要引用各种插件来播放声音了。</p><br><h4>1. Web Audio API 的特性</h4><br><p>Web Audio API 是 JavaScript 中主要用于在网页应用中处理音频请求的一个高级应用接口，这个 API 目的是用于让最新技术与传统的游戏音频引擎的综合处理相兼容，也即尽力提供一些桌面音频处理程序的要求。</p><br><ul><br><li>查看音频播放期间调度事件发生的确切时间；</li><br><li>支持各种类型的音频过滤波器以实现各种效果，包括回声、消除噪音等；</li><br><li>支持利用合成声音（Sound synthesis）创建电子音乐；</li><br><li>支持3D位置音频模拟效果，比如某种声音随着游戏场景而移动；</li><br><li>支持外部输入的声音与 WebRTC 进行集成（调用 WebRTC ，在你的设备中增添吉他声），或者在 WebRTC 中调用其他地方传输过来的声音；</li><br><li>利用音频数据分析创造良好的可视化声音等。</li><br></ul><br><h4>2. AudioContent 简介</h4><br><p>Web Audio API 可以用来操作或者播放网页以及应用中的 audio 资源，在一个 Audio上下文环境（AudioContext）中，有各种 Audio节点（AudioNode），如：</p><br><table><br><thead><br><tr><th>Interface</th><th>description</th></tr><br></thead><br><tbody><br><tr><br><td>AudioContext</td><br><td>包含表示连接中间件 AudioNodes 的音频信号曲线图</td><br></tr><br><tr><br><td>AudioNode</td><br><td>表示 audio源，audio输出以及 中间处理模块，他处在 AudioContext 的上下文中</td><br></tr><br><tr><br><td>AudioDestinationNode</td><br><td>他是 AudioNode 的一个子类，表示所有被渲染音频流到达的最终地点</td><br></tr><br><tr><br><td>AudioBuffer</td><br><td>表示 audio资源 的一个临时缓存，可表示一个音频剪辑</td><br></tr><br><tr><br><td>AudioBufferSourceNode</td><br><td>从 AudioBuffer 中生成 audio 的 AudioNode 节点</td><br></tr><br><tr><br><td>ScriptProcessorNode</td><br><td>一个可以直接被 JS 操作的 AudioNode 节点</td><br></tr><br><tr><br><td>GainNode</td><br><td>音频增益节点</td><br></tr><br><tr><br><td>OscillatorNode</td><br><td>一个可产生固定频率的 audio 源</td><br></tr><br></tbody><br></table><br><p>还有其他的 API 可以查看<a href="http://www.w3.org/TR/webaudio/#APIOverview" target="_blank">http://www.w3.org/TR/webaudio/#APIOverview</a>.</p><br><p>使用 AudioContext 实例，我们可以将生成的一个或者多个音频流连接到声音的输出位置，这个连接并不一定是直接送到输出端，期间可以使用 AudioNodes 作为中继器和处理器，让这些声音信号有一个更好的效果。</p><br><p>单个 AudioContext 实例可以支持多音频的输入，所以对于一个 audio 应用我们只需要创建一个实例就行了。很多诸如创建一个 AudioNode 节点、解码音频文件等方法都是 AudioContext 的内置方法。创建一个 AudioContext 上下文也十分简单：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var context;</span><br><span class="line">try&#123;</span><br><span class="line">    window.AudioContext = window.AudioContext || window.webkitAudioContext;</span><br><span class="line">    context = new AudioContext();</span><br><span class="line">&#125;</span><br><span class="line">catch(e) &#123;</span><br><span class="line">    alert(&apos;请更新至最新版的 Chrome 或者 Firefox&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></p><h3>二、音频流的获取</h3><p></p>
<p></p><h4>1. 标签引入</h4><p></p>
<p>标签引入是最直接的方式，</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio autoplay src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;&gt;</span><br><span class="line">    浏览器不支持 audio 标签。</span><br><span class="line">&lt;/audio&gt;</span><br></pre></td></tr></table></figure>
<p>如果浏览器不支持 audio 标签，便会将其当做一个普通元素来解析，中间一行字也就会被显示出来。而支持 audio 标签的浏览器会忽略标签内任何文本。我们还可以为他加上 autoplay 、loop 等属性，使音频在进入页面之后立即循环播放。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio autoplay=&quot;autoplay&quot; controls=&quot;controls&quot; src=&quot;http://qianduannotes.duapp.com/file/tankWar.mp3&quot;&gt;</span><br><span class="line">    浏览器不支持 audio 标签。</span><br><span class="line">&lt;/audio&gt;</span><br></pre></td></tr></table></figure>
<p>controls 属性是用来控制显示音频文件的控制部分的。默认未设置 controls 属性。</p><br><h4>2. <span>webRTC mediaStream</span>&nbsp;Media Capture <span>(多谢<a href="http://www.cnblogs.com/hehe123/" target="_blank">@Hehe123</a>提醒,RTC属于通信了，此处只是获取 media 流)</span></h4><br><p>利用 getUserMedia 拿到本地的音频流。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 前缀处理</span><br><span class="line">window.AudioContext = window.AudioContext ||</span><br><span class="line">                  window.webkitAudioContext;</span><br><span class="line">navigator.getUserMedia =  navigator.getUserMedia ||</span><br><span class="line">                      navigator.webkitGetUserMedia ||</span><br><span class="line">                      navigator.mozGetUserMedia ||</span><br><span class="line">                      navigator.msGetUserMedia;</span><br><span class="line"></span><br><span class="line">var context = new AudioContext();</span><br><span class="line"></span><br><span class="line">navigator.getUserMedia(&#123;audio: true&#125;, function(stream) &#123;</span><br><span class="line">  // 获取本地流送入 AudioContext</span><br><span class="line">  var microphone = context.createMediaStreamSource(stream);</span><br><span class="line"></span><br><span class="line">  // filter为一个中间处理器，用来过滤音频</span><br><span class="line">  var filter = context.createBiquadFilter();</span><br><span class="line"></span><br><span class="line">  // microphone -&gt; filter -&gt; destination.</span><br><span class="line">  microphone.connect(filter);</span><br><span class="line">  filter.connect(context.destination);</span><br><span class="line">&#125;, function()&#123;</span><br><span class="line">    console.log(&quot;出了点问题~ 是否在服务器环境下运行？&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是，使用 webRTC 需要在服务器环境下，你可以搭建一个本地服务器，也可以把代码上传到远程服务器上测试。</p><br><h4>3. FileSystem</h4><br><p>选择本地文件，读取音频流，拿到 Blob 流地址，送入 audio 中</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;file&quot; onchange=&quot;return run(this.files);&quot;&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">&lt;audio controls id=&quot;audio&quot;&gt;&lt;/audio&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    function run(files)&#123;</span><br><span class="line">        var blob = window.webkitURL.createObjectURL(files[0]);</span><br><span class="line">        audio.src = blob;</span><br><span class="line">        audio.autoplay = &quot;autoplay&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p><h4>4. 移动设备，还可以使用如下方式</h4><p></p>
<p>1）HTML Media Capture</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;file&quot; accept=&quot;audio/*;capture=microphone&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>2）device 元素</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;device type=&quot;media&quot; onchange=&quot;update(this.data)&quot;&gt;&lt;/device&gt;</span><br><span class="line">&lt;audio autoplay&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  function update(stream) &#123;</span><br><span class="line">    document.querySelector(&apos;audio&apos;).src = stream.url;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p></p>
<p></p><h4>5. 从键盘获取</h4><p></p>
<p>本质并不是从键盘获取，而是通过键盘获取到我们设定的频率值，然后通过程序创建一段音频。如下面的程序：</p><br><p><span>下面例子中可以按键盘上中间的一排按键（A到K）来发出不同的声音。</span></p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var AudioContext=AudioContext||webkitAudioContext;</span><br><span class="line">var context=new AudioContext;</span><br><span class="line">//为每个键盘位对应一个频率</span><br><span class="line">var s=&#123;65:256,83:288,68:320,70:341,71:384,72:426,74:480,75:512&#125;;</span><br><span class="line">//为每个频率创建一个Oscillator</span><br><span class="line">for(var i in s)</span><br><span class="line">  value=s[i],</span><br><span class="line">  s[i]=context.createOscillator(),</span><br><span class="line">  s[i].frequency.value=value,</span><br><span class="line">  s[i].start();</span><br><span class="line">//键盘按下时将相应频率的Oscillator连接到输出源上</span><br><span class="line">addEventListener(&quot;keydown&quot;,function(e)&#123;</span><br><span class="line">  if(e=s[e.keyCode])e.connect(context.destination);</span><br><span class="line">&#125;);</span><br><span class="line">//键盘松开时将相应频率的Oscillator的连接取消</span><br><span class="line">addEventListener(&quot;keyup&quot;,function(e)&#123;</span><br><span class="line">  if(e=s[e.keyCode])e.disconnect();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p></p><p>这段代码引自次碳酸钴的<a href="http://www.web-tinker.com/article/20497.html" target="_blank">博客</a>.</p><p></p>
<p></p><h3>三、小结</h3><p></p>
<p></p><p>本文是个介绍性的文章，提到了 Web Audio API 的相关知识，以及如何在你的 web 程序中引入 音频流。没有写相关 demo，感兴趣的童鞋可以复制代码自己去测试，在后续文章中会给出测试 DEMO。</p><p></p>
<p></p><h3>四、参考文章</h3><p></p>
<ul><br><li><a href="http://www.csdn.net/article/2013-07-10/2816178-Web-Audio-API-Firefox" target="_blank">http://www.csdn.net/article/2013-07-10/2816178-Web-Audio-API-Firefox</a> CSND</li><br><li><a href="//hacks.mozilla.org/2013/07/web-audio-api-comes-to-firefox/">//hacks.mozilla.org/2013/07/web-audio-api-comes-to-firefox/</a> Mozilla</li><br><li><a href="http://www.html5rocks.com/en/tutorials/webaudio/intro/#toc-context" target="_blank">http://www.html5rocks.com/en/tutorials/webaudio/intro/#toc-context</a> html5rocks</li><br><li><a href="http://www.w3.org/TR/webaudio/" target="_blank">http://www.w3.org/TR/webaudio/</a> W3 Group</li><br><li><a href="http://www.web-tinker.com/article/20497.html" target="_blank">http://www.web-tinker.com/article/20497.html</a>&nbsp;次碳酸钴</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/02/17/2014-02-17-cb-problem-javascript-event/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/02/17/2014-02-17-cb-problem-javascript-event/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">JavaScript事件机制</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-17 09:18:00" itemprop="dateCreated datePublished" datetime="2014-02-17T09:18:00+08:00">2014-02-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/17/problem-javascript-event.html" target="_blank">博客园</a>.</div>

<p>群里童鞋问到关于事件传播的一个问题：\事件捕获的时候，阻止冒泡，事件到达目标之后，还会冒泡吗？”。</p><br><p>初学 JS 的童鞋经常会有诸多疑问，我在很多 QQ 群也混了好几年了，耳濡目染也也收获了不少，以后会总结下问题的结论，顺便说说相关知识的扩展~</p><br><p>如果贸然回答还会冒泡，这不太好的，稍微严谨点考虑 0级 DOM 事件模型的话，这个答案是否定的。但是在 2级 DOM 事件模型中，答案是肯定的，这个问题值得探讨记录下。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html" target="_blank" rel="noopener">http://www.cnblogs.com/hustskyking/p/problem-javascript-event.html</a>&nbsp;</p><br><h3>一、问题结论</h3><br><p>netscape 和 微软 曾经的战争还是比较火热的，当时， netscape 主张捕获方式，微软主张冒泡方式。后来 w3c 采用折中的方式，平息了战火，制定了统一的标准&mdash;&mdash;先捕获再冒泡。</p><br><div><strong>&nbsp;事件的触发有三个阶段</strong><ol><br><li>document&nbsp;往事件触发地点，捕获前进，遇到相同注册事件立即触发执行</li><br><li>到达事件位置，触发事件（多谢&nbsp;<span>@糖果果&nbsp;<span>指出&nbsp;<a href="#2878498">问题</a>&nbsp;，</span></span><span>@update 14/2/19</span> 如果该处既注册了冒泡事件，也注册了捕获事件，按照注册顺序执行）</li><br><li>事件触发地点往 document 方向，冒泡前进，遇到相同注册事件立即触发</li><br></ol><br><p>这么说很多人比较迷糊，我们在注册事件的时候，通常使用的是 捕获 或者 冒泡 的 一种：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj.addEventListener(&quot;click&quot;, func, true); // 捕获方式</span><br><span class="line">obj.addEventListener(&quot;click&quot;, func, false); // 冒泡方式</span><br></pre></td></tr></table></figure>
<p>事件只会因为捕获或者冒泡触发一次。举个栗子：</p><br><p><strong><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172047332617225.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172047332617225.jpg" alt=""></strong></p><br><p>点击 s2，结果是：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172049374659103.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172049374659103.jpg" alt=""></p><br><p>因为这里采用的是捕获模式，从 document 往 s2 走，依次发现 s1 和 s2 都有注册捕获事件，于是便触发了，然后冒泡，没找到冒泡事件，不执行任何操作。如果将 true 改成 false，可以看到结果相反。为了更好的让你理解整个事件机制，我给他们的捕获和冒泡模式下都注册事件：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172057001398575.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172057001398575.jpg" alt=""></p><br><p>结果真是太清晰了：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172057281606167.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172057281606167.jpg" alt=""></p>


<p></p><h3>二、误区</h3><p></p>
<p>指出两个误区。</p><br><p><strong>1. 在同一个对象上注册事件，并不一定按照注册顺序执行</strong></p><br><p>这一点，从上面的例子可以看出，你随便打乱四个事件绑定的顺序，结果一般不变！出现这样结果的原因是存在捕获模式和冒泡模式。但是值得注意的是，下面 #5楼 @糖果果 提出的问题，之所以如此是因为事件目的地节点既绑定了冒泡事件也绑定了捕获事件，此时的执行顺序按照绑定的先后顺序执行（情况比较少见）。</p><br><p><strong>2.event.stopPropagation();就是阻止事件的冒泡</strong></p><br><p>这个表述不能说他错误，但是是不完整的，他除了阻止事件的冒泡，还阻止事件的继续捕获，简而言之就是阻止事件的进一步传播。下面的例子可以看到：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172104390057858.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172104390057858.jpg" alt=""></p><br><p>结果是输出了 s1.</p>


<p></p><h3>三、拓展</h3><p></p>
<p><strong>1.&nbsp;stopImmediatePropagation 的使用</strong></p><br><p>这玩意儿是 w3c 的东西，使用的也不是特别多，我们知道 stopPropagation 可以阻止事件的进一步传播，但是他阻止不了该元素上绑定的其他函数的执行，比如我们在 obj 上绑定了 func1 和 func2，如果我们在 func1 中使用了&nbsp;stopPropagation ，那 func2 依然还是会执行出来。倘若这里使用&nbsp;stopImmediatePropagation，结果就不一样了，他不仅阻止事件的传播，还阻止 func2 的执行。如：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172112453398807.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172112453398807.jpg" alt=""></p><br><p>结果是：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172113011073790.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172113011073790.jpg" alt=""></p><br><p>而改成evt.stopImmediatePropagation();之后，阻止了第二个监听事件的触发：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172113246634621.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172113246634621.jpg" alt=""></p><br><p>结果是：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/02/17/172113354087200.jpg" data-source="http://images.cnitblog.com/blog/387325/201402/172113354087200.jpg" alt=""></p><br><p><strong>2. setCapture 和 releaseCapture</strong></p><br><p>这两个是 IE 下的事件绑定函数，只要我们在某个元素上 setCapture 了，那么你在任何地方的鼠标操作（mouseXXX之类的动作）都会在这个元素上触发（前提是你在这个元素上绑定了事件），releaseCapture 或者本窗口失去聚焦才会释放这个绑定~</p>


<p></p><h3>四、小结</h3><p></p>
<p>对于此类知识的学习，应该查阅官方点的文档，或者看看《JavaScript权威指南》的解说，后期会经常整理诸如此类的问题。若有疑问，可以在下方评论中提出。</p>


<p></p></div><p></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/02/12/2014-02-12-cb-multiple-download-with-javascript/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/02/12/2014-02-12-cb-multiple-download-with-javascript/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">JavaScript多文件下载</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-02-12 09:50:00" itemprop="dateCreated datePublished" datetime="2014-02-12T09:50:00+08:00">2014-02-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/02/12/multiple-download-with-javascript.html" target="_blank">博客园</a>.</div>

<p>对于文件的下载，可以说是一个十分常见的话题，前端的很多项目中都会有这样的需求，比如 highChart 统计图的导出，在线图片编辑中的图片保存，在线代码编辑的代码导出等等。而很多时候，我们只给了一个链接，用户需要右键点击链接，然后选择\另存为”，这个过程虽说不麻烦，但还是需要两步操作，倘若用户想保存页面中的多个链接文件，就得重复操作很多次，最常见的就是英语听力网站上的音频下载，手都要点麻！</p><br><p>本文的目的是介绍如何利用 javascript 进行多文件的下载，也就是当用户点击某个链接或者按钮的时候，同时下载多个文件。这里的\同时”用的不是很准确，在现代浏览器中可以实现多文件的并行下载，而在一些老版本浏览器，如IE8-，此类的浏览器就只能进行单个文件的下载，但是我们可以让多个文件依次保存下来，算是串行下载吧~</p><br><p>若要要无视实现细节，可以直接跳到第三部分，或者戳：</p><br><p>代码封装：<a href="//github.com/barretlee/javascript-multiple-download/blob/master/lib.js" target="_blank">lib.js</a></p><br><p>DEMO：<a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTPS，第三个有bug，具体原因下面有说明)</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://qianduannotes.duapp.com/demo/javascript-multiple-download/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTP，测试正常)</p>


<p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/multiple-download-with-javascript.html" target="_parent">http://www.cnblogs.com/hustskyking/p/multiple-download-with-javascript.html</a>，转载请保留原文地址。</p><br><h3>一、文件类型介绍及其特点</h3><br><h4>1. 一般类型</h4><br><p>平时比较常见的有 txt、png、jpg、zip、tar 等各种文件格式，这些文件格式中，一部分浏览器是会直接打开链接显示内容的，而另外一部分，浏览器不识别响应头，或者不能解析对应的格式，于是当做文件直接下载下来了。如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;http://barretlee.com/test.rar&quot;&gt;file&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>这句代码，若直接点开链接，浏览器将会直接下载该文件。</p><br><h4>2. dataURL类型</h4><br><p>dataURL 也是十分常见的类型，他可以作为 src 或者 url() 的参数送进去。比较常见的有如下几种：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">文本： data:text/plain;这里是正文内容。</span><br><span class="line">图片： data:image/jpg;base64,/9j/4AAQSkZJRgABAQEA....</span><br><span class="line">       data:image/png;base64,/9j/4AAQSkZJRgABAQEA....</span><br></pre></td></tr></table></figure>
<p>base64 是用的比较广泛的一种数据格式。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Base64格式</span><br><span class="line">data:[][;charset=][;base64],</span><br><span class="line">Base64 在CSS中的使用：</span><br><span class="line">.demoImg&#123; background-image: url(&quot;data:image/jpg;base64,/9j/4QMZRXhpZgAASUkqAAgAAAAL....&quot;); &#125;</span><br><span class="line">Base64 在HTML中的使用：</span><br><span class="line">&lt;img width=&quot;40&quot; height=&quot;30&quot; src=&quot;data:image/jpg;base64,/9j/4QMZRXhpZgAASUkqAAgAAAAL....&quot;&gt;</span><br></pre></td></tr></table></figure>
<p></p><h4>3. Blob 流</h4><p></p>
<p>Blob 对象表示不可变的、包含原始数据的类文件对象。具体的内容可以参阅<a href="//developer.mozilla.org/en-US/docs/Web/API/Blob" target="_blank">MDN文档</a>。</p><br><p>他的使用也是特别的方便，如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var aFileParts = [&apos;&lt;a id=&quot;a&quot;&gt;&lt;b id=&quot;b&quot;&gt;hey!&lt;/b&gt;&lt;/a&gt;&apos;];</span><br><span class="line">var oMyBlob = new Blob(aFileParts, &#123;type : &apos;text/html&apos;&#125;); // the blob</span><br></pre></td></tr></table></figure>
<p>Blob 接收两个参数，一个是数组类型的数据对象，他可以是 ArrayBuffer、ArrayBufferView、Blob、String 等诸多类型；第二个参数是 MINE 类型设置。而本文我们要用到的是 <code>URLcreateObjectURL()</code> 这个函数，他的作用是将一个 URL 所代表的内容转化成一个 <a href="//developer.mozilla.org/en-US/docs/Web/API/DOMString" target="_blank">DOMString</a>，产生的结果是一个 文件对象 或者 Blob 对象。</p><br><h4>4. 二进制流</h4><br><p>我们利用 File API 读取文件的时候，拿到的是数据的二进制流格式，这些类型可以直接被 ArrayBuffer 等接收，本文中没有用到，就不细说了。</p><br><h3>二、JavaScript 多文件下载</h3><br><p>HTML5 中 a 标签多了一个属性&mdash;&mdash;download，用户点击链接浏览器会打开并显示该链接的内容，若在链接中加了 download 属性，点击该链接不会打开这个文件，而是直接下载。虽说是比较好用，但低版本浏览器不兼容，这个在本节的 2 和 3 中将会讲到解决方案。</p><br><p>在这里，我们可以利用&nbsp;<span>属性检测</span>&nbsp;UA 来判断浏览器类型：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">h5Down = document.createElement(&quot;a&quot;).hasOwnProperty(&quot;download&quot;);</span><br><span class="line">var h5Down = !/Trident|MSIE/.test(navigator.userAgent); // Trident 标识 IE11</span><br></pre></td></tr></table></figure>
<p></p><h4>1. a 标签 download 属性的使用</h4><p></p>
<p><strong>注：FF5.0 / Safari5.0 / Opera11.1 / IE9.0 不支持 download 属性</strong></p><br><p>利用 download 属性可以直接下载单个文件，若想点击一次下载多个文件，就得稍加处理下了：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function downloadFile(fileName, content)&#123;</span><br><span class="line">    var aLink = document.createElement(&quot;a&quot;),</span><br><span class="line">        evt = document.createEvent(&quot;HTMLEvents&quot;);</span><br><span class="line"></span><br><span class="line">    evt.initEvent(&quot;click&quot;);</span><br><span class="line">    aLink.download = fileName;</span><br><span class="line">    aLink.href = content;</span><br><span class="line"></span><br><span class="line">    aLink.dispatchEvent(evt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>download 属性的作用除了让浏览器忽略文件的 MIME 类型之外，还会把该属性的值作为文件名。你可以在 chrome 控制台运行这句程序：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">downloadFile(&quot;barretlee.html&quot;, &quot;./&quot;);</span><br></pre></td></tr></table></figure>
<p>浏览器会提示是否保留（下载）该 html 文件。之前我们提到文件类型还可能是 dataURL 或者是 Blob 流，为了让程序也支持这些数据类型，稍微修改下上面的函数：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function downloadFile(fileName, content)&#123;</span><br><span class="line">    var aLink = document.createElement(&apos;a&apos;);</span><br><span class="line">      , blob = new Blob([content])</span><br><span class="line">      , evt = document.createEvent(&quot;HTMLEvents&quot;);</span><br><span class="line"></span><br><span class="line">    evt.initEvent(&quot;click&quot;);</span><br><span class="line"></span><br><span class="line">    aLink.download = fileName;</span><br><span class="line">    aLink.href = URL.createObjectURL(blob);</span><br><span class="line">    aLink.dispatchEvent(evt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>new Blob([content])</code>，现将文件转换成一个 Blog 流，然后，使用 <code>URL.createObjectURL()</code> 将其转换成一个 DOMString。这样我们就支持 data64 和其他数据类型的 content 了~</p><br><h4>2. window.open 之后 execCommand(“SaveAs”)</h4><br><p>上面也提到了，尽管 download 属性是十分便利的 H5 利器，但低版本 IE 根本不赏脸，要说方法，IE 还是有很多方式去转换的，比如 ADOBE.STREAM 的 activeX 对象可以把文件转换成文件流，然后写入到一个要保存的文件中。这里要谈到的是略微方便一点的方式：先把内容写到一个新开的 window 对象中，然后利用 execCommand 执行保存命令，就相当于我们在页面上按下 Ctrl+S，这样页面内的信息都会 down 下来。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 将文件在一个 window 窗口中打开，并隐藏这个窗口。</span><br><span class="line">var win = window.open(&quot;path/to/file.ext&quot;, &quot;new Window&quot;, &quot;width=0,height=0&quot;);</span><br><span class="line">// 在 win 窗口中按下 ctrl+s 保存窗口内容</span><br><span class="line">win.document.execCommand(&quot;SaveAs&quot;, true, &quot;filename.ext&quot;);</span><br><span class="line">// 使用完了，关闭窗口</span><br><span class="line">win.close();</span><br></pre></td></tr></table></figure>
<p>这个过程十分明了，不过这里会存在一个问题，并不是程序的问题，而是浏览器的问题，如果我们用 搜狗浏览器 或者 360浏览器 打开新窗口的话，他会新开一个标签页，而不是新开一个窗口，更可恶的是部分浏览器拦截 window.open 的窗口（这个可以设置）。所以只好另觅他法了。</p><br><h4>3. iframe 中操作</h4><br><p>既然新开一个窗口那么麻烦，我就在本窗口下完成工作~</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function IEdownloadFile(fileName, contentOrPath)&#123;</span><br><span class="line">    var ifr = document.createElement(&apos;iframe&apos;);</span><br><span class="line"></span><br><span class="line">    ifr.style.display = &apos;none&apos;;</span><br><span class="line">    ifr.src = contentOrPath;</span><br><span class="line"></span><br><span class="line">    document.body.appendChild(ifr);</span><br><span class="line"></span><br><span class="line">    // 保存页面 -&gt; 保存文件</span><br><span class="line">    ifr.contentWindow.document.execCommand(&apos;SaveAs&apos;, false, fileName);</span><br><span class="line">    document.body.removeChild(ifr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般的链接我们可以直接给 iframe 添加 src 属性，然后执行 saveAs 命令，倘若我们使用的是 data64 编码的文件，这个怎么办？</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var isImg = contentOrPath.slice(0, 10) === &quot;data:image&quot;；</span><br><span class="line"></span><br><span class="line">// dataURL 的情况</span><br><span class="line">isImg &amp;&amp; ifr.contentWindow.document.write(&quot;&lt;img src=&quot;&quot; +</span><br><span class="line">        contentOrPath + &quot;&quot;&gt;&quot;);</span><br></pre></td></tr></table></figure>
<p>这个也比较好处理，直接把文件写入到 iframe 中，然后在执行保存。</p><br><h3>三、代码的封装与接口介绍</h3><br><h4>1. 代码的封装以及相关 DEMO</h4><br><p>封装：<a href="//github.com/barretlee/javascript-multiple-download/blob/master/lib.js" target="_blank">lib.js</a></p><br><p>DEMO：<a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTPS，第三个有bug)</p><br><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://qianduannotes.duapp.com/demo/javascript-multiple-download/test/test.html" target="_blank">javascript-multiple-download</a>&nbsp;(HTTP，测试正常)</p><br><p>Bug 说明，经过一番细节处理之后，基本兼容各个浏览器，我把代码放在 //raw.github.com 上托管，可能因为是 https 传输，第三个测试中报错了，报错的具体内容是：<span>HTTPS 安全受到 <a href="http://rawgithub.com/barretlee/javascript-multiple-download/master/file/test.jpg" target="_blank" rel="noopener">http://rawgithub.com/barretlee/javascript-multiple-download/master/file/test.jpg</a> 的威胁</span>，而 test.txt 文件没有报错。放到 http 协议下测试运行结果是可观的。（<span>这点我没有去深究，肯定是有深层安全方面原因的，难道就因为他是 jpg图片格式？ </span>&nbsp; 谢&nbsp;<a href="//www.imququ.com/" target="_blank">@屈屈</a><span>&nbsp;</span>提醒，跨协议传输存在安全问题）后面的 demo 我放在 BAE 上，没有问题，不过没测试 safari 和 opera。</p><br><h4>2. 接口的调用</h4><br><p>提供了三个接口，支持单文件下载，多文件下载，多文件下载自定义命名。</p><br><p>1）单文件下载</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Downer(&quot;./file/test.txt&quot;);</span><br></pre></td></tr></table></figure>
<p>2）多文件下载</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Downer([&quot;./file/test.txt&quot;,&quot;./file/test.txt&quot;]);</span><br></pre></td></tr></table></figure>
<p>3）多文件下载自定义命名</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Downer(&#123;</span><br><span class="line">    &quot;1.txt&quot;:&quot;./file/test.txt&quot;,</span><br><span class="line">    &quot;2.jpg&quot;:&quot;./file/test.jpg&quot;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>文件的 URL 如 <code>./file/test.jpg</code> 都可以改成 base64 或者其他格式,如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Downer(&#123;     //这是一个很长的 dataURI，我用负的text-indent隐藏了，可直接复制    &quot;data64.jpg&quot; : &quot;data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wAARCAAYADsDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9NgKKK8w8beO/EMVzGdJ08W2jW2t2WnXGpLdx+e7PPEkii3eJgYj5mwsJFkzkquAC3VFc0lFf10/UOlz1CivO9H+LEmreP7jw8mlBrLfPDa6nC1y0cksX30Z2t1hGCHBEcsjAqQVHOJPCfjnxFc+HNU1rxPpmh6Vp9mt232i01WWXmGV0IdXt0CrhD8+45xnaM4A00uZ9rgtZcq3vb5noFLXCfDz4j3vjbT9XM+hSabqdhtItWFxGswZCybTc28DjJDAkx7fRjzi/qmv6zH8LdR1m6sP+Ef12PSprprPzkufssyxMwXeBtfBA5xg0OLi2n/Vwh+8aUep1gFLXGeKhqmj+FtGmt9fvvtVvfWMc9w0VsWvUkuI43WUeVtAIcnMYQggYI6Hs6lqwk7pPuNrkPEHwn8N+KNRkvdQh1BpZJY7ho7fVru3haWPbslMUcqpvXYhD7d2VU54FFFNNxd1uPyJIfhb4dt/EkOuxwXy6hBNJPD/xNLryImkz5myHzPLUNkllC4J5IyAaWP4W+GY7+/uzp7yy3sc8UiTXc0kUazHdMIo2cpDvPLeWFyeTRRRd9wH6B8NNB8NyapJZx38kmpxrFePe6pdXbTKAQMmaRjkAkZHOMDOAKmbwLp9n8Pp/CGkr/Zmm/wBnyadbjLS+QjIUB+ZstjPdsn1oopOTfUa91prdf1+hFrfhnWNb0HSLCTVrGOaC6tbi+mXT323CwyrJtiXzv3RZkXljJgZ4PWuooopNtkpWVkf/2Q==&quot; &#125;);</span><br></pre></td></tr></table></figure>
<p>&nbsp;这里只做到了 chrome 兼容，IE 下懒得去看了，这个需求很少见！</p><br><h3>四、服务器支持与后端实现</h3><br><h4>1. 后端实现</h4><br><p>不使用前端，直接后端实现的原理，就是在响应头中加入一些特殊的标记，如前端发送这样的请求：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function download(path) &#123;</span><br><span class="line">    var ifrm = document.getElementById(frame);</span><br><span class="line">    ifrm.src = &quot;download.php?path=&quot;+path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后端的响应为</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   header(&quot;Content-Type: application/octet-stream&quot;);</span><br><span class="line">   header(&quot;Content-Disposition: attachment; filename=&quot;.$_GET[&apos;path&apos;]);</span><br><span class="line">   readfile($_GET[&apos;path&apos;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>告诉浏览器这是一个流文件，作为附件方式发送给你，请忽略 MINE type，直接保存。</p><br><h4>2. 服务器配置</h4><br><p>若后台是 apche 作为服务器，可以配置 htaccess 文件：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;filesmatch &quot;\.(zip|rar)$&quot;=&quot;&quot;&gt;</span><br><span class="line">Header set Content-Disposition attachment</span><br><span class="line">&lt;/filesmatch&gt;</span><br></pre></td></tr></table></figure>
<p></p><p>意思是只要请求的是 zip 或者 rar 类型的文件，那么就添加一个 <code>Content-Disposition:attachment</code> 的响应头。这样就可以在 php 代码中省略麻烦的操作。</p><p></p>
<p></p><h3>五、小结</h3><p></p>
<p></p><p>由于行文仓促，文中会有不少错误，对多文件下载有更好的提议，希望提出来共同分享！</p><p></p>
<p></p><p>实现多文件下载的方式肯定不止上面提到的几种，而且我这里封装的代码并没有在FF safari opera 中实现，因为他们还没兼容 download 属性，具体情况可以查看 <a href="http://caniuse.com/#feat=download" target="_blank">caniuse</a>&nbsp;。建议在项目中把这样的事情交给后端，几句代码可以搞定。</p><p></p>
<p></p><h3>六、参考资料</h3><p></p>
<ul><br><li><a href="http://www.alloyteam.com/2014/01/use-js-file-download/" target="_blank">在浏览器端用JS创建和下载文件</a> AlloyTeam</li><br><li><a href="http://thezedienblog.blogspot.com/2013/05/starting-file-download-with-javascript.html" target="_blank">Starting file download with Javascript</a> Ahzaz’s Blog</li><br><li><a href="//developer.mozilla.org/en-US/docs/Web/API/Blob" target="_blank">Blob 流</a> MDN</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/01/27/2014-01-27-cb-manufacture-font-face-in-web/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/01/27/2014-01-27-cb-manufacture-font-face-in-web/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">再探@font-face及webIcon制作</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-01-27 01:50:00" itemprop="dateCreated datePublished" datetime="2014-01-27T01:50:00+08:00">2014-01-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/01/27/manufacture-font-face-in-web.html" target="_blank">博客园</a>.</div>

<p></p><p>@font-face 不能说他是什么新东西了，在 CSS2.0 规范中就有了这玩意儿，IE4.0 开始就已经出现，只是当时用的不是特别广泛，后来在 CSS2.1 草案中又被删掉。随着 web 的急速发展，@font-face 价值越来越凸显，然后再次被纳入 CSS3 草案中。@font-face 是个什么东西，本文不做过多说明，不太清楚的童鞋可以看这里 <a href="http://www.w3schools.com/css/css3_fonts.asp" target="_blank">http://www.w3schools.com/css/css3_fonts.asp</a>。需要强调的是他的书写格式：</p><p></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &lt;yourwebfontname&gt;;</span><br><span class="line">    src: &lt;source&gt; [&lt;format&gt;][,&lt;source&gt; [&lt;format&gt;]]*;</span><br><span class="line">    [font-weight: &lt;weight&gt;];</span><br><span class="line">    [font-style: &lt;style&gt;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></p>
<p>举个例子：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: Gentium;</span><br><span class="line">    src: url(http://example.com/fonts/Gentium.woff) format(&quot;woff&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p &#123; font-family: Gentium, serif; &#125;</span><br></pre></td></tr></table></figure>
<p>format 是一个可选参数，他的作用是提示该资源 URI 所引用的字体格式，关于字体格式，可以看下面列表：</p><br><table><br><thead><br><tr><th>format 格式</th><th>Font 格式</th><th>后缀名</th></tr><br></thead><br><tbody><br><tr><br><td>truetype</td><br><td>TrueType</td><br><td>.ttf</td><br></tr><br><tr><br><td>opentype</td><br><td>OpenType</td><br><td>.ttf, .oft</td><br></tr><br><tr><br><td>truetype-aat</td><br><td>TrueType with Apple Advanced Typography extensions</td><br><td>.ttf</td><br></tr><br><tr><br><td>embedded-opentype</td><br><td>Embedded OpenType</td><br><td>.eot</td><br></tr><br><tr><br><td>svg</td><br><td>SVG Font</td><br><td>.svg, .svgz</td><br></tr><br></tbody><br></table><br><p>这堆麻烦的字体格式的出现，是因为各种浏览器对他们的支持程度不一样：</p><br><table><br><thead><br><tr><th>浏览器</th><th>支持类型</th></tr><br></thead><br><tbody><br><tr><br><td>IE6,7,8</td><br><td>仅支持 Embedded OpenType(.eot) 格式。</td><br></tr><br><tr><br><td>Firefox 3.5</td><br><td>支持 TrueType、OpenType(.ttf, .otf) 格式。</td><br></tr><br><tr><br><td>Firefox 3.6</td><br><td>支持 TrueType、OpenType(.ttf, .otf) 及 WOFF 格式。</td><br></tr><br><tr><br><td>Chrome,Safari,Opera</td><br><td>支持 TrueType、OpenType(.ttf, .otf) 及 SVG Font(.svg) 格式。</td><br></tr><br></tbody><br></table><br><p>各浏览器具体的支持情况，可以戳<a href="http://caniuse.com/#feat=fontface" target="_blank">这里</a>。除了可以利用 font-face 引入各种炫酷的字体，还一个比较大的用途是使用它们替换网页图标。下面就说一说 @font-face 在 web 开发中比较有用的 webIcon。</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html" target="_blank">http://www.cnblogs.com/hustskyking/p/manufacture-font-face-in-web.html</a></p><br><h3>一、fontCreator 制作 webIcon</h3><br><p>这部分说的比较啰嗦，算是一个webicon制作教程吧~ 制作的图片取自张鑫旭大哥的<a href="http://www.zhangxinxu.com/wordpress/2013/12/%E9%91%AB%E8%A1%A8%E6%83%85%E5%8C%85/" target="_blank">鑫表情包</a>~</p><br><p>首先说一说什么是 web icon，可以看看这个页面，<a href="http://fortawesome.github.io/Font-Awesome/" target="_blank">http://fortawesome.github.io/Font-Awesome/</a>，随便瞄准网页上的一个图标，（chrome浏览器）点击右键审查元素，可以看到页面上的图标都没有使用图片，而是用的特殊的字体：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//html</span><br><span class="line">&lt;i class=&quot;fa fa-flag&quot;&gt;&lt;/i&gt;</span><br><span class="line"></span><br><span class="line">//css</span><br><span class="line">.fa-flag:before &#123;</span><br><span class="line">    content: &quot;\f024&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从网页资源列表中可以查看到该网页使用了多种字体：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144014223595.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144014223595.jpg" alt=""></p><br><p>也可以去看看我写的一个 <a href="http://qianduannotes.duapp.com/demo/testFont/index.html" target="_blank">DEMO</a></p><br><h4>1. 编码与webIcon</h4><br><p>编码和字体没有关系，但编码和字符是一一对应的，比如 “\u674e” 对应的是 \李”，”\u9756” 对应的是\靖”。而字体在这里有个什么对应关系呢？不同的字体中显示同一个 unicode 编码，看到的效果是不一样的，我们可以让正楷的 “李” 对应 “\u674e”，也可以用行楷对应，当然我们也可以用一张图片来对应。Web Icon 也就是用图片来对应一些 unicode 码。</p><br><p>但是这里存在一个问题，我们用一张图片来对应 \李” 字，倘若想输入一个正常的\李”字，该怎么去对应呢？ Unicode 包含 0-0x10FFFF 共 1114112 个码位，而汉字占用的码位并不多，只有几千个，在制作 webIcon 时可以选择避开常用的字符集。当然， Unicode 编码也给我们提供了码位的专用区（Pricate Use Area），区间是 E000-F8FF，所以我们可以在这个字符集中放肆 DIY 属于我们自己的字体。</p><br><h4>2. fontCreator 介绍与字体制作</h4><br><p>Web Icon 的制作，网上有很多在线工具，不过这些在线工具都是从已有的图片中选择对应关系，约束性比较大，fontCreator 是一款比较优秀的字体制作工具，它能够很智能的将我们导入的图片转换成黑白色的位图，我们可以编辑和修改各个位图区域，按照自己的意愿 DIY。</p><br><p>打开 fontCreator，新建一个字体：&nbsp;<img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144130009357.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144130009357.jpg" alt="" width="924" height="548"></p><br><p>为了方便演示，我只保留了 A-Z 的字符，其他的全部删除了。</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144347032127.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144347032127.jpg" alt="" width="222" height="435"></p><br><p>选中 A ，右击选择导入图片：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270144495005073.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270144495005073.jpg" alt="" width="479" height="403"></p><br><p>选择 generate，生成字符内容，然后双击 A，进行细节的编辑（放大，平移）：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145012668077.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145012668077.jpg" alt="" width="495" height="384"></p><br><p>依次处理其他几个字母。Ctrl+S 保存为 barret.ttf。P.S：由于导入表情调整大小位置过于繁琐，我只做了 A-I 这几个码位对应的符号，测试的时候使用字母 A-I 测试即可~</p><br><h4>3. 本地测试</h4><br><p>为了方便本地测试，我们先安装这个字体：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145140786598.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145140786598.jpg" alt=""></p><br><p>打开记事本，选择字体为 barret，字号调大一点，输入 BCDEF 等字符，看看效果：&nbsp;<img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145230473292.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145230473292.jpg" alt=""></p><br><p>是不是惊呆了，呵呵~</p><br><p>字体文件下载：<a href="http://files.cnblogs.com/hustskyking/barret.rar" target="_blank">barret.ttf</a></p><br><h4>4. 网页测试</h4><br><p>网页测试之前，需要先转化下格式，至于原因在前言部分我已经说了。我们拿到的是 ttf 的字体格式，为了兼容所有的浏览器，必须修改进行格式转换。</p><br><p>进入<a href="http://www.fontsquirrel.com/tools/webfont-generator" target="_blank">http://www.fontsquirrel.com/tools/webfont-generator</a>，选择字体，点击 Agreement，然后点击下载字体：&nbsp;<img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145334695039.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145334695039.jpg" alt="" width="619" height="251"></p><br><p>转换的拿到的是下面四个文件：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/27/270145469692715.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/270145469692715.jpg" alt=""></p><br><p>用下面一段代码测试下结果：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;barretregular&apos;;</span><br><span class="line">    src: url(&apos;./font/barret-webfont.eot&apos;);</span><br><span class="line">    src: url(&apos;./font/barret-webfont.eot?#iefix&apos;) format(&apos;embedded-opentype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.woff&apos;) format(&apos;woff&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.ttf&apos;) format(&apos;truetype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.svg#barretregular&apos;) format(&apos;svg&apos;);</span><br><span class="line">    font-weight: normal;</span><br><span class="line">    font-style: normal;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">div &#123;</span><br><span class="line">    font-family: &quot;barretregular&quot;;</span><br><span class="line">    font-size:50px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    B​C​D​E​F​G​H​I</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>也可以直接戳这个 <a href="http://qianduannotes.duapp.com/demo/testFont/index.html" target="_blank">DEMO</a></p><br><p>字体文件下载：<a href="http://files.cnblogs.com/hustskyking/font.rar" target="_blank">barret.ttf and others</a></p><br><h3>二、@font-face细节</h3><br><p>根据 CSS3 草案中的描述，‘@font-face’ 规则允许使用链接到需要时自动激活的字体。这使得用户可以使用在线的字体，而不仅仅拘泥于使用用户端系统内的字体。font-face，拆开来理解，字体的面孔。不管是什么样的面孔，对应的还是同一个码位，而网页设计者需要使用不同的字体来匹配当前的设计。</p><br><h4>1. local()</h4><br><p>上面的教程中我给出了两个测试，一个是本地测试，一个是网页测试，本地测试之前需要先安装字体，如果本地已经有 barret 这个字体了，那我们的程序便没有必要在重新去网络上下载这个字体了。这是 CSS 程序应该这样写：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;barretregular&apos;;</span><br><span class="line">    src: local(&quot;barret&quot;),</span><br><span class="line">         url(&apos;./font/barret.ttf&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在解析的时候，会先从本地查找是否有 barret 字体，如果没有就忽略 local 语句，如果有的话就直接应用，忽略后面的 url 参数。除了获取本地字体的作用之外，他还有另外一个 hack 用途，看下面这段程序：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;barretregular&apos;;</span><br><span class="line">    src: url(&apos;./font/barret-webfont.eot&apos;);</span><br><span class="line">    src: local(&quot;☺&quot;),</span><br><span class="line">         url(&apos;./font/barret-webfont.eot?#iefix&apos;) format(&apos;embedded-opentype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.woff&apos;) format(&apos;woff&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.ttf&apos;) format(&apos;truetype&apos;),</span><br><span class="line">         url(&apos;./font/barret-webfont.svg#barretregular&apos;) format(&apos;svg&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中包含 local(“☺”)，local 中是一个笑脸，很显然，这绝对不是一个字体名字，那他的作用是什么呢？前面我们说了，低版本IE 只支持 eot 文件格式的字体，上面的代码中用到了两个 src，低版本IE会应用第一个 src 的结果，但是，他的解析不会在第一个 src 位置停止，而是继续往后读，看到后面的 src 会发送一个无效的 http 请求。若在 url 前加一个 local 可以阻断这个 http 请求的发送。</p><br><h4>2. unicode-range</h4><br><p>他的作用是定义字体支持的 Unicode 字符范围，以 “U+” 或者 “u+” 开头，默认是 “U+0-10FFFF”。</p><br><p>unicode-range 有三种形式：</p><br><ol><br><li>点，e.g. U+416</li><br><li>分段，e.g. U+400-U+4ff</li><br><li>通配符，e.g. U+4??(U+400-U+4FF)</li><br></ol><br><p>举几个例子：</p><br><ol><br><li>大小写字符以及标点符号<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unicode-range: U+0021-U+007B;</span><br></pre></td></tr></table></figure><br><br></li><br><li>大小写字符和数字<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unicode-range:</span><br><span class="line">    U+0030-U+0039, / 0-9 *</span><br><span class="line">    U+0041-U+005A, / Uppercase A-Z /</span><br><span class="line">    U+0061-U+007A; / Lowercase a-z /</span><br></pre></td></tr></table></figure><br><br></li><br><li>小写字母，大写字母 T，和 “.” 号<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unicode-range:</span><br><span class="line">    U+0054-U+0054, / T /</span><br><span class="line">    U+0061-U+007A, / a-z /</span><br><span class="line">    U+002E-U+002E; / . (period) */</span><br></pre></td></tr></table></figure><br><br></li><br></ol><br><br><br><p>这玩意儿有啥用途呢？</p><br><blockquote><br><p><code>@font-face</code> 有相关属性 <code>unicode-range</code>，可用类似这样的一段 CSS 来指定以中文字体显示弯引号（这是 CSS3 特性，支持还不广泛，但对于这种非关键样式来说够用了）：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &quot;Chinese Quotes&quot;;</span><br><span class="line">    src: local(&quot;Some Chinese Font&quot;);</span><br><span class="line">    unicode-range: U+2018-2019, U+201C-201D;</span><br><span class="line">&#125;</span><br><span class="line">body &#123;</span><br><span class="line">    font-family: &quot;Chinese Quotes&quot;, &quot;Some Latin Font&quot;,</span><br><span class="line">                 &quot;Some Chinese Font&quot;, generic-family;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></p><p>同理，这一招也可以用于破折号、间隔号等和西文标点共享码位的中文标点。</p><br></blockquote><p></p>
<p></p><p>可以戳知乎上的<a href="http://www.zhihu.com/question/20597706" target="_blank">这一贴</a>。</p><p></p>
<p></p><h3>三、优缺点</h3><p></p>
<p></p><p>优点有一大堆，图标的颜色可以随意修改，大小也是可以随便控制的，不需要折腾图片与文字的对齐问题，因为他本身就是文字，还可以使用阴影、文字渐变等 CSS3 的效果，总之就像操作一般字体一样处理他们，该有的特点都有。</p><p></p>
<p></p><p>缺点也是十分明显的，慢速网络以及翻墙代理下情况特别糟糕。外国很多网站的页面都使用了网络字体，而网络字体下载是需要时间的，有些字体可能还比较大，在下载完毕之前，页面有文字的地方都没有渲染出来，体验不好的情况需要等待三五秒中。不过这种情况还是可以优化的，先用一般字体顶替样式，等下载完毕了再利用 JS 来重新渲染，不过这个代码比较高，而且也不好判断何时下载完成了。</p><p></p>
<p></p><h3>四、小结</h3><p></p>
<p></p><p>本文的目的是展示 web icon 的从无到有的一个过程，一些网站提供了很多不错的 webIcon 字库，如果有需求可以直接去网站上下载，自己制作的话成本太高。</p><p></p>
<p></p><h3>五、参考资料</h3><p></p>
<ul><br><li><a href="http://www.w3.org/TR/css3-fonts/#the-font-face-rule" target="_blank">http://www.w3.org/TR/css3-fonts/#the-font-face-rule</a> W3.ORG</li><br><li><a href="http://www.w3help.org/zh-cn/causes/RF1001" target="_blank">http://www.w3help.org/zh-cn/causes/RF1001</a> W3Help</li><br><li><a href="http://www.php100.com/manual/css3_0/@font-face.shtml" target="_blank">http://www.php100.com/manual/css3_0/@font-face.shtml</a> Font-Face</li><br><li><a href="http://www.fontsquirrel.com/fontface/generator" target="_blank">http://www.fontsquirrel.com/fontface/generator</a> Tool</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/01/18/2014-01-18-cb-how-regular-expressions-work/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/01/18/2014-01-18-cb-how-regular-expressions-work/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">进阶正则表达式</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-01-18 12:32:00" itemprop="dateCreated datePublished" datetime="2014-01-18T12:32:00+08:00">2014-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/01/18/how-regular-expressions-work.html" target="_blank">博客园</a>.</div>

<p>关于正则表达式，网上可以搜到一大片文章，我之前也搜集了一些资料，并做了排版整理，可以看这篇文章<a href="http://www.cnblogs.com/hustskyking/archive/2013/06/04/RegExp.html" target="_blank">http://www.cnblogs.com/hustskyking/archive/2013/06/04/RegExp.html</a>，作为基础入门讲解，这篇文章说的十分到位。</p><br><p>记得最开始学习正则，是使用 php 做一个爬虫程序。为了获取指定的信息，必须用一定的方式把有规律的数据匹配出来，而正则是首选。下面是当时写的爬虫程序的一个代码片段：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$regdata = &quot;/&lt;font size=&quot;\&quot;3\&quot;&quot;&gt;((?&lt;bf&gt;[^&lt;]*)&lt;br \=&quot;&quot;&gt;)&#123;0,1&#125;⊙(?&lt;bs&gt;.&#123;12&#125;)\S*\s/&quot;;</span><br><span class="line"></span><br><span class="line">//获取页面</span><br><span class="line">$html = file_get_contents(&apos;http://www.qnwz.cn/html/daodu/201107/282277.html&apos;);</span><br><span class="line">$html = iconv(&quot;GBK&quot;, &quot;UTF-8&quot;, $html);</span><br><span class="line">if ($html == &apos;&apos;) &#123;</span><br><span class="line">    die(&quot;&lt;hr&gt;出错：【错】无法打开《青年文摘》页面&lt;hr&gt;&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//匹配页面信息</span><br><span class="line">preg_match_all($regdata, $html, $mdata);</span><br><span class="line"></span><br><span class="line">print_r($mdata);</span><br></pre></td></tr></table></figure>
<p>当时写代码还真是欢乐多，什么都不懂，什么都是新知识，学起来津津有味。我觉得学习知识一定要把握最基本的原理，先把一个知识的大概轮廓搞清楚，然后学习怎么去使用他，完了就是深入学习，了解底层基础实现。很多人解决问题都是靠经验，这个当然很重要，但如果我们弄懂了一项技术最底层的实现，完全可以靠自己的推断分析出问题的根源。我对一些公司的招聘要求特别不满，说什么要三年五年Javascript编程经验云云，经验当然和时间成正相关，但是对于那些没有三年五年工作经验却照样能够解决实际的人呢？算是小小的吐槽吧，下面进入正题。</p><br><h3>一、正则表达式的工作机制</h3><br><p>画了一个草图，简单的说明了下正则表达式的工作原理。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    +--------+</span><br><span class="line">    |  编译  |</span><br><span class="line">    +--------+</span><br><span class="line">         |</span><br><span class="line">         ↓</span><br><span class="line">+----------------+</span><br><span class="line">|  设置开始位置    |←---------+</span><br><span class="line">+----------------+          ↑</span><br><span class="line">         |                  |</span><br><span class="line">         ↓               其 |</span><br><span class="line">+----------------+       他 |</span><br><span class="line">|  匹配 &lt; 回溯    |       路 |</span><br><span class="line">+----------------+       径 |</span><br><span class="line">         |                  |</span><br><span class="line">         ↓                  |</span><br><span class="line">+----------------+          |</span><br><span class="line">|  成功 or 失败   |---------→+</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure>
<p>你写的任何一个正则直接量或者 RegExp 都会被浏览器编译为一个原生代码程序，第一次匹配是从头个字符开始，匹配成功时，他会查看是否还有其他的路径没有匹配到，如果有的话，回退到上一次成功匹配的位置，然后重复第二步操作，不过此时开始匹配的位置（lastIndex）是上次成功位置加 1.</p>

<p>如果要深入了解正则表达式的内部原理，必须先理解匹配过程的一个基础环节&mdash;&mdash;回溯，他是驱动正则的一个基本动力，也是性能消耗、计算消耗的根源。</p><br><h3>二、回溯</h3><br><p>正则表达式中出现最多的是分支和量词，上面的 demo 中可以很清楚的看到 hi 和 hello 这两个分支，当匹配到第一个字符 h 之后，进入 (i|ello) 的分支选择，首先是进入 i 分支，当 i 分支匹配完了之后，再回到分支选择的位置，重新选择分支。简单点说，分支就是 <code>|</code> 操作符带来的多项选择问题，而量词指的是诸如 <code>*, +?, {m,n}</code> 之类的符号，正则表达式必须决定何时尝试匹配更多的字符。下面结合回溯详细说说分支和量词。</p><br><h4>1. 分支</h4><br><p>继续分析上面那个案例。<code>“Lalala. Hi, barret. Hello, John”.match(/H(i|ello), barret/g)</code>,首先会查找 H 字符，在第九位找到 H 之后，正则子表达式提供了两个选择 (i|ello)，程序会先拿到最左边的那个分支，进入分支后，在第十位匹配到了 i，接着匹配下一个字符，下一个字符是逗号，接着刚才的位置又匹配到了这个逗号，然后再匹配下一个，依次类推，直到完整匹配到整个正则的内容，此时程序会在<code>Hi, barret</code>后面做一个标记，表示在这里进行了一次成功的匹配。但程序到此并没有结束，因为后面加了一个全局参数，依然使用这个分支往后匹配，很显然，到了 Hello 的时候，Hi 分支匹配不了了，于是程序会回溯到刚才我们做标记的位置，并进入第二个分支，从做标记的位置重新开始匹配，依次循环。</p><br><p>只要正则表达式没有尝试完所有的可选项，他就会回溯到最近的决策点（也就是上次匹配成功的位置）。</p><br><h4>2. 量词</h4><br><p>量词这个概念特别简单，只是在匹配过程中有贪婪匹配和懒惰匹配两种模式，结合回溯的概念理解稍微复杂。还是用几个例子来说明。</p><br><p><strong>1) 贪婪</strong></p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str = &quot;AB1111BA111BA&quot;;</span><br><span class="line">reg = /AB[\s\S]+BA/;</span><br><span class="line">console.log(str.match(reg));</span><br></pre></td></tr></table></figure>
<p>首先是匹配AB，遇到了 <code>[\s\S]+</code>，这是贪婪模式的匹配，他会一口吞掉后面所有的字符，也就是如果 reg 的内容为 AB[\s\S]+，那后面的就不用看了，直接全部匹配，而往后看，正则后面还有B字符，所以他会先回溯到倒数第一个字符，匹配看是否为 B，显然倒数第一个字符不是B，于是他又接着回溯，找到了B字母，找到之后就不继续回溯了，而是往后继续匹配，此刻匹配的是字符A，程序发现紧跟B后的字母确实是A，那此时匹配就结束了。如果没有看明白，可以再读读下面这个图：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  REG: /AB[\s\S]+BA/</span><br><span class="line">MATCH: A               匹配第一个字符</span><br><span class="line">       AB              匹配第二个字符</span><br><span class="line">       AB1111BA111BA   [\s\S]+ 贪婪吞并所有字符</span><br><span class="line">       AB1111BA111BA   回溯，匹配字符B</span><br><span class="line">       AB1111BA111B    找到字符B，继续匹配A</span><br><span class="line">       AB1111BA111BA   找到字符A，匹配完成，停止匹配</span><br></pre></td></tr></table></figure>
<p><strong>2) 懒惰（非贪婪）</strong></p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str = &quot;AB1111BA111BA&quot;;</span><br><span class="line">reg = /AB[\s\S]+?BA/;</span><br><span class="line">console.log(str.match(reg));</span><br></pre></td></tr></table></figure>
<p>与上面不同的是，reg 中多了一个 ? 号，此时的匹配模式为懒惰模式，也叫做非贪婪匹配。此时的匹配流程是，先匹配AB，遇到[\s\S]+?，程序尝试跳过并开始匹配后面的字符B，往后查看的时候，发现是数字1，不是要匹配的内容，继续往后匹配，知道遇到字符B，然后匹配A，发现紧接着B后面就有一个A，于是宣布匹配完成，停止程序。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  REG: /AB[\s\S]+BA/</span><br><span class="line">MATCH: A               匹配第一个字符</span><br><span class="line">       AB              匹配第二个字符</span><br><span class="line">       AB              [\s\S]+? 非贪婪跳过并开始匹配B</span><br><span class="line">       AB1             不是B，回溯，继续匹配</span><br><span class="line">       AB11            不是B，回溯，继续匹配</span><br><span class="line">       AB111           不是B，回溯，继续匹配</span><br><span class="line">       AB1111          不是B，回溯，继续匹配</span><br><span class="line">       AB1111B         找到字符B，继续匹配A</span><br><span class="line">       AB1111BA        找到字符A，匹配完成，停止匹配</span><br></pre></td></tr></table></figure>
<p>如果匹配的内容是 AB1111BA，那贪婪和非贪婪方式的正则是等价的，但是内部的匹配原理还是有区别的。为了高效运用正则，必须搞清楚使用正则时会遇到那些性能消耗问题。</p><br><h3>三、逗比的程序</h3><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//去测试下这句代码</span><br><span class="line">&quot;TTTTTTTT&quot;.match(/(T+T+)+K/);</span><br><span class="line">//然后把前面的T重复次数改成30</span><br><span class="line">//P.S:小心风扇狂转，CPU暴涨</span><br></pre></td></tr></table></figure><br><br><p>我们来分析下上面这段代码，上面使用的都是贪婪模式，那么他会这样做：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  REG: (T+T+)+K</span><br><span class="line">MATCH: ①第一个T+匹配前7个T，第二个T+匹配最后一个T，没找到K，宣布失败，回溯到最开始位置</span><br><span class="line">       ②第一个T+匹配前6个T，第二个T+匹配最后两个T，没找到K，宣布失败，回溯到最开始位置</span><br><span class="line">       ③...</span><br><span class="line">       ... 接着还会考虑(T+T+)+后面的 + 号，接着另一轮的尝试。</span><br><span class="line">       ⑦...</span><br><span class="line">       ...</span><br></pre></td></tr></table></figure>
<p>这段程序并不会智能的去检测字符串中是否存在 K，如果匹配失败，他会选择其他的匹配方式（路径）去匹配，从而造成疯狂的回溯和重新匹配，结果可想而知。这是回溯失控的典型例子。</p><br><h3>四、前瞻和反向引用</h3><br><h4>1. 前瞻和引用</h4><br><p>前瞻有两种，一种是负向前瞻，JS中使用 <code>(?!xxx)</code> 来表示，他的作用是对后面要匹配的内容做一个预判断，如果后面的内容是xxx，则此段内容匹配失败，跳过去重新开始匹配。另一种是正向前瞻，<code>(?=xxx)</code>，匹配方式和上面相反，还有一个长的类似的是 <code>(?:xxx)</code>,这个是匹配xxx，他是非捕获性分组匹配，即匹配的内容不会创建反向引用。具体内容可以去文章开头提到的文档中查看。</p><br><p>反向引用，这个在 replace 中用的比较多，在 replace 中：</p><br><table><br><thead><br><tr><th>字符</th><th>替换文本</th></tr><br></thead><br><tbody><br><tr><br><td>$1、$2、…、$99</td><br><td>与 regexp 中的第 1 到第 99 个子表达式相匹配的文本。</td><br></tr><br><tr><br><td>$&amp;</td><br><td>与 regexp 相匹配的子串。</td><br></tr><br><tr><br><td>$`</td><br><td>位于匹配子串左侧的文本。</td><br></tr><br><tr><br><td>$’</td><br><td>位于匹配子串右侧的文本。</td><br></tr><br><tr><br><td>$$</td><br><td>直接量符号。</td><br></tr><br></tbody><br></table><br><p>而在正则表达中，主要就是 \1, \2 之类的数字引用。前瞻和反向引用使用恰当可以大大的减少正则对资源的消耗。举个例子来简单说明下这几个东西：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">问题：使用正则匹配过滤后缀名为 .css 和 .js 的文件。</span><br><span class="line">      如：test.wow.js test.wow.css test.js.js等等。</span><br></pre></td></tr></table></figure>
<p>有人会立马想到使用负向前瞻，即：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//过滤js文件</span><br><span class="line">/(?!.+\.js$).*/.exec(&quot;test.wow.js&quot;)</span><br><span class="line"></span><br><span class="line">//过滤js和css文件</span><br><span class="line">/(?!.+\.js$|.+\.css$).*/.exec(&quot;test.wow.js&quot;)</span><br><span class="line">/(?!.+\.js$|.+\.css$).*/.exec(&quot;test.wow.html&quot;)</span><br></pre></td></tr></table></figure>
<p>但是你自己去测试下，拿到的结果是什么。匹配非js和非css文件可以拿到正确的文件名，但是我们期望这个表达式对js和css文件的匹配结果是null，上面的表达式却做不到。问题是什么，因为(?!xxx)和(?=xxx)都会消耗字符，在做预判断的时候把 .js 和 .css 给消耗了，所以这里我们必须使用非捕获模式。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/(?:(?!.+\.js$|.+\.css$).)*/.exec(&quot;test.wow.html&quot;);</span><br><span class="line">/(?:(?!.+\.js$|.+\.css$).)*/.exec(&quot;test.wow.js&quot;);</span><br></pre></td></tr></table></figure>
<p>我们来分析下这个正则：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(?:(?!.+\.js$|.+\.css$).)*</span><br><span class="line">---   ----------------  -</span><br><span class="line"> |                |     |</span><br><span class="line"> +----------------------+</span><br><span class="line">             ↓    |</span><br><span class="line">非捕获，内部只有一个占位字符</span><br><span class="line">                  |</span><br><span class="line">                  ↓</span><br><span class="line">    负向前瞻以.js和.css结尾的字符串</span><br></pre></td></tr></table></figure>
<p>最后一个星号是贪婪匹配，直接吞掉全部字符。</p><br><p>这里讲的算是有点复杂了，不过在稍复杂的正则中，这些都是很基础的东西了，想在这方面提高的童鞋可以多研究下。</p><br><h4>2. 原子组</h4><br><p>JavaScript的正则算是比较弱的，他没有分组命名、递归、原子组等功能特别强的匹配模式，不过我们可以利用一些组合方式达到自己的目的。上面的例子中，我们实际上用正则实现了一个或和与的功能，上面的例子体现的还不是特别明显，再写个例子来展示下：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">str1 = &quot;我(wo)叫(jiao)李(li)靖(jing)&quot;;</span><br><span class="line">str2 = &quot;李(li)靖(jing)我(wo)叫(jiao)&quot;;</span><br><span class="line">reg = /(?=.*?我)(?=.*?叫)(?=.*?李)(?=.*?靖)/;</span><br><span class="line">console.log(reg.test(str1)); //true</span><br><span class="line">console.log(reg.test(str2)); //true</span><br></pre></td></tr></table></figure>
<p>不管怎么打乱顺序，只要string中包含\我”，\是”，\李”，\靖”这四个字，结果都是true。</p><br><p>类似(?=xxx)\1，就相当于一个原子组，原子组的作用就是消除回溯，只要是这种模式匹配过的地方，回溯时都不会到这里和他之前的地方。上面的程序<code>“TTTTTTTT”.match(/(T+T+)+K/);</code>可以通过原子组的方式处理：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;TTTTTTTT&quot;.match(/(?=(T+T+))\2+K/);</span><br></pre></td></tr></table></figure>
<p>如此便能彻底消除回溯失控问题。</p><br><h3>五、小结</h3><br><p>关于正则的学习，重点是要多练习多实践，并且多尝试用不同的方案去解决一个正则问题，一个很典型的例子，去除字符串首尾的空白，尝试用5-10种不同的正则去测试，并思考哪些方式的效率最高，为什么？通过这一连串的思考可以带动学习的兴趣，提高学习效率~</p>


<p>相关文章：<a href="http://www.barretlee.com/blog/2013/10/07/cb-javascript-regexp/" target="_blank" rel="noopener">玩转正则之Highlight代码高亮</a></p>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/01/13/2014-01-13-cb-user-exprience-in-login-box/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/01/13/2014-01-13-cb-user-exprience-in-login-box/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">从登录框看前端</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-01-13 03:30:00" itemprop="dateCreated datePublished" datetime="2014-01-13T03:30:00+08:00">2014-01-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/网络交互/" itemprop="url" rel="index"><span itemprop="name">网络交互</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/01/13/user-exprience-in-login-box.html" target="_blank">博客园</a>.</div>

<p>我们会骂 12306 的网站界面挫，效果差，速度慢，回头看看自己写的代码，是不是也一样的狗血！在前端，很多看似简单的东西，内藏无数玄机。本文将以一个小小的登录框为入口，谈一谈如何完善自己的程序。</p><br><p>在很多人眼里，前端就是 DIV+CSS+JQuery，甚至还有些人停留在 table 布局的迷雾当中（这些人应该跟 IE6 一样，随着历史渐渐被尘封）。但，前端绝不是你所看到的那样。举个例子，登录页面几乎是每一个系统不可或缺的模块，很多娴熟的人可以在一刻钟之内写好一个登录页面，两个 input，一个提交 button，万事 OK。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Username: &lt;input type=&quot;text&quot;&gt;&lt;br&gt;</span><br><span class="line">Password: &lt;input type=&quot;password&quot;&gt;&lt;br&gt;</span><br><span class="line">&lt;input type=&quot;sbumit&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>当然，作为一个完成登录验证的页面，这几个元素完全可以胜任，但我只能说你完成了一个可以用的页面，这种页面完全没有用户体验可言，完全不符合一个具有的严谨的思维的程序员的作风！</p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/user-exprience-in-login-box.html" target="_blank">http://www.cnblogs.com/hustskyking/p/user-exprience-in-login-box.html</a></p><br><h3>一、一切以良好用户体验为基础</h3><br><h4>1. 视觉效果</h4><br><p>界面的设计就不用多说了，一般情况这个属于美工的活儿，这里要谈的是几个最基础的点。</p><br><p>第一，你的页面兼容性如何？各个元素的长宽、行高等在不同浏览器上是否表现一致，如果这个都没有保证，那一定是不合格的。</p><br><p>第二，移动终端上的体验问题，如今很多页面 PC 和移动终端都用的一套结构，也就是我们所说的响应式布局，本博客就使用了响应式布局，缩小窗口可以看到效果，响应式布局是为了让不同的移动终端也能得到同样的优质体验，可是很多开发者却忽略了横屏时的效果。下面是常见的几个移动终端的像素比例：</p><br><table><br><thead><br><tr><th>Mobile</th><th>px rate</th></tr><br></thead><br><tbody><br><tr><br><td>Iphone5</td><br><td>320<em>568</em></td><br></tr><br><tr><br><td>Iphone4</td><br><td>320480</td><br></tr><br><tr><br><td>Galaxy S 3/4</td><br><td>360<em>640</em></td><br></tr><br><tr><br><td>Lumia 920</td><br><td>384640</td><br></tr><br><tr><br><td>iPad</td><br><td>768*1024</td><br></tr><br></tbody><br></table><br><p>照顾用户的响应式布局除了要考虑这些屏幕的横屏，还得把竖屏考虑进去。我简单的做了一个登陆页面：</p><br><p><img src="//img.alicdn.com/tfs/TB1oyqGa_tYBeNjy1XdXXXXyVXa-300-300.png" data-original="/blogimgs/2014/01/13/131712295330.jpg" data-source="http://images.cnitblog.com/blog/387325/201401/131712295330.jpg" alt=""></p><br><p>正确的账号是：barret，密码是：123，你可以用错误的信息先去测试下~</p><br><p>可以戳这个DEMO：<a href="http://qianduannotes.duapp.com/demo/login/login.html" target="_blank">http://qianduannotes.duapp.com/demo/login/login.html</a></p><br><h4>2. 交互</h4><br><p>前面那种方式，点击提交按钮，送到后台去验证，验证没有通过则回到登录页面，这也算是一种交互，不过这种交互的体验是特别不好的，每次都得重新刷新页面，应该利用 ajax 异步去验证表单。为了省去用户的聚焦点击，可以按照下面的思路来做：</p><br><ol><br><li>用户名为空，或者格式不对 -》 提示错误，清空密码框，聚焦到用户名框，并全选用户名</li><br><li>用户名不存在 -》同上</li><br><li>密码错误 -》 提示错误，清空密码框，聚焦密码框</li><br><li>聚焦到密码框，全选密码</li><br></ol><br><p>告诉用户哪个地方出了问题，并提前预知用户遇到这些问题之后会做哪些事情，我们能够用程序解决的事情，绝不麻烦用户亲自动手操作。当提示用户名错误的时候，用户肯定会回到输入框重新输入，这个时候我们已经聚焦到用户框，并全选了之前的输入，方面用户进行删除操作。类似这样的交互，我们应该提前做预判断。</p><br><h4>3. 状态提示</h4><br><p>什么是状态提示？有时候因为网络原因，点击提交 button 之后，ajax 传输半天没有响应，用户等了半天页面一点提示都没有，这个肯定会让用户焦急的。回头看看 Gmail，一个把 ajax 发挥到极致的 web应用，在用户体验上做的也是相当给力的，登录邮箱的时候一个 loading 动画，旁边还放了一个加载基本HTML（供慢速网络使用），每一个操作都有提示，提示中还有一个撤销操作的按钮，数据进行加载的时候，如果加载时间过长，期间会进行多次不同的提示，并在最后给出一个确切的结果，对于一个登录框而言，需要做到这些：</p><br><ol><br><li>一个明确的用于状态提示的 box</li><br><li>等待 3s，结果没有出来，提示用户继续等待</li><br><li>等待 6s，结果没有出来，提示用户网络不畅通</li><br><li>设置 10s 为超时，并告知用户提交表单失败</li><br></ol><br><p>这些东西的实现并没有太多的技术难度，但是可以给慢速网络下的用户带来很好的体验和安全感。</p><br><h4>4. 安全传输</h4><br><p>用户最担心的是账号密码被截获，或者因为密码一处多用，不希望别人看到密码的明文，既然用户担心，我们就应该想办法来处理。</p><br><p>把密码和时间戳叠加，然后加密，传到后台的是加密的结果以及这个时间戳，如下：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 前端</span><br><span class="line">t = new Date();</span><br><span class="line">s = encode(pwd + t);</span><br><span class="line">post(s, t)</span><br><span class="line"></span><br><span class="line">// 后台</span><br><span class="line">decode(s) === pwd + t</span><br></pre></td></tr></table></figure>
<p>这样就可以保证密码的隐蔽性，如果 hacker 不知道 decode 函数，即便是拿到了 s 和 t，也是徒劳。关于安全传输，之前也写过相关的文章，<a href="http://www.cnblogs.com/hustskyking/p/authentication-in-web.html" target="_blank">OAuth认证原理及HTTP下的密码安全传输</a>。如果要做到在用户输入的时候就绝对安全，那就必须使用类似 支付宝安全插件 这样的东西了。他的原理就是在页面中嵌入一个控件，这个控件与页面之间是相互屏蔽的，在控件内部输入也只有控件拿得到输入信息。</p><br><h4>5. 数据走缓存</h4><br><p>表单提交首选应该是 post，但是也不排除会用 get 方式提交，那么这个时候就应该考虑数据缓存了，如果请求的 url 相同，程序就会直接从浏览器的缓存中拿数据，并给出状态是 <code>status: 200 OK(from cache)</code>，为了避免这些常识性的问题，记得在请求的参数中加点东西。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_t = new Date*1</span><br><span class="line">_n = Math.random</span><br></pre></td></tr></table></figure>
<p>为了保证参数的绝对唯一性，甚至可以把 时间戳 和随机数叠加起来用</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_s = (new Date*1 + Math.random*1E5)/1E5</span><br></pre></td></tr></table></figure>
<p></p><h4>6. 渐进增强</h4><p></p>
<p>渐进增强这个词一般是，不支持 javascript 或者对 javascript 支持度不太好的浏览器上利用其它方式实现，或者告诉用户什么原因不能用，就是一种蜕化处理。目前不支持 javascript 的浏览器应该是绝迹了，当然也不是绝对，kindle 内置的浏览器对 javascript 的支持度就不高，或者根本就不支持。还有一种情况是用户禁用了 javascript，这个比例很小，开发者会这么干，一般的用户不会乱改浏览器设置。但是我们的程序，尤其是关键的部位（如搜索，登录，注册等）必须要考虑这一少部分群体。一般采用的方式是：</p><br><p>1）使用 noscript 标签，这个是最常用，也是最实用的。</p><br><p>2）hack 方式，document.write(“&lt;” + “!–”)</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.write(&quot;&lt;&quot; +=&quot;&quot; &quot;!--&quot;);=&quot;&quot; code...=&quot;&quot; 如果浏览器不支持=&quot;&quot; javascript，将显示这中间的内容=&quot;&quot; document.write(&quot;--&quot;=&quot;&quot; &quot;=&quot;&quot;&gt;&quot;);</span><br></pre></td></tr></table></figure>
<p>&lt;/“&gt;</p>
<p>这是一种特别巧妙的处理手段，也是值得推荐的。</p><br><h4>7. 浏览器后退按钮</h4><br><p>这个在注册或者登陆的时候是一个普遍的问题，登陆之后，跳转到另外一个页面，我的鼠标有两个侧键，是用于前进和后退的，有时候会误点侧键，这个时候页面又会回到之前的登录页面，但事实是用户已经登录了，所有页面的状态都应该是已登录的，不管什么情况下都不应该让用户在看到这个页面。用户的点击操作会引发上面的问题，而程序 <code>history.go(-1) &lt; history.back()</code> 也会有一样的bug。</p><br><p>这样的问题处理方案比较简单，ajax 拿到 success 的状态码时立刻做跳转，但是这里不能用 <code>window.location.href</code>，这样浏览器还是会记录这个登录历史，应该使用 <code>window.location.replace</code>，替换当前历史记录。</p><br><h4>8. 记住密码</h4><br><p>用户最烦的就是每次登录页面都要输入长长的账号密码，如果没有勾选\记住密码”，则用户的登录状态保存在回话的 session 中，关闭页面或者浏览器的时候，回话结束，session 被删除，这样当用户下次登录的时候又需要重新输入密码。表单页面的\记住密码”复选框默认状态应该是已选择，用户的潜意识行为都是要少操作的。</p><br><p>当用户提交信息成功之后，直接在 cookie 中保存账号密码？这样的做法显然是不合理的，密码怎么能够明文保存呢，有人会想到加密处理密码然后再保存，或者使用服务器来设置 cookie，这些做法都是可以的，不过最好的方式是，当用户成功提交信息时，服务器给前端提供一个 token，这个 token 是用于自动登录的，我们只需要保存 token 就行了，这样就很好的避免了 cookie 中存放用户隐私信息了。</p><br><p>还有一个要注意的是，当用户取消了\记住密码”的复选框时，应该立即清除相关 cookie。</p><br><h3>二、其他相关的几个点</h3><br><h4>1. 用户忘记密码</h4><br><p>如果用户很长时间没有来你的网站，他可能会忘记自己设置的密码，一些奇葩的用户甚至会忘记自己的用户名，但是用户永远是没有错的，出错的只有我们的程序和写程序的人。对于忘记密码的人，可以在填写密码的旁边加上一个链接 \忘记密码？”，让用户利用邮箱或者绑定的手机来找到密码，对于忘记密码以及用户名的人，内伤中… <span>@undefined</span> 13# 14# 正解</p><br><h4>2. 脚本注入</h4><br><p>表单信息应该做正则匹配，或者信息的过滤，防止脚本注入，这个主要是后台要考虑的问题，就不多说了。</p><br><h4>3. 多次提交</h4><br><p>我们发微博的时候经常会遇到的问题，因为网络原因，会多次点击发布按钮，这个问题有多种处理方案：</p><br><ul><br><li>发布之前先从服务器拿 token，该 token 只有一次有效</li><br><li>后端判断一定时间内用户发布的多条信息，相同的信息去重</li><br><li>…</li><br></ul><br><h3>三、容易出错的几个知识点</h3><br><h4>1. setRequestHeader</h4><br><p>利用 ajax 来 post 信息，有的人可能遇到过，后台拿不到数据。原因是没有重写 请求头的 Content-Type，</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(&quot;POST&quot;, url, true);</span><br><span class="line">xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xhr.send($.param(&#123;</span><br><span class="line">    &quot;user&quot;:$(&quot;#user&quot;).val(),</span><br><span class="line">    &quot;pwd&quot;:$(&quot;#pwd&quot;).val()</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>一般浏览器不支持 GET 方式时 xhr.send 中添加参数，但是 POST 是可以，也是必须的，如果没有设置 Content-Type 的头部，数据送到后端便没办法解析成 key-value 的模式，后台(PHP)通过 $_POST 也拿不到数据。</p><br><h4>2. checkbox</h4><br><p>这里也是一个体验问题，一些人把 checkbox 和他相关的文字分开写，结果没有使用 label 来指向，如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;checkbox&quot; checked=&quot;checked&quot;&gt;记住密码</span><br></pre></td></tr></table></figure>
<p>很显然，我们点击后面的文字是不会让 input 改变状态的，有些人会这么处理：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;label&gt;&lt;input type=&quot;checkbox&quot; checked=&quot;checked&quot;&gt;记住密码&lt;/label&gt;</span><br></pre></td></tr></table></figure>
<p>这样处理之后，点击文字当然可以选中 input，但是这种处理方式是不合理的，label 本来就是标记 input 框用的，他的内容应该是文字，不应该包含 input 这个框，所以合理的做法应该是这样：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;checkbox&quot; checked=&quot;checked&quot; id=&quot;rem&quot;&gt;</span><br><span class="line">&lt;label for=&quot;rem&quot;&gt;记住密码&lt;/label&gt;</span><br></pre></td></tr></table></figure>
<p></p><h3>四、小结</h3><p></p>
<p>上面说了一大堆，很多问题都是站在用户的角度去思考的，我们是程序员，但是我们也是用户，我们会吐槽，但是我们也会被吐槽。</p><br><p>把用户体验做到极致，这个十分重要，不要放过任何一个细节！</p>






          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://handishenniu.coding.me/blog/blog/2014/01/05/2014-01-05-cb-javascript-asynchronous-programming/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lion">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="撼地神牛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/2014/01/05/2014-01-05-cb-javascript-asynchronous-programming/" class="post-title-link" itemprop="https://handishenniu.coding.me/blog/page/24/index.html">JavaScript异步编程原理</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-01-05 11:01:00" itemprop="dateCreated datePublished" datetime="2014-01-05T11:01:00+08:00">2014-01-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 18:10:11" itemprop="dateModified" datetime="2018-12-12T18:10:11+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/JavaScript/前端杂烩/" itemprop="url" rel="index"><span itemprop="name">前端杂烩</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="history-article">本文为归档内容,原始地址在 <a href="http://www.cnblogs.com/hustskyking/archive/2014/01/05/javascript-asynchronous-programming.html" target="_blank">博客园</a>.</div>

<p>众所周知，JavaScript 的执行环境是单线程的，所谓的单线程就是一次只能完成一个任务，其任务的调度方式就是排队，这就和火车站洗手间门口的等待一样，前面的那个人没有搞定，你就只能站在后面排队等着。在事件队列中加一个延时，这样的问题便可以得到缓解。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A: 嘿，哥们儿，快点！</span><br><span class="line">B: 我要三分钟，你先等着，完了叫你~</span><br><span class="line">A: 好的，记得叫我啊~ 你（C）也等着吧，完了叫你~</span><br><span class="line">C: 嗯！</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>告诉后面排队的人一个准确的时间，这样后面的人就可以利用这段时间去干点别的事情，而不是所有的人都排在队列后抱怨。我写了一段程序来解决这个问题：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* @author Barret Lee</span><br><span class="line">* @email barret.china@gmail.com</span><br><span class="line">* @description 事件队列管理，含延时</span><br><span class="line">*/</span><br><span class="line">var Q = &#123;</span><br><span class="line">    // 保存队列信息</span><br><span class="line">    a: [],</span><br><span class="line">    // 添加到队列 queue</span><br><span class="line">    q: function(d)&#123;</span><br><span class="line">        // 添加到队列如果不是函数或者数字则不处理</span><br><span class="line">        if(!/function|number/.test(typeof d)) return;</span><br><span class="line"></span><br><span class="line">        Q.a.push(d);</span><br><span class="line">        // 返回对自身的引用</span><br><span class="line">        return Q;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 执行队列 dequeue</span><br><span class="line">    d: function()&#123;</span><br><span class="line">        var s = Q.a.shift();</span><br><span class="line">        // 如果已经到了队列尽头则返回</span><br><span class="line">        if(!s) return;</span><br><span class="line"></span><br><span class="line">        // 如果是函数，直接执行，然后继续 dequeue</span><br><span class="line">        if(typeof s === &quot;function&quot;) &#123;</span><br><span class="line">            s(), Q.d();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 如果是数字，该数字作为延迟时间，延迟 dequeue</span><br><span class="line">        setTimeout(function()&#123;</span><br><span class="line">            Q.d();</span><br><span class="line">        &#125;, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这段程序加了很多注释，相信有 JS 基础的童鞋都能够看懂，利用上面这段代码测试下：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 进程记录函数</span><br><span class="line">function record(s)&#123;</span><br><span class="line">    var div = document.createElement(&quot;div&quot;);</span><br><span class="line">    div.innerHTML = s;</span><br><span class="line">    console.log(s);</span><br><span class="line">    document.body.appendChild(div);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Q</span><br><span class="line">.q(function()&#123;</span><br><span class="line">    record(&quot;0 &lt;i&gt;3s 之后搞定，0 把 1 叫进来&lt;/i&gt;&quot;);</span><br><span class="line">&#125;)</span><br><span class="line">.q(3000)  // 延时 3s</span><br><span class="line">.q(function()&#123;</span><br><span class="line">    record(&quot;1 &lt;i&gt;2s 之后搞定，1 把 2 叫进来&lt;/i&gt;&quot;);</span><br><span class="line">&#125;)</span><br><span class="line">.q(2000)  // 延时 2s</span><br><span class="line">.q(function()&#123;</span><br><span class="line">    record(&quot;2 &lt;span&gt;后面没人了，OK，厕所关门~&lt;/span&gt;&quot;);</span><br><span class="line">&#125;)</span><br><span class="line">.d();     // 执行队列</span><br></pre></td></tr></table></figure>
<p>可以戳戳这个 <a href="http://qianduannotes.duapp.com/demo/ansyc/" target="_blank">DEMO</a>。也可以直接运行这段程序：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line">* @author Barret Lee</span><br><span class="line">* @email barret.china@gmail.com</span><br><span class="line">* @description 事件队列管理，含延时</span><br><span class="line">*/</span><br><span class="line">var Q = &#123;</span><br><span class="line">    // 保存队列信息</span><br><span class="line">    a: [],</span><br><span class="line">    // 添加到队列 queue</span><br><span class="line">    q: function(d)&#123;</span><br><span class="line">        // 添加到队列如果不是函数或者数字则不处理</span><br><span class="line">        if(!/function|number/.test(typeof d)) return;</span><br><span class="line"></span><br><span class="line">        Q.a.push(d);</span><br><span class="line">        // 返回对自身的引用</span><br><span class="line">        return Q;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 执行队列 dequeue</span><br><span class="line">    d: function()&#123;</span><br><span class="line">        var s = Q.a.shift();</span><br><span class="line">        // 如果已经到了队列尽头则返回</span><br><span class="line">        if(!s) return;</span><br><span class="line"></span><br><span class="line">        // 如果是函数，直接执行，然后继续 dequeue</span><br><span class="line">        if(typeof s === &quot;function&quot;) &#123;</span><br><span class="line">            s(), Q.d();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 如果是数字，该数字作为延迟时间，延迟 dequeue</span><br><span class="line">        setTimeout(function()&#123;</span><br><span class="line">             Q.d();</span><br><span class="line">        &#125;, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function record(s)&#123;</span><br><span class="line">    var div = document.createElement(&quot;div&quot;);</span><br><span class="line">    div.innerHTML = s;</span><br><span class="line">    console.log(s);</span><br><span class="line">    document.body.appendChild(div);</span><br><span class="line">&#125;</span><br><span class="line">Q</span><br><span class="line">.q(function()&#123;</span><br><span class="line">    record(&quot;0 &lt;i&gt;3s 之后搞定，0 把 1 叫进来&lt;/i&gt;&quot;);</span><br><span class="line">&#125;)</span><br><span class="line">.q(3000)</span><br><span class="line">.q(function()&#123;</span><br><span class="line">    record(&quot;1 &lt;i&gt;2s 之后搞定，1 把 2 叫进来&lt;/i&gt;&quot;);</span><br><span class="line">&#125;)</span><br><span class="line">.q(2000)</span><br><span class="line">.q(function()&#123;</span><br><span class="line">    record(&quot;2 &lt;span&gt;后面没人了，OK，厕所关门~&lt;/span&gt;&quot;);</span><br><span class="line">&#125;)</span><br><span class="line">.d();</span><br><span class="line"></span><br><span class="line">//事件队列管理，含延时</span><br></pre></td></tr></table></figure>
<p><span>&nbsp;</span></p><br><p>本文地址：<a href="http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html" target="_blank">http://www.cnblogs.com/hustskyking/p/javascript-asynchronous-programming.html</a>，转载请注明出处。</p><br><h3>一、Javascript 异步编程原理</h3><br><p>显然，上面这种方式和银行取号等待有些类似，只不过银行取号我们并不知道上一个人需要多久才会完成。这是一种非阻塞的方式处理问题。下面来探讨下 JavaScript 中的异步编程原理。</p><br><h4>1. setTimeout 函数的弊端</h4><br><p>延时处理当然少不了 setTimeout 这个神器，很多人对 setTimeout 函数的理解就是：延时为 n 的话，函数会在 n 毫秒之后执行。事实上并非如此，这里存在三个问题，一个是 setTimeout 函数的及时性问题，可以测试下面这串代码：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var d = new Date, count = 0, f, timer;</span><br><span class="line">timer = setInterval(f = function ()&#123;</span><br><span class="line">    if(new Date - d &gt; 1000)</span><br><span class="line">        clearInterval(timer), console.log(count);</span><br><span class="line">    count++;</span><br><span class="line">&#125;, 0);</span><br></pre></td></tr></table></figure>
<p>可以看出 1s 中运行的次数大概在 200次 左右，有人会说那是因为 new Date 和 函数作用域的转换消耗了时间，其实不然，你可以再试试这段代码：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var d = new Date, count = 0;</span><br><span class="line">while(true) &#123;</span><br><span class="line">    if(new Date - d &gt; 1000) &#123;</span><br><span class="line">        console.log(count);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我这里显示的是 351813，也就是说 count 累加了 35W+ 次，这说明了什么呢？setInterval 和 setTimeout 函数运转的最短周期是 5ms 左右，这个数值在 <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#dom-windowtimers-settimeout" target="_blank" rel="noopener">HTML规范</a> 中也是有提到的:</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">5. Let timeout be the second method argument, or zero if the argument was omitted.</span><br><span class="line">如果 timeout 参数没有写，默认为 0</span><br><span class="line">7. If nesting level is greater than 5, and timeout is less than 4, then increase timeout to 4.</span><br><span class="line">如果嵌套的层次大于 5 ，并且 timeout 设置的数值小于 4 则直接取 4.</span><br></pre></td></tr></table></figure>
<p>为了让函数可以更快速的相应，部分浏览器提供了更加高级的接口（当 timeout 为 0 的时候，可以使用下面的方式替代，速度更快）：</p><br><ul><br><li>requestAnimationFrame 它允许 JavaScript 以 60+帧/s 的速度处理动画，<span>他的运行时间间隔比 setTimeout 是要短很多的。</span> <span>@司徒正美</span>，他适合动画，使用他可以在 tab 失去焦点或者最小化的时候减缓运动，从而节省 CPU 资源，他的运行间隔确实比 setTimeout 要长。<span></span></li><br><li>process.nextTick 这个是 NodeJS 中的一个函数，利用他可以几乎达到上面看到的 while 循环的效率</li><br><li>ajax 或者 插入节点 的 readyState 变化</li><br><li>MutationObserver 大约 2-3ms</li><br><li>setImmediate &nbsp;</li><br><li>postMessage 这个相当快</li><br><li>…</li><br><br></ul><br><p>这些东西下次有空再细谈。之前研究<a href="http://www.cnblogs.com/rubylouvre" target="_blank">司徒正美</a>的 avalon 源码的时候，看到了相关的内容，有兴趣的可以看看：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">//视浏览器情况采用最快的异步回调</span><br><span class="line">var BrowserMutationObserver = window.MutationObserver || window.WebKitMutationObserver</span><br><span class="line">if (BrowserMutationObserver) &#123; //chrome18+, safari6+, firefox14+,ie11+,opera15</span><br><span class="line">    avalon.nextTick = function(callback) &#123; //2-3ms</span><br><span class="line">        var input = DOC.createElement(&quot;input&quot;)</span><br><span class="line">        var observer = new BrowserMutationObserver(function(mutations) &#123;</span><br><span class="line">            mutations.forEach(function() &#123;</span><br><span class="line">                callback()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        observer.observe(input, &#123;</span><br><span class="line">            attributes: true</span><br><span class="line">        &#125;)</span><br><span class="line">        input.setAttribute(&quot;value&quot;, Math.random())</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else if (window.VBArray) &#123;</span><br><span class="line">//IE下这个通常只要1ms,而且没有副作用，不会发现请求，</span><br><span class="line">//setImmediate如果只执行一次，与setTimeout一样要140ms上下</span><br><span class="line">    avalon.nextTick = function(callback) &#123;</span><br><span class="line">        var node = DOC.createElement(&quot;script&quot;)</span><br><span class="line">        node.onreadystatechange = function() &#123;</span><br><span class="line">            callback() //在interactive阶段就触发</span><br><span class="line">            node.onreadystatechange = null</span><br><span class="line">            root.removeChild(node)</span><br><span class="line">            node = null</span><br><span class="line">        &#125;</span><br><span class="line">        root.appendChild(node)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    avalon.nextTick = function(callback) &#123;</span><br><span class="line">        setTimeout(callback, 0)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面说了一堆，目的是想说明， setTimeout 是存在一定时间间隔的，并不是设定 n 毫秒执行，他就是 n 毫秒执行，可能会有一点时间的延迟（2ms左右）。然后说说他的第二个缺点，先看代码：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var d = new Date;</span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    console.log(&quot;show me after 1s, but you konw:&quot; + (new Date - d));</span><br><span class="line">&#125;, 1000);</span><br><span class="line">while(1) if(new Date - d &gt; 2000) break;</span><br></pre></td></tr></table></figure>
<p>我们期望 console 在 1s 之后出结果，可事实上他却是在 2075ms 之后运行的，这就是 JavaScript 单线程给我们带来的烦恼，while循环阻塞了 setTimeout 函数的执行。接着是他的第三个毛病，try..catch捕捉不到他的错误：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try&#123;</span><br><span class="line">    setTimeout(function()&#123;</span><br><span class="line">        throw new Error(&quot;我不希望这个错误出现！&quot;)</span><br><span class="line">    &#125;, 1000);</span><br><span class="line">&#125; catch(e)&#123;</span><br><span class="line">    console.log(e.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以说 setTimeout 是异步编程不可缺少的角色，但是它本身就存在这么多的问题，这就要求我们用更加恰当的方式去规避！</p><br><h4>2. 什么样的函数为异步的</h4><br><p>异步的概念和非阻塞是是息息相关的，我们通过 ajax 请求数据的时候，一般采用的是异步的方式：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open(&apos;GET&apos;, &apos;/&apos;, true);</span><br><span class="line">xhr.send();</span><br><span class="line">xhr.onreadystatechange = function()&#123;</span><br><span class="line">    console.log(xhr.status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 xhr.open 中我们把第三个参数设置为 true ，也就是异步加载，当 state 发生改变的时候，xhr 立即响应，触发相关的函数。有人想过用这样的方式来处理：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while(1) &#123;</span><br><span class="line">    if(xhr.status === &quot;complete&quot;) &#123;</span><br><span class="line">        // dosomething();</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而事实上，这里的判断已经陷入了死循环，即便是 xhr 的 status 已经发生了改变，这个死循环也跳不出来，那么这里的异步是基于事件的。</p><br><blockquote><br><p>某个函数会导致将来再运行的另一个函数，后者取自于事件队列（若后面这个函数是作为参数传递给前者的，则称其为回调函数，简称为回调）。<cite>&mdash;&mdash; 摘自《Async Javascript》</cite></p><br></blockquote><br><p>由于 JavaScript 的单线程特点，他没有提供一种机制以阻止函数在其异步操作结束之前返回，事实上，除非函数返回，否则不会触发任何异步事件。</p><br><h4>3. 常见的异步模型</h4><br><p>1） 最常见的一种方式是，高阶函数（泛函数）</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">step1(function(res1)&#123;</span><br><span class="line">    step2(function(res2)&#123;</span><br><span class="line">        step3(function(res3)&#123;</span><br><span class="line">            //...</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>解耦程度特别低，如果送入的参数太多会显得很乱！这是最常见的一种方式，把函数作为参数送入，然后回调。</p><br><p>2） 事件监听</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">E.on(&quot;evt&quot;, g);</span><br><span class="line">function f()&#123;</span><br><span class="line">    setTimeout(function()&#123;</span><br><span class="line">        E.trigger(&quot;evt&quot;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JS 和 浏览器提供的原生方法基本都是基于事件触发机制的，耦合度很低，不过事件不能得到流程控制。</p><br><p>3） 发布/订阅( Pub/Sub )</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">E.subscribe(&quot;evt&quot;, g);</span><br><span class="line">function f()&#123;</span><br><span class="line">    setTimeout(function () &#123;</span><br><span class="line">　　    // f的任务代码</span><br><span class="line">　　    E.publish(&quot;evt&quot;);</span><br><span class="line">    &#125;, 1000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把事件全部交给 E 这个控制器管理，可以完全掌握事件被订阅的次数，以及订阅者的信息，管理起来特别方便。</p><br><p>4） Promise 对象（deferred 对象）</p><br><p>关于这里的内容可以看看 <a href="//www.imququ.com/post/promises-when-js.html" target="_blank">屈屈</a> 写的文章，说的比较详细。</p><br><p><a href="http://promisesaplus.com/" target="_blank">Promise/A+</a> 规范是对 <a href="http://wiki.commonjs.org/wiki/Promises/A" target="_blank">Promise/A</a> 规范的补充和修改，他出现的目的是为了统一异步编程中的接口，JS中的异步编程是十分普遍的事情，也出现了很多的异步库，如果不统一接口，对开发者来说也是一件十分痛苦的事情。</p><br><p>在Promises/A规范中，每个任务都有三种状态：默认(pending)、完成(fulfilled)、失败(rejected)。</p><br><ul><br><li>默认状态可以单向转移到完成状态，这个过程叫resolve，对应的方法是deferred.resolve(promiseOrValue)；</li><br><li>默认状态还可以单向转移到失败状态，这个过程叫reject，对应的方法是deferred.reject(reason)；</li><br><li>默认状态时，还可以通过deferred.notify(update)来宣告任务执行信息，如执行进度；</li><br><li>状态的转移是一次性的，一旦任务由初始的pending转为其他状态，就会进入到下一个任务的执行过程中。</li><br></ul><br><h3>二、异步函数中的错误处理</h3><br><p>前面已经提到了 setTimeout 函数的一些问题，JS 中的 try..catch 机制并不能拿到 setTimeout 函数中出现的错误，一个 throw error 的影响范围有多大呢？我做了一个测试：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    throw new Error(&quot;error&quot;);</span><br><span class="line">    console.log(&quot;show me&quot;); // 并没有打印出来</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    console.log(&quot;show me&quot;); // 打印出来了</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>从上面的测试我们可以看出，<code>throw new Error</code> 的作用范围就是阻断一个 script 标签内的程序运行，但是不会影响下面的 script。这个测试没什么作用，只是想告诉大家不要担心一个 Error 会影响全局的函数执行。所以把代码分为两段，一段可能出错的，一段确保不会出错的，这样不至于让全局代码都死掉，当然这样的处理方式是不可取的。</p><br><p>庆幸的是 window 全局对象上有一个便利的函数，<code>window.error</code>，我们可以利用他捕捉到所有的错误，并作出相应的处理，比如：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">window.onerror = function(msg, url, line)&#123;</span><br><span class="line">    console.log(msg, url, line);</span><br><span class="line">    // 必须返回 true，否则 Error 还是会触发阻塞程序</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    throw new Error(&quot;error&quot;);</span><br><span class="line">    // console：</span><br><span class="line">    //Uncaught Error: error path/to/ie6bug.html 99  </span><br><span class="line">&#125;, 50);</span><br></pre></td></tr></table></figure>
<p>我们可以对错误进行封装处理：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">window.onerror = function(msg, url, line)&#123;</span><br><span class="line">    // 截断 &quot;Uncaught Error: error&quot;，获取错误类型</span><br><span class="line">    var type = msg.slice(16);</span><br><span class="line">    switch(type)&#123;</span><br><span class="line">        case &quot;TooLarge&quot;:</span><br><span class="line">            console.log(&quot;The number is too large&quot;);</span><br><span class="line">        case &quot;TooSmall&quot;:</span><br><span class="line">            console.log(&quot;The number is too Small&quot;);</span><br><span class="line">        case &quot;TooUgly&quot;:</span><br><span class="line">            console.log(&quot;That&apos;s Barret Lee~&quot;);</span><br><span class="line">        // 如果不是我们预定义的错误类型，则反馈给后台监控</span><br><span class="line">        default:</span><br><span class="line">            $ &amp;&amp; $.post &amp;&amp; $.post(&#123;</span><br><span class="line">                &quot;msg&quot;: msg,</span><br><span class="line">                &quot;url&quot;: url,</span><br><span class="line">                &quot;line&quot;: line</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    // 记得这里要返回 true，否则错误阻断程序。</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    if( something )  throw new Error(&quot;TooUgly&quot;);</span><br><span class="line">    // console：</span><br><span class="line">    //That&apos;s Barret Lee~ </span><br><span class="line">&#125;, 50);</span><br></pre></td></tr></table></figure>
<p>很显然，报错已经不可怕了，利用 window 提供的 onerror 函数可以很方便地处理错误并作出及时的反应，如果出现了不可知的错误，可以把信息 post 到后台，这也算是一个十分不错的监控方式。</p><br><p>不过这样的处理存在一个问题，所有的错误我们都给屏蔽了，但有些错误本应该阻断所有程序的运行的。比如我们通过 ajax 获取数据中出了错误，程序误以为已经拿到了数据，本应该停下工作报出这个致命的错误，但是这个错误被 window.onerror 给截获了，从而进行了错误的处理。</p><br><p>window.onerror 算是一种特别暴力的容错手段，try..catch 也是如此，他们底层的实现就是利用 C/C++ 中的 goto 语句实现，一旦发现错误，不管目前的堆栈有多深，不管代码运行到了何处，直接跑到 顶层 或者 try..catch 捕获的那一层，这种一脚踢开错误的处理方式并不是很好，我觉得。</p><br><h3>三、JavaScript 多线程技术介绍</h3><br><p>开始说了异步编程和非阻塞这个概念密切相关，而 JavaScript 中的 Worker 对象可以创建一个独立线程来处理数据，很自然的处理了阻塞问题。我们可以把繁重的计算任务交给 Worker 去倒腾，等他处理完了再把数据 Post 过来。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var worker = new Worker(&quot;./outer.js&quot;);</span><br><span class="line">worker.addEventListener(&quot;message&quot;, function(e)&#123;</span><br><span class="line">    console.log(e.message);</span><br><span class="line">&#125;);</span><br><span class="line">worker.postMessage(&quot;data one&quot;);</span><br><span class="line">worker.postMessage(&quot;data two&quot;);</span><br><span class="line"></span><br><span class="line">// outer.js</span><br><span class="line">self.addEventListener(&quot;message&quot;, function(e)&#123;</span><br><span class="line">    self.postMessage(e.message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面是一个简单的例子，如果我们创建了多个 Worker，在监听 onmessage 事件的时候还要判断下 e.target 的值从而得知数据源，当然，我们也可以把数据源封装在 e.message 中。</p><br><p>Worker 是一个有用的工具，我可以可以在 Worker 中使用 setTimeout，setInterval等函数，也可以拿到 navigator 的相关信息，最重要的是他可以创建 ajax 对象和 WebSocket 对象，也就是说他可以直接向服务器请求数据。不过他不能访问 DOM 的信息，更不能直接处理 DOM，这个其实很好理解，主线程和 Worker 是两个独立的线程，如果两者都可以修改 DOM，那岂不是得设置一个麻烦的互斥变量？！还有一个值得注意的点是，在 Worker 中我们可以使用 importScript 函数直接加载脚本，不过这个函数是同步的，也就是说他会冻结 Worker 线程，直到 Script 加载完毕。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">importScript(&quot;a.js&quot;, &quot;b.js&quot;, &quot;c.js&quot;);</span><br></pre></td></tr></table></figure>
<p>他可以添加多个参数，加载的顺序就是 参数的顺序。一般会使用 Worker 做哪些事情呢？</p><br><ul><br><li>数据的计算和加密 如计算斐波拉契函数的值，特别费时；再比如文件的 MD5 值比对，一个大文件的 MD5 值计算也是很费时的。</li><br><li>音、视频流的编解码工作，这些工作搞微信的技术人员应该没有少做。有兴趣的童鞋可以看看这个<a href="http://v.youku.com/v_show/id_XNjQ5NzgxODAw.html" target="_blank">技术分享</a>，是杭州的 hehe123 搞的一个WebRTC 分享，内容还不错。</li><br><li>等等，你觉得费时间的事情都可以交给他做</li><br></ul><br><p>然后要说的是 SharedWorker，这是 web 通信领域未来的一个趋势，有些人觉得 WebSocket 已经十分不错了，但是一些基于 WebSocket 的架构，服务器要为每一个页面维护一个 WebSocket 代码，而 SharedWorker 十分给力，他是多页面通用的。</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;input id=&quot;inp&quot;&gt;&lt;input type=&quot;button&quot; id=&quot;btn&quot; value=&quot;发送&quot;&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var sw = new SharedWorder(&quot;./outer.js&quot;);</span><br><span class="line">    // 绑定事件</span><br><span class="line">    sw.port.onmessage = function(e)&#123;</span><br><span class="line">        console.log(e.data);</span><br><span class="line">    &#125;;</span><br><span class="line">    btn.onclick = function()&#123;</span><br><span class="line">        sw.port.postMessage(inp.value);</span><br><span class="line">        inp.value = &quot;&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    // 创建连接，开始监听</span><br><span class="line">    sw.port.start();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">// outer.js</span><br><span class="line">var pool = [];</span><br><span class="line">onconnect = function(e) &#123;</span><br><span class="line">    // 把连接的页面放入连接池</span><br><span class="line">    pool.push(e.ports[0]);</span><br><span class="line">    // 收到信息立即广播</span><br><span class="line">    e.ports[0].onmessage = function(e)&#123;</span><br><span class="line">        for(var i = 0;i &lt; pool.length; i++)</span><br><span class="line">            // 广播信息</span><br><span class="line">            pool[i].postMessage(e.data);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>简单理解 SharedWorker，就是把运行的一个线程作为 web后台程序，完全不需要后台脚本参与，这个对 web通讯，尤其是游戏开发者，觉得是一个福音！</p><br><h3>四、ECMAScript 6 中 Generator 对象搞定异步</h3><br><p>异步两种常见方式是 事件监听 以及 函数回调。前者没什么好说的，事件机制是 JS 的核心，而函数回调这块，过于深入的嵌套简直就是一个地狱，可以看看<a href="http://callbackhell.com/" target="_blank">这篇文章</a>，这是一篇介绍异步编程的文章，什么叫做\回调地狱”，可以看看下面的例子：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">fs.readdir(source, function(err, files) &#123;</span><br><span class="line">  if (err) &#123;</span><br><span class="line">    console.log(&apos;Error finding files: &apos; + err)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    files.forEach(function(filename, fileIndex) &#123;</span><br><span class="line">      console.log(filename)</span><br><span class="line">      gm(source + filename).size(function(err, values) &#123;</span><br><span class="line">        if (err) &#123;</span><br><span class="line">          console.log(&apos;Error identifying file size: &apos; + err)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          console.log(filename + &apos; : &apos; + values)</span><br><span class="line">          aspect = (values.width / values.height)</span><br><span class="line">          widths.forEach(function(width, widthIndex) &#123;</span><br><span class="line">            height = Math.round(width / aspect)</span><br><span class="line">            console.log(&apos;resizing &apos; + filename + &apos;to &apos; + height + &apos;x&apos; + height)</span><br><span class="line">            this.resize(width, height).write(destination + &apos;w&apos; + width + &apos;_&apos; + filename, function(err) &#123;</span><br><span class="line">              if (err) console.log(&apos;Error writing file: &apos; + err)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;.bind(this))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p></p><p>是不是有种想吐的感觉，一层一层的嵌套，虽说这种嵌套十分正常，倘若每段代码都是这样的呈现，相信二次开发者一定会累死！关于如何解耦我就不细说了，可以回头看看上面那篇回调地狱的文章。</p><p></p>
<p></p><p>ECMAScript 6中有一个 Generator 对象，过段时间会对 ES6 中的新知识进行一一的探讨，这里不多说了，有兴趣的同学可以看看 H-Jin 写的一篇文章<a href="http://huangj.in/765" target="_blank">使用 (Generator) 生成器解决 JavaScript 回调嵌套问题</a>，使用 yield 关键词和 Generator 把嵌套给\拉直”了，这种方式就像是 chrome 的 DevTool 中使用断点一般，用起来特别舒服。</p><p></p>
<p></p><h3>五、小结</h3><p></p>
<p></p><p>本文提到了异步编程的相关概念和使用中会遇到的问题，在写文章之前做了三天的调研，不过还是有很多点没说全，下次对异步编程有了更深入的理解再来谈一谈。</p><p></p>
<p></p><h3>六、参考资料</h3><p></p>
<ul><br><li><a href="http://www.ruanyifeng.com/blog/2012/12/asynchronous%EF%BC%BFjavascript.html" target="_blank">Javascript异步编程的4种方法</a> 阮一峰</li><br><li><a href="http://www.cnblogs.com/rubylouvre/archive/2011/03/14/1982699.html" target="_blank">javascript 异步编程</a> 司徒正美</li><br><li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html" target="_blank">HTML Specification</a> web develop group</li><br><li><a href="http://promisesaplus.com/" target="_blank">Promise/A+ 规范</a></li><br><li><a href="//www.imququ.com/post/promises-when-js.html" target="_blank">异步编程：When.js快速上手</a> JerrryQu</li><br><li><a href="http://book.douban.com/subject/10745151/" target="_blank">《Async Javascript》</a> By Trevor Burnham</li><br><li><a href="http://www.web-tinker.com/article/20444.html" target="_blank">非常有意义，却尚未兼容的SharedWorker</a> 次碳酸钴</li><br><li><a href="http://www.cnblogs.com/_franky/archive/2010/11/23/1885773.html" target="_blank">HTML5 Web Worker</a> Franky</li><br></ul>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/23/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/blog/page/25/">25</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/32/">32</a><a class="extend next" rel="next" href="/blog/page/25/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Lion</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/blog/archives/">
                
                    <span class="site-state-item-count">311</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/blog/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">94</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/blog/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">241</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lion</span>

  

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script src="/blog/js/src/utils.js?v=6.6.0"></script>

  <script src="/blog/js/src/motion.js?v=6.6.0"></script>



  
  

  

  


  <script src="/blog/js/src/bootstrap.js?v=6.6.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

  <script src="/blog/js/src/music/aplayer.js?v=6.6.0"></script>
  <script src="/blog/js/src/music/init.js?v=6.6.0"></script>
</body>
</html>
